define("vendor/namespace",["require"],function(a){function b(a,b){var c,d=b.split("."),e=a;c=d.length;for(var f=0;f<c;f++)void 0===e[d[f]]&&(e[d[f]]={}),e=e[d[f]];return e}function c(a,c){var d=b(window,a);return void 0!==c&&c.call(d,d,global),d}return c}),define("engine/config",["require","namespace"],function(a){var b=a("namespace"),c=b("Isometrica.Engine");return c.Config={noLayerDepthSortingMask:0,noLayerClearMask:0,layersCount:1,useOctree:!1,renderOctree:!1},c.Config}),function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define("vendor/events",[],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.Events=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){function d(a,b){var c=b.token,d=a._subs,e=a._subsArr,f=e.indexOf(b);return-1!==f&&(e[f]=void 0,delete d[c],!0)}function e(a,b){var c,d,e=a._subs,f=a._subsArr,g=f.length;for(d=0;d<g;d++)if(void 0!==(c=f[d])&&c.handler===b)return f[d]=void 0,delete e[c.token],!0;return!1}function f(a,b){return"function"==typeof b?e(a,b):d(a,b)}function g(a,b,c,d){if("function"!=typeof b)throw"Event handler should be a function";var e=a._lastToken++,f=new k(e,b,c,d);return a._subsArr.push(f),a._subs[e]=f,f}function h(a,b,c){return g(a,b,c,!0)}function i(a,b,c){var e,f,g=a._subsArr,h=g.length,i=!1;for(e=0;e<h;e++)f=g[e],void 0!==f?(f.once&&d(a,f),(0,f.handler)(b,c,f.data)):i=!0;if(!0===i)for(e=h-1;-1!==e;e--)void 0===g[e]&&g.splice(e,1)}function j(){this._subsArr=[],this._subs=Object.create(null),this._lastToken=0}var k=a("./subscription");j.on=g,j.off=f,j.once=h,j.fire=i,j.prototype._subs=null,j.prototype._subsArr=null,j.prototype.on=function(a,b){return g(this,a,b)},j.prototype.once=function(a,b){return h(this,a,b)},j.prototype.off=function(a){return f(this,a)},j.prototype.fire=function(a,b){return i(this,a,b)},b.exports=j},{"./subscription":3}],2:[function(a,b,c){function d(a,b){var c,d=a._events;return void 0===d&&(d=a._events=Object.create(null)),c=d[b],void 0===c&&(c=d[b]=new l),c}function e(a,b,c,e){return(0,l.on)(d(a,b),c,e)}function f(a,b,c,e){return(0,l.once)(d(a,b),c,e)}function g(a,b,c){var d,e=l.off;return void 0!==a._events&&void 0!==a._events[b]&&(d=a._events[b],e(d,c))}function h(a,b,c,d){var e,f;return void 0===d?(e=a,f=c):(e=c,f=d),i(a,b,e,f)}function i(a,b,c,d){if(void 0!==a._events&&void 0!==a._events[b]){(0,l.fire)(a._events[b],c,d)}}function j(a){function b(b,c){return void 0===b&&void 0===c?d(this,a):b instanceof m?g(this,a,b):"function"==typeof b?e(this,a,b,c):i(this,a,b,c)}return b}function k(){this.on=e,this.once=f,this.off=g,this.fire=h,this.event=j,this.Event=l}var l=a("./event"),m=a("./subscription");b.exports=new k},{"./event":1,"./subscription":3}],3:[function(a,b,c){function d(a,b,c,d){this.handler=b,this.data=c,this.once=d||!1,this.token=a}d.prototype.token=-1,d.prototype.handler=null,d.prototype.data=null,d.prototype.once=null,b.exports=d},{}]},{},[2])(2)}),define("js/events-wrapper",["require","vendor/events"],function(a){function b(){}var c=a("vendor/events");return b.event=c.event,b.EventEmmiter=b,b.addListener=b.on=c.on,b.once=b.once=c.once,b.removeListener=b.off=c.off,b.emit=b.fire=c.fire,b.subscribe=c.on,b.unsubscribe=c.off,b.prototype.addEventListener=b.prototype.addListener=function(a,b,d){return c.on(this,a,b,d)},b.prototype.removeEventListener=b.prototype.removeListener=function(a,b){return c.off(this,a,b)},b.prototype.dispatchEvent=b.prototype.emit=function(a,b){return c.fire(this,a,b)},b.prototype.once=function(a,b,d){return c.on(this,a,b,d,!0)},window.Events=b}),define("engine/viewport",["require","events","./config"],function(a){function b(a,b){this.camera=null,this.canvas=b||document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.context.imageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.graphics=a,this.width=0,this.height=0,this.viewportMatrix=new Float32Array(16),this.layers=[];for(var e=0;e<d.layersCount;e++){var f=document.createElement("canvas");this.layers[e]=f.getContext("2d"),this.layers[e].imageSmoothingEnabled=!1}var g=this;window.addEventListener("resize",function(){g.setSize(g.canvas.offsetWidth,g.canvas.offsetHeight)}),this.canvas.addEventListener("mousedown",function(a){var b=a.target.getBoundingClientRect();a.gameViewportX=a.pageX-b.left,a.gameViewportY=a.pageY-b.top,c.fire(g,g.events.pointerdown,a),a.preventDefault()}),this.canvas.addEventListener("mouseup",function(a){var b=a.target.getBoundingClientRect();a.gameViewportX=a.pageX-b.left,a.gameViewportY=a.pageY-b.top,c.fire(g,g.events.pointerup,a),a.preventDefault()}),this.canvas.addEventListener("mousemove",function(a){var b=a.target.getBoundingClientRect();a.gameViewportX=a.pageX-b.left,a.gameViewportY=a.pageY-b.top,c.fire(g,g.events.pointermove,a),a.preventDefault()}),this.canvas.addEventListener("mousein",function(a){var b=a.target.getBoundingClientRect();a.gameViewportX=a.pageX-b.left,a.gameViewportY=a.pageY-b.top,c.fire(g,g.events.pointerin,a),a.preventDefault()}),this.canvas.addEventListener("mouseout",function(a){var b=a.target.getBoundingClientRect();a.gameViewportX=a.pageX-b.left,a.gameViewportY=a.pageY-b.top,c.fire(g,g.events.pointerout,a),a.preventDefault()}),this.canvas.addEventListener("touchstart",function(a){a.preventDefault(),a=a.changedTouches[0];var b=a.target.getBoundingClientRect();a.gameViewportX=a.pageX-b.left,a.gameViewportY=a.pageY-b.top,c.fire(g,g.events.pointerdown,a)}),this.canvas.addEventListener("touchmove",function(a){a.preventDefault(),a=a.changedTouches[0];var b=a.target.getBoundingClientRect();a.gameViewportX=a.pageX-b.left,a.gameViewportY=a.pageY-b.top,c.fire(g,g.events.pointermove,a)}),this.canvas.addEventListener("touchend",function(a){a.preventDefault(),a=a.changedTouches[0];var b=a.target.getBoundingClientRect();a.gameViewportX=a.pageX-b.left,a.gameViewportY=a.pageY-b.top,c.fire(g,g.events.pointerup,a)}),this.canvas.addEventListener("touchleave",function(a){a.preventDefault(),a=a.changedTouches[0];var b=a.target.getBoundingClientRect();a.gameViewportX=a.pageX-b.left,a.gameViewportY=a.pageY-b.top,c.fire(g,g.events.pointerout,a),a.preventDefault()})}var c=a("events"),d=a("./config"),e=b.prototype;return e.events={update:0,resize:1,pointerdown:2,pointerup:3,pointermove:4,pointerin:5,pointerout:6},e._active=!0,e.size=null,e.width=null,e.height=null,e.viewportMatrix=null,e.camera=null,e.canvas=null,e.context=null,e.start=function(){this.setSize(this.canvas.offsetWidth,this.canvas.offsetHeight)},e.setSize=function(a,b){this.width=a,this.height=b,this.canvas.width=a,this.canvas.height=b,this.viewportMatrix[0]=a/2|0,this.viewportMatrix[5]=-b/2|0,this.viewportMatrix[12]=a/2|0,this.viewportMatrix[13]=b/2|0;for(var d=0;d<this.layers.length;d++){var e=this.layers[d];e.canvas.width=a,e.canvas.height=b}return c.fire(this,this.events.resize,this),this},e.setCamera=function(a){return this.camera=a,this.camera.camera.setViewport(this),this},e.active=function(a){if(void 0===a)return this._active;this._active=!!a},b}),function(a){"use strict";var b={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(b.exports={},define("engine/vendor/gl-matrix",[],function(){return b.exports})):b.exports="undefined"!=typeof window?window:a:b.exports=exports,function(a){if(!b)var b=1e-6;if(!c)var c="undefined"!=typeof Float32Array?Float32Array:Array;if(!d)var d=Math.random;var e={};e.setMatrixArrayType=function(a){c=a},void 0!==a&&(a.glMatrix=e);var f={};f.create=function(){var a=new c(2);return a[0]=0,a[1]=0,a},f.clone=function(a){var b=new c(2);return b[0]=a[0],b[1]=a[1],b},f.fromValues=function(a,b){var d=new c(2);return d[0]=a,d[1]=b,d},f.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a},f.set=function(a,b,c){return a[0]=b,a[1]=c,a},f.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a},f.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a},f.sub=f.subtract,f.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a},f.mul=f.multiply,f.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a},f.div=f.divide,f.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a},f.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a},f.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a},f.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a},f.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},f.dist=f.distance,f.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return c*c+d*d},f.sqrDist=f.squaredDistance,f.length=function(a){var b=a[0],c=a[1];return Math.sqrt(b*b+c*c)},f.len=f.length,f.squaredLength=function(a){var b=a[0],c=a[1];return b*b+c*c},f.sqrLen=f.squaredLength,f.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a},f.normalize=function(a,b){var c=b[0],d=b[1],e=c*c+d*d;return e>0&&(e=1/Math.sqrt(e),a[0]=b[0]*e,a[1]=b[1]*e),a},f.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]},f.cross=function(a,b,c){var d=b[0]*c[1]-b[1]*c[0];return a[0]=a[1]=0,a[2]=d,a},f.lerp=function(a,b,c,d){var e=b[0],f=b[1];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a},f.random=function(a,b){b=b||1;var c=2*d()*Math.PI;return a[0]=Math.cos(c)*b,a[1]=Math.sin(c)*b,a},f.transformMat2=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e,a[1]=c[1]*d+c[3]*e,a},f.transformMat2d=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e+c[4],a[1]=c[1]*d+c[3]*e+c[5],a},f.transformMat3=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[3]*e+c[6],a[1]=c[1]*d+c[4]*e+c[7],a},f.transformMat4=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[4]*e+c[12],a[1]=c[1]*d+c[5]*e+c[13],a},f.forEach=function(){var a=f.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=2),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;h<i;h+=c)a[0]=b[h],a[1]=b[h+1],f(a,a,g),b[h]=a[0],b[h+1]=a[1];return b}}(),f.str=function(a){return"vec2("+a[0]+", "+a[1]+")"},void 0!==a&&(a.vec2=f);var g={};g.create=function(){var a=new c(3);return a[0]=0,a[1]=0,a[2]=0,a},g.zero=g.create(),g.clone=function(a){var b=new c(3);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b},g.fromValues=function(a,b,d){var e=new c(3);return e[0]=a,e[1]=b,e[2]=d,e},g.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a},g.set=function(a,b,c,d){return a[0]=b,a[1]=c,a[2]=d,a},g.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a},g.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a},g.sub=g.subtract,g.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a},g.mul=g.multiply,g.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a},g.div=g.divide,g.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a},g.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a},g.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a},g.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a},g.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)},g.dist=g.distance,g.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return c*c+d*d+e*e},g.sqrDist=g.squaredDistance,g.length=function(a){var b=a[0],c=a[1],d=a[2];return Math.sqrt(b*b+c*c+d*d)},g.len=g.length,g.squaredLength=function(a){var b=a[0],c=a[1],d=a[2];return b*b+c*c+d*d},g.sqrLen=g.squaredLength,g.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a},g.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=c*c+d*d+e*e;return f>0&&(f=1/Math.sqrt(f),a[0]=b[0]*f,a[1]=b[1]*f,a[2]=b[2]*f),a},g.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},g.cross=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2];return a[0]=e*i-f*h,a[1]=f*g-d*i,a[2]=d*h-e*g,a},g.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a},g.random=function(a,b){b=b||1;var c=2*d()*Math.PI,e=2*d()-1,f=Math.sqrt(1-e*e)*b;return a[0]=Math.cos(c)*f,a[1]=Math.sin(c)*f,a[2]=e*b,a},g.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12],a[1]=c[1]*d+c[5]*e+c[9]*f+c[13],a[2]=c[2]*d+c[6]*e+c[10]*f+c[14],a},g.transformMat3=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=d*c[0]+e*c[3]+f*c[6],a[1]=d*c[1]+e*c[4]+f*c[7],a[2]=d*c[2]+e*c[5]+f*c[8],a},g.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},g.forEach=function(){var a=g.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=3),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;h<i;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2];return b}}(),g.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"},void 0!==a&&(a.vec3=g);var h={};h.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a},h.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},h.fromValues=function(a,b,d,e){var f=new c(4);return f[0]=a,f[1]=b,f[2]=d,f[3]=e,f},h.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},h.set=function(a,b,c,d,e){return a[0]=b,a[1]=c,a[2]=d,a[3]=e,a},h.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a[3]=b[3]+c[3],a},h.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a[3]=b[3]-c[3],a},h.sub=h.subtract,h.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a[3]=b[3]*c[3],a},h.mul=h.multiply,h.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a[3]=b[3]/c[3],a},h.div=h.divide,h.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a[3]=Math.min(b[3],c[3]),a},h.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a[3]=Math.max(b[3],c[3]),a},h.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a[3]=b[3]*c,a},h.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a[3]=b[3]+c[3]*d,a},h.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return Math.sqrt(c*c+d*d+e*e+f*f)},h.dist=h.distance,h.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return c*c+d*d+e*e+f*f},h.sqrDist=h.squaredDistance,h.length=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return Math.sqrt(b*b+c*c+d*d+e*e)},h.len=h.length,h.squaredLength=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return b*b+c*c+d*d+e*e},h.sqrLen=h.squaredLength,h.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=-b[3],a},h.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f;return g>0&&(g=1/Math.sqrt(g),a[0]=b[0]*g,a[1]=b[1]*g,a[2]=b[2]*g,a[3]=b[3]*g),a},h.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},h.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2],h=b[3];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a[3]=h+d*(c[3]-h),a},h.random=function(a,b){return b=b||1,a[0]=d(),a[1]=d(),a[2]=d(),a[3]=d(),h.normalize(a,a),h.scale(a,a,b),a},h.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12]*g,a[1]=c[1]*d+c[5]*e+c[9]*f+c[13]*g,a[2]=c[2]*d+c[6]*e+c[10]*f+c[14]*g,a[3]=c[3]*d+c[7]*e+c[11]*f+c[15]*g,a},h.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},h.forEach=function(){var a=h.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=4),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;h<i;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],a[3]=b[h+3],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2],b[h+3]=a[3];return b}}(),h.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},void 0!==a&&(a.vec4=h);var i={};i.create=function(){var a=new c(4);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},i.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},i.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},i.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},i.transpose=function(a,b){if(a===b){var c=b[1];a[1]=b[2],a[2]=c}else a[0]=b[0],a[1]=b[2],a[2]=b[1],a[3]=b[3];return a},i.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*f-e*d;return g?(g=1/g,a[0]=f*g,a[1]=-d*g,a[2]=-e*g,a[3]=c*g,a):null},i.adjoint=function(a,b){var c=b[0];return a[0]=b[3],a[1]=-b[1],a[2]=-b[2],a[3]=c,a},i.determinant=function(a){return a[0]*a[3]-a[2]*a[1]},i.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*h+e*j,a[1]=d*i+e*k,a[2]=f*h+g*j,a[3]=f*i+g*k,a},i.mul=i.multiply,i.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+e*h,a[1]=d*-h+e*i,a[2]=f*i+g*h,a[3]=f*-h+g*i,a},i.scale=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1];return a[0]=d*h,a[1]=e*i,a[2]=f*h,a[3]=g*i,a},i.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},void 0!==a&&(a.mat2=i);var j={};j.create=function(){var a=new c(6);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},j.clone=function(a){var b=new c(6);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b},j.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a},j.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},j.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=c*f-d*e;return i?(i=1/i,a[0]=f*i,a[1]=-d*i,a[2]=-e*i,a[3]=c*i,a[4]=(e*h-f*g)*i,a[5]=(d*g-c*h)*i,a):null},j.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},j.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=c[0],k=c[1],l=c[2],m=c[3],n=c[4],o=c[5];return a[0]=d*j+e*l,a[1]=d*k+e*m,a[2]=f*j+g*l,a[3]=f*k+g*m,a[4]=j*h+l*i+n,a[5]=k*h+m*i+o,a},j.mul=j.multiply,j.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=Math.sin(c),k=Math.cos(c);return a[0]=d*k+e*j,a[1]=-d*j+e*k,a[2]=f*k+g*j,a[3]=-f*j+k*g,a[4]=k*h+j*i,a[5]=k*i-j*h,a},j.scale=function(a,b,c){var d=c[0],e=c[1];return a[0]=b[0]*d,a[1]=b[1]*e,a[2]=b[2]*d,a[3]=b[3]*e,a[4]=b[4]*d,a[5]=b[5]*e,a},j.translate=function(a,b,c){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4]+c[0],a[5]=b[5]+c[1],a},j.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"},void 0!==a&&(a.mat2d=j);var k={};k.create=function(){var a=new c(9);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},k.fromMat4=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[4],a[4]=b[5],a[5]=b[6],a[6]=b[8],a[7]=b[9],a[8]=b[10],a},k.clone=function(a){var b=new c(9);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b},k.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},k.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},k.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[5];a[1]=b[3],a[2]=b[6],a[3]=c,a[5]=b[7],a[6]=d,a[7]=e}else a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8];return a},k.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=k*g-h*j,m=-k*f+h*i,n=j*f-g*i,o=c*l+d*m+e*n;return o?(o=1/o,a[0]=l*o,a[1]=(-k*d+e*j)*o,a[2]=(h*d-e*g)*o,a[3]=m*o,a[4]=(k*c-e*i)*o,a[5]=(-h*c+e*f)*o,a[6]=n*o,a[7]=(-j*c+d*i)*o,a[8]=(g*c-d*f)*o,a):null},k.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8];return a[0]=g*k-h*j,a[1]=e*j-d*k,a[2]=d*h-e*g,a[3]=h*i-f*k,a[4]=c*k-e*i,a[5]=e*f-c*h,a[6]=f*j-g*i,a[7]=d*i-c*j,a[8]=c*g-d*f,a},k.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8];return b*(j*f-g*i)+c*(-j*e+g*h)+d*(i*e-f*h)},k.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1],o=c[2],p=c[3],q=c[4],r=c[5],s=c[6],t=c[7],u=c[8];return a[0]=m*d+n*g+o*j,a[1]=m*e+n*h+o*k,a[2]=m*f+n*i+o*l,a[3]=p*d+q*g+r*j,a[4]=p*e+q*h+r*k,a[5]=p*f+q*i+r*l,a[6]=s*d+t*g+u*j,a[7]=s*e+t*h+u*k,a[8]=s*f+t*i+u*l,a},k.mul=k.multiply,k.translate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1];return a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=m*d+n*g+j,a[7]=m*e+n*h+k,a[8]=m*f+n*i+l,a},k.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=Math.sin(c),n=Math.cos(c);return a[0]=n*d+m*g,a[1]=n*e+m*h,a[2]=n*f+m*i,a[3]=n*g-m*d,a[4]=n*h-m*e,a[5]=n*i-m*f,a[6]=j,a[7]=k,a[8]=l,a},k.scale=function(a,b,c){var d=c[0],e=c[1];return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=e*b[3],a[4]=e*b[4],a[5]=e*b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},k.fromMat2d=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=0,a[3]=b[2],a[4]=b[3],a[5]=0,a[6]=b[4],a[7]=b[5],a[8]=1,a},k.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-(m+o),a[3]=k+r,a[6]=l-q,a[1]=k-r,a[4]=1-(j+o),a[7]=n+p,a[2]=l+q,a[5]=n-p,a[8]=1-(j+m),a},k.normalFromMat4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(i*A-g*D-j*z)*E,a[2]=(g*C-h*A+j*y)*E,a[3]=(e*C-d*D-f*B)*E,a[4]=(c*D-e*A+f*z)*E,a[5]=(d*A-c*C-f*y)*E,a[6]=(p*x-q*w+r*v)*E,a[7]=(q*u-o*x-r*t)*E,a[8]=(o*w-p*u+r*s)*E,a):null},k.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"},void 0!==a&&(a.mat3=k);var l={};l.create=function(){var a=new c(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.clone=function(a){var b=new c(16);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},l.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},l.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[3],f=b[6],g=b[7],h=b[11];a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=c,a[6]=b[9],a[7]=b[13],a[8]=d,a[9]=f,a[11]=b[14],a[12]=e,a[13]=g,a[14]=h}else a[0]=b[0],a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=b[1],a[5]=b[5],a[6]=b[9],a[7]=b[13],a[8]=b[2],a[9]=b[6],a[10]=b[10],a[11]=b[14],a[12]=b[3],a[13]=b[7],a[14]=b[11],a[15]=b[15];return a},l.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(e*C-d*D-f*B)*E,a[2]=(p*x-q*w+r*v)*E,a[3]=(m*w-l*x-n*v)*E,a[4]=(i*A-g*D-j*z)*E,a[5]=(c*D-e*A+f*z)*E,a[6]=(q*u-o*x-r*t)*E,a[7]=(k*x-m*u+n*t)*E,a[8]=(g*C-h*A+j*y)*E,a[9]=(d*A-c*C-f*y)*E,a[10]=(o*w-p*u+r*s)*E,a[11]=(l*u-k*w-n*s)*E,a[12]=(h*z-g*B-i*y)*E,a[13]=(c*B-d*z+e*y)*E,a[14]=(p*t-o*v-q*s)*E,a[15]=(k*v-l*t+m*s)*E,a):null},l.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15];return a[0]=h*(m*r-n*q)-l*(i*r-j*q)+p*(i*n-j*m),a[1]=-(d*(m*r-n*q)-l*(e*r-f*q)+p*(e*n-f*m)),a[2]=d*(i*r-j*q)-h*(e*r-f*q)+p*(e*j-f*i),a[3]=-(d*(i*n-j*m)-h*(e*n-f*m)+l*(e*j-f*i)),a[4]=-(g*(m*r-n*q)-k*(i*r-j*q)+o*(i*n-j*m)),a[5]=c*(m*r-n*q)-k*(e*r-f*q)+o*(e*n-f*m),a[6]=-(c*(i*r-j*q)-g*(e*r-f*q)+o*(e*j-f*i)),a[7]=c*(i*n-j*m)-g*(e*n-f*m)+k*(e*j-f*i),a[8]=g*(l*r-n*p)-k*(h*r-j*p)+o*(h*n-j*l),a[9]=-(c*(l*r-n*p)-k*(d*r-f*p)+o*(d*n-f*l)),a[10]=c*(h*r-j*p)-g*(d*r-f*p)+o*(d*j-f*h),a[11]=-(c*(h*n-j*l)-g*(d*n-f*l)+k*(d*j-f*h)),a[12]=-(g*(l*q-m*p)-k*(h*q-i*p)+o*(h*m-i*l)),a[13]=c*(l*q-m*p)-k*(d*q-e*p)+o*(d*m-e*l),a[14]=-(c*(h*q-i*p)-g*(d*q-e*p)+o*(d*i-e*h)),a[15]=c*(h*m-i*l)-g*(d*m-e*l)+k*(d*i-e*h),a},l.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return(b*g-c*f)*(l*q-m*p)-(b*h-d*f)*(k*q-m*o)+(b*i-e*f)*(k*p-l*o)+(c*h-d*g)*(j*q-m*n)-(c*i-e*g)*(j*p-l*n)+(d*i-e*h)*(j*o-k*n)},l.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c[0],u=c[1],v=c[2],w=c[3];return a[0]=t*d+u*h+v*l+w*p,a[1]=t*e+u*i+v*m+w*q,a[2]=t*f+u*j+v*n+w*r,a[3]=t*g+u*k+v*o+w*s,t=c[4],u=c[5],v=c[6],w=c[7],a[4]=t*d+u*h+v*l+w*p,a[5]=t*e+u*i+v*m+w*q,a[6]=t*f+u*j+v*n+w*r,a[7]=t*g+u*k+v*o+w*s,t=c[8],u=c[9],v=c[10],w=c[11],a[8]=t*d+u*h+v*l+w*p,a[9]=t*e+u*i+v*m+w*q,a[10]=t*f+u*j+v*n+w*r,a[11]=t*g+u*k+v*o+w*s,t=c[12],u=c[13],v=c[14],w=c[15],a[12]=t*d+u*h+v*l+w*p,a[13]=t*e+u*i+v*m+w*q,a[14]=t*f+u*j+v*n+w*r,a[15]=t*g+u*k+v*o+w*s,a},l.mul=l.multiply,l.translate=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p=c[0],q=c[1],r=c[2];return b===a?(a[12]=b[0]*p+b[4]*q+b[8]*r+b[12],a[13]=b[1]*p+b[5]*q+b[9]*r+b[13],a[14]=b[2]*p+b[6]*q+b[10]*r+b[14],a[15]=b[3]*p+b[7]*q+b[11]*r+b[15]):(d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=j,a[7]=k,a[8]=l,a[9]=m,a[10]=n,a[11]=o,a[12]=d*p+h*q+l*r+b[12],a[13]=e*p+i*q+m*r+b[13],a[14]=f*p+j*q+n*r+b[14],a[15]=g*p+k*q+o*r+b[15]),a},l.scale=function(a,b,c){var d=c[0],e=c[1],f=c[2];return a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a[3]=b[3]*d,a[4]=b[4]*e,a[5]=b[5]*e,a[6]=b[6]*e,a[7]=b[7]*e,a[8]=b[8]*f,a[9]=b[9]*f,a[10]=b[10]*f,a[11]=b[11]*f,a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},l.rotate=function(a,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=e[0],E=e[1],F=e[2],G=Math.sqrt(D*D+E*E+F*F);return Math.abs(G)<b?null:(G=1/G,D*=G,E*=G,F*=G,f=Math.sin(d),g=Math.cos(d),h=1-g,i=c[0],j=c[1],k=c[2],l=c[3],m=c[4],n=c[5],o=c[6],p=c[7],q=c[8],r=c[9],s=c[10],t=c[11],u=D*D*h+g,v=E*D*h+F*f,w=F*D*h-E*f,x=D*E*h-F*f,y=E*E*h+g,z=F*E*h+D*f,A=D*F*h+E*f,B=E*F*h-D*f,C=F*F*h+g,a[0]=i*u+m*v+q*w,a[1]=j*u+n*v+r*w,a[2]=k*u+o*v+s*w,a[3]=l*u+p*v+t*w,a[4]=i*x+m*y+q*z,a[5]=j*x+n*y+r*z,a[6]=k*x+o*y+s*z,a[7]=l*x+p*y+t*z,a[8]=i*A+m*B+q*C,a[9]=j*A+n*B+r*C,a[10]=k*A+o*B+s*C,a[11]=l*A+p*B+t*C,c!==a&&(a[12]=c[12],a[13]=c[13],a[14]=c[14],a[15]=c[15]),a)},l.rotateX=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[4],g=b[5],h=b[6],i=b[7],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[4]=f*e+j*d,a[5]=g*e+k*d,a[6]=h*e+l*d,a[7]=i*e+m*d,a[8]=j*e-f*d,a[9]=k*e-g*d,a[10]=l*e-h*d,a[11]=m*e-i*d,a},l.rotateY=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e-j*d,a[1]=g*e-k*d,a[2]=h*e-l*d,a[3]=i*e-m*d,a[8]=f*d+j*e,a[9]=g*d+k*e,a[10]=h*d+l*e,a[11]=i*d+m*e,a},l.rotateZ=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[4],k=b[5],l=b[6],m=b[7];return b!==a&&(a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e+j*d,a[1]=g*e+k*d,a[2]=h*e+l*d,a[3]=i*e+m*d,a[4]=j*e-f*d,a[5]=k*e-g*d,a[6]=l*e-h*d,a[7]=m*e-i*d,a},l.fromRotationTranslation=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=d+d,i=e+e,j=f+f,k=d*h,l=d*i,m=d*j,n=e*i,o=e*j,p=f*j,q=g*h,r=g*i,s=g*j;return a[0]=1-(n+p),a[1]=l+s,a[2]=m-r,a[3]=0,a[4]=l-s,a[5]=1-(k+p),a[6]=o+q,a[7]=0,a[8]=m+r,a[9]=o-q,a[10]=1-(k+n),a[11]=0,a[12]=c[0],a[13]=c[1],a[14]=c[2],a[15]=1,a},l.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-(m+o),a[1]=k+r,a[2]=l-q,a[3]=0,a[4]=k-r,a[5]=1-(j+o),a[6]=n+p,a[7]=0,a[8]=l+q,a[9]=n-p,a[10]=1-(j+m),a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.frustum=function(a,b,c,d,e,f,g){var h=1/(c-b),i=1/(e-d),j=1/(f-g);return a[0]=2*f*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*f*i,a[6]=0,a[7]=0,a[8]=(c+b)*h,a[9]=(e+d)*i,a[10]=(g+f)*j,a[11]=-1,a[12]=0,a[13]=0,a[14]=g*f*2*j,a[15]=0,a},l.perspective=function(a,b,c,d,e){var f=1/Math.tan(b/2),g=1/(d-e);return a[0]=f/c,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(e+d)*g,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*e*d*g,a[15]=0,a},l.ortho=function(a,b,c,d,e,f,g){var h=1/(b-c),i=1/(d-e),j=1/(f-g);return a[0]=-2*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*i,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*j,a[11]=0,a[12]=(b+c)*h,a[13]=(e+d)*i,a[14]=(g+f)*j,a[15]=1,a},l.lookAt=function(a,c,d,e){var f,g,h,i,j,k,m,n,o,p,q=c[0],r=c[1],s=c[2],t=e[0],u=e[1],v=e[2],w=d[0],x=d[1],y=d[2];return Math.abs(q-w)<b&&Math.abs(r-x)<b&&Math.abs(s-y)<b?l.identity(a):(m=q-w,n=r-x,o=s-y,p=1/Math.sqrt(m*m+n*n+o*o),m*=p,n*=p,o*=p,f=u*o-v*n,g=v*m-t*o,h=t*n-u*m,p=Math.sqrt(f*f+g*g+h*h),p?(p=1/p,f*=p,g*=p,h*=p):(f=0,g=0,h=0),i=n*h-o*g,j=o*f-m*h,k=m*g-n*f,p=Math.sqrt(i*i+j*j+k*k),p?(p=1/p,i*=p,j*=p,k*=p):(i=0,j=0,k=0),a[0]=f,a[1]=i,a[2]=m,a[3]=0,a[4]=g,a[5]=j,a[6]=n,a[7]=0,a[8]=h,a[9]=k,a[10]=o,a[11]=0,a[12]=-(f*q+g*r+h*s),a[13]=-(i*q+j*r+k*s),a[14]=-(m*q+n*r+o*s),a[15]=1,a)},l.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"},void 0!==a&&(a.mat4=l);var m={};m.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},m.rotationTo=function(){var a=g.create(),b=g.fromValues(1,0,0),c=g.fromValues(0,1,0);return function(d,e,f){var h=g.dot(e,f);return h<-.999999?(g.cross(a,b,e),g.length(a)<1e-6&&g.cross(a,c,e),g.normalize(a,a),m.setAxisAngle(d,a,Math.PI),d):h>.999999?(d[0]=0,d[1]=0,d[2]=0,d[3]=1,d):(g.cross(a,e,f),d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=1+h,m.normalize(d,d))}}(),m.setAxes=function(){var a=k.create();return function(b,c,d,e){return a[0]=d[0],a[3]=d[1],a[6]=d[2],a[1]=e[0],a[4]=e[1],a[7]=e[2],a[2]=c[0],a[5]=c[1],a[8]=c[2],m.normalize(b,m.fromMat3(b,a))}}(),m.clone=h.clone,m.fromValues=h.fromValues,m.copy=h.copy,m.set=h.set,m.identity=function(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},m.setAxisAngle=function(a,b,c){c*=.5;var d=Math.sin(c);return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=Math.cos(c),a},m.add=h.add,m.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*k+g*h+e*j-f*i,a[1]=e*k+g*i+f*h-d*j,a[2]=f*k+g*j+d*i-e*h,a[3]=g*k-d*h-e*i-f*j,a},m.mul=m.multiply,m.scale=h.scale,m.rotateX=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+g*h,a[1]=e*i+f*h,a[2]=f*i-e*h,a[3]=g*i-d*h,a},m.rotateY=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i-f*h,a[1]=e*i+g*h,a[2]=f*i+d*h,a[3]=g*i-e*h,a},
m.rotateZ=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+e*h,a[1]=e*i-d*h,a[2]=f*i+g*h,a[3]=g*i-f*h,a},m.calculateW=function(a,b){var c=b[0],d=b[1],e=b[2];return a[0]=c,a[1]=d,a[2]=e,a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a},m.dot=h.dot,m.lerp=h.lerp,m.slerp=function(a,b,c,d){var e,f,g,h,i,j=b[0],k=b[1],l=b[2],m=b[3],n=c[0],o=c[1],p=c[2],q=c[3];return f=j*n+k*o+l*p+m*q,f<0&&(f=-f,n=-n,o=-o,p=-p,q=-q),1-f>1e-6?(e=Math.acos(f),g=Math.sin(e),h=Math.sin((1-d)*e)/g,i=Math.sin(d*e)/g):(h=1-d,i=d),a[0]=h*j+i*n,a[1]=h*k+i*o,a[2]=h*l+i*p,a[3]=h*m+i*q,a},m.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f,h=g?1/g:0;return a[0]=-c*h,a[1]=-d*h,a[2]=-e*h,a[3]=f*h,a},m.conjugate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=b[3],a},m.length=h.length,m.len=m.length,m.squaredLength=h.squaredLength,m.sqrLen=m.squaredLength,m.normalize=h.normalize,m.fromMat3=function(){var a="undefined"!=typeof Int8Array?new Int8Array([1,2,0]):[1,2,0];return function(b,c){var d,e=c[0]+c[4]+c[8];if(e>0)d=Math.sqrt(e+1),b[3]=.5*d,d=.5/d,b[0]=(c[7]-c[5])*d,b[1]=(c[2]-c[6])*d,b[2]=(c[3]-c[1])*d;else{var f=0;c[4]>c[0]&&(f=1),c[8]>c[3*f+f]&&(f=2);var g=a[f],h=a[g];d=Math.sqrt(c[3*f+f]-c[3*g+g]-c[3*h+h]+1),b[f]=.5*d,d=.5/d,b[3]=(c[3*h+g]-c[3*g+h])*d,b[g]=(c[3*g+f]+c[3*f+g])*d,b[h]=(c[3*h+f]+c[3*f+h])*d}return b}}(),m.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},void 0!==a&&(a.quat=m)}(b.exports)}(this),define("engine/component",["require","namespace","events"],function(a){function b(){}var c=a("namespace"),d=a("events");c("Isometrica.Engine").Component=b;var e=b.prototype=Object.create(d.prototype);return e.gameObject=null,e.enabled=!0,e.setGameObject=function(a){this.gameObject=a},e.unsetGameObject=function(){this.gameObject=null},e.awake=null,e.start=null,e.tick=null,b}),define("engine/components/transformcomponent",["require","namespace","../component","../vendor/gl-matrix"],function(a){function b(){this.children=[],this.local=new Float32Array(j),this.localToWorld=new Float32Array(j),this.worldToLocal=new Float32Array(j);var a=this;this.onParentUpdate=function(b){a.dirtyL=!0,a.dirtyW=!0}}function c(a){return!0===a.dirtyL&&(null===a.parent?g.mat4.copy(a.localToWorld,a.local):g.mat4.multiply(a.localToWorld,c(a.parent),a.local),a.dirtyL=!1),a.localToWorld}function d(a,b){void 0===b&&(b=[]);var d=c(a);return b[0]=d[12],b[1]=d[13],b[2]=d[14],b}var e=a("namespace"),f=a("../component"),g=a("../vendor/gl-matrix"),h=g.mat4,i=g.vec3;e("Isometrica.Engine").TransformComponent=b;var j=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];b.getPosition=d,b.getLocalToWorld=c;var k=b.prototype=Object.create(f.prototype),l=new Float32Array([0,0,0]),m=new Float32Array(16);return k.constructor=b,k.events={update:0},k.local=null,k.localToWorld=null,k.worldToLocal=null,k.children=null,k.parent=null,k.dirtyW=!1,k.dirtyL=!1,k.onParentUpdate=null,k.addChild=function(a){this.children[this.children.length]=a,a.setParent(this)},k.removeChild=function(a){this.children.splice(this.children.indexOf(a),1),a.removeParent()},k.destroy=function(){null!==this.parent&&this.parent.removeChild(this)},k.setParent=function(a){this.parent=a,a.addEventListener(a.events.update,this.onParentUpdate),null!==a.gameObject.world&&a.gameObject.world.addGameObject(this.gameObject),this.dirtyL=!0,this.dirtyW=!0},k.setGameObject=function(a){f.prototype.setGameObject.call(this,a),a.transform=this},k.unsetGameObject=function(){throw"Transform shouldn't be remove from gameObject"},k.removeParent=function(){this.parent.removeEventListener(this.parent.events.update,this.onParentUpdate),this.parent=null,this.dirtyL=!0,this.dirtyW=!0},k.translate=function(a,b,c,d){l[0]=a,l[1]=b,l[2]=c,"world"===d?(h.identity(m),h.translate(m,m,l),h.multiply(this.local,m,this.local)):h.translate(this.local,this.local,l),this.dirtyL=!0,this.dirtyW=!0,this.dispatchEvent(this.events.update,this)},k.rotate=function(a,b,c,d){var e=Math.PI/180,f=g.mat4;"world"===d?(f.identity(m),f.rotateZ(m,m,c*e),f.rotateY(m,m,b*e),f.rotateX(m,m,a*e),f.multiply(this.local,m,this.local)):(f.rotateZ(this.local,this.local,c*e),f.rotateY(this.local,this.local,b*e),f.rotateX(this.local,this.local,a*e)),this.dirtyL=!0,this.dirtyW=!0,this.dispatchEvent(this.events.update,this)},k.getLocalToWorld=function(){return!0===this.dirtyL&&(null===this.parent?g.mat4.copy(this.localToWorld,this.local):g.mat4.multiply(this.localToWorld,c(this.parent),this.local),this.dirtyL=!1),this.localToWorld},k.getWorldToLocal=function(){return!0===this.dirtyW&&(g.mat4.invert(this.worldToLocal,c(this)),this.dirtyW=!1),this.worldToLocal},k.getPosition=function(a){void 0===a&&(a=[]);var b=c(this);return a[0]=b[12],a[1]=b[13],a[2]=b[14],a},k.getLocalPosition=function(a){void 0===a&&(a=[]);var b=this.local;return a[0]=b[12],a[1]=b[13],a[2]=b[14],a},k.getRotation=function(){throw"TransformComponent.getRotation not implemented yet"},k.getLocalRotation=function(){throw"TransformComponent.getLocalRotation not implemented yet"},k.setPosition=function(a,b,c){l[0]=a,l[1]=b,l[2]=c,null!==this.parent&&i.transformMat4(l,l,this.parent.getWorldToLocal()),this.local[12]=l[0],this.local[13]=l[1],this.local[14]=l[2],this.dirtyL=!0,this.dirtyW=!0,this.dispatchEvent(this.events.update,this)},k.setLocalPosition=function(a,b,c){this.local[12]=a,this.local[13]=b,this.local[14]=c,this.dirtyL=!0,this.dirtyW=!0,this.dispatchEvent(this.events.update,this)},b}),define("engine/Canvas2dRenderer",["require","./config","./vendor/gl-matrix","./components/transformcomponent"],function(a){function b(a){this.graphics=a,this.layerBuffers=[];for(var b=0;b<d.layersCount;b++)this.layerBuffers[b]=[];this.M=[],this.V=[]}function c(a,b,c){c.context.fillRect(0,0,100,100);var e,f,g,i,j,k,l=b.world.retrieve(b),m=l.length,n=d.layersCount;for(a.M=b.camera.getWorldToScreen(),a.V=b.camera.getWorldToViewport(),c.context.clearRect(0,0,c.width,c.height),i=0;i<m;i++)void 0!==(e=l[i].renderer)&&e.enabled&&e.cullingTest(c,a,e)&&a.layerBuffers[e.layer].push(e);for(i=0;i<n;i++){for(k=c.layers[i],~d.noLayerClearMask&1<<i&&k.clearRect(0,0,k.canvas.width,k.canvas.height),f=a.layerBuffers[i],g=f.length,~d.noLayerDepthSortingMask&1<<i&&f.sort(h),j=0;j<g;j++)e=f.pop(),e.render(k,a,c,e);c.context.drawImage(k.canvas,0,0)}}var d=a("./config"),e=(a("./vendor/gl-matrix"),a("./components/transformcomponent")),f=b.prototype,g=new Float32Array([0,0,0]),h=(new Float32Array([0,0,0]),new Float32Array(16),function(a,b){return e.getPosition(a.gameObject.transform,g),a=g[0]-g[1]+g[2],e.getPosition(b.gameObject.transform,g),a-(g[0]-g[1]+g[2])});return b.render=c,f.graphics=null,b}),define("engine/graphics",["./viewport","./Canvas2dRenderer"],function(a,b){function c(a){this.game=a,this.viewports=[],this.renderer=new b(this),this.started=!1}var d=c.prototype;return d.game=null,d.started=!1,d.viewports=null,d.start=function(){for(var a=this.viewports,b=a.length,c=0;c<b;c++)a[c].start();this.started=!0},d.createViewport=function(b){var c=new a(this,b);return this.viewports.push(c),this.started&&c.start(),c},d.render=function(){for(var a=this.viewports,c=a.length,d=null,e=0;e<c;e++)d=a[e],!0===d.active()&&null!==d.camera&&b.render(this.renderer,d.camera,a[e])},c}),define("engine/time",[],function(){function a(){this.now=Date.now()}var b=a.prototype;return b.time=0,b.now=0,b.dt=60,b.tick=function(){this.time+=this.dt,this.now+=this.dt},a}),define("engine/lib/Octree/node",[],function(){function a(a){this.tree=a,this.type=0,this.items=[],this.count=0,this.nodesCount=0,this.nodesMask=0,this.parent=null,this.depth=0,this.x=0,this.y=0,this.z=0,this.ex=0,this.ey=0,this.ez=0,this.subnode0=null,this.subnode1=null,this.subnode2=null,this.subnode3=null,this.subnode4=null,this.subnode5=null,this.subnode6=null,this.subnode7=null}var b=new Int8Array(129);b[2]=1,b[4]=2,b[8]=3,b[16]=4,b[32]=5,b[64]=6,b[128]=7;var c=new Array(8);c[0]="subnode0",c[1]="subnode1",c[2]="subnode2",c[3]="subnode3",c[4]="subnode4",c[5]="subnode5",c[6]="subnode6",c[7]="subnode7";var d=new Uint8Array(64);d[0]=1,d[1]=3,d[2]=5,d[3]=15,d[4]=17,d[5]=51,d[6]=85,d[7]=255,d[8]=3,d[9]=2,d[10]=15,d[11]=10,d[12]=51,d[13]=34,d[14]=255,d[15]=170,d[16]=5,d[17]=15,d[18]=4,d[19]=12,d[20]=85,d[21]=255,d[22]=68,d[23]=204,d[24]=15,d[25]=10,d[26]=12,d[27]=8,d[28]=255,d[29]=170,d[30]=204,d[31]=136,d[32]=17,d[33]=51,d[34]=85,d[35]=255,d[36]=16,d[37]=48,d[38]=80,d[39]=240,d[40]=51,d[41]=34,d[42]=255,d[43]=170,d[44]=48,d[45]=32,d[46]=240,d[47]=160,d[48]=85,d[49]=255,d[50]=68,d[51]=204,d[52]=80,d[53]=240,d[54]=64,d[55]=192,d[56]=255,d[57]=170,d[58]=204,d[59]=136,d[60]=240,d[61]=160,d[62]=192,d[63]=128;var e=function(a,b){var c=0,e=0;return b.z-b.ez>=a.z?(c=4,e=4):b.z+b.ez>=a.z&&(e=4),b.y-b.ey>=a.y?(c|=2,e|=2):b.y+b.ey>=a.y&&(e|=2),b.x-b.ex>=a.x?(c|=1,e|=1):b.x+b.ex>=a.x&&(e|=1),d[8*c+e]};a.LEAF=0,a.BRANCH=1,a.indexToKey=c;var f=function(b,d,e){var f=new a(b);return f.ex=d.ex/2,f.ey=d.ey/2,f.ez=d.ez/2,f.x=d.x-f.ex+d.ex*(1&e),f.y=d.y-f.ey+d.ey*((2&e)>>1),f.z=d.z-f.ez+d.ez*((4&e)>>2),f.depth=d.depth+1,f.parent=d,d[c[e]]=f,d.nodesCount++,d.nodesMask|=1<<e,f},g=function(b,c,d){if(c.count++,c.type===a.LEAF)c.items.push(d),c.count>=b.treshold&&i(b,c);else{var h=e(c,d),j=c.nodesMask;1&h&&(1&j?g(b,c.subnode0,d):g(b,f(b,c,0),d)),2&h&&(2&j?g(b,c.subnode1,d):g(b,f(b,c,1),d)),4&h&&(4&j?g(b,c.subnode2,d):g(b,f(b,c,2),d)),8&h&&(8&j?g(b,c.subnode3,d):g(b,f(b,c,3),d)),16&h&&(16&j?g(b,c.subnode4,d):g(b,f(b,c,4),d)),32&h&&(32&j?g(b,c.subnode5,d):g(b,f(b,c,5),d)),64&h&&(64&j?g(b,c.subnode6,d):g(b,f(b,c,6),d)),128&h&&(128&j?g(b,c.subnode7,d):g(b,f(b,c,7),d))}},h=function(b,c,d){if(c.type===a.LEAF){var f=c.items.indexOf(d);return-1!==f&&(c.items.splice(f,1),c.count--,!0)}var g,i=!0,k=e(c,d);return 1&k&&(g=c.subnode0,h(b,g,d)?0===g.count&&(c.subnode0=null,c.nodesCount--,c.nodesMask^=1):i=!1),2&k&&(g=c.subnode1,h(b,g,d)?0===g.count&&(c.subnode1=null,c.nodesCount--,c.nodesMask^=2):i=!1),4&k&&(g=c.subnode2,h(b,g,d)?0===g.count&&(c.subnode2=null,c.nodesCount--,c.nodesMask^=4):i=!1),8&k&&(g=c.subnode3,h(b,g,d)?0===g.count&&(c.subnode3=null,c.nodesCount--,c.nodesMask^=8):i=!1),16&k&&(g=c.subnode4,h(b,g,d)?0===g.count&&(c.subnode4=null,c.nodesCount--,c.nodesMask^=16):i=!1),32&k&&(g=c.subnode5,h(b,g,d)?0===g.count&&(c.subnode5=null,c.nodesCount--,c.nodesMask^=32):i=!1),64&k&&(g=c.subnode6,h(b,g,d)?0===g.count&&(c.subnode6=null,c.nodesCount--,c.nodesMask^=64):i=!1),128&k&&(g=c.subnode7,h(b,g,d)?0===g.count&&(c.subnode7=null,c.nodesCount--,c.nodesMask^=128):i=!1),!0===i&&c.count--,c.count<c.tree.treshold&&j(b,c),i},i=function(b,c){if(!(c.depth>b.maxDepth||c.ex<=c.tree.tearDrop)){var d,h,i,j=c.items,k=j.length;c.type=a.BRANCH,c.items=null;for(var l=0;l<k;l++)d=j[l],h=e(c,d),i=c.nodesMask,1&h&&(1&i?g(b,c.subnode0,d):g(b,f(b,c,0),d)),2&h&&(2&i?g(b,c.subnode1,d):g(b,f(b,c,1),d)),4&h&&(4&i?g(b,c.subnode2,d):g(b,f(b,c,2),d)),8&h&&(8&i?g(b,c.subnode3,d):g(b,f(b,c,3),d)),16&h&&(16&i?g(b,c.subnode4,d):g(b,f(b,c,4),d)),32&h&&(32&i?g(b,c.subnode5,d):g(b,f(b,c,5),d)),64&h&&(64&i?g(b,c.subnode6,d):g(b,f(b,c,6),d)),128&h&&(128&i?g(b,c.subnode7,d):g(b,f(b,c,7),d))}},j=function(b,c){var d,e,f,g,h,i=c.nodesMask;if(c.type=a.LEAF,c.nodesCount=0,c.nodesMask=0,1&i){if(d=c.subnode0,null===c.items)c.items=e=d.items;else{f=d.items,g=f.length;for(var j=0;j<g;j++)-1===e.indexOf(h=f[j])&&e.push(h)}c.subnode0=null}if(2&i){if(d=c.subnode1,null===c.items)c.items=e=d.items;else{f=d.items,g=f.length;for(var j=0;j<g;j++)-1===e.indexOf(h=f[j])&&e.push(h)}c.subnode1=null}if(4&i){if(d=c.subnode2,null===c.items)c.items=e=d.items;else{f=d.items,g=f.length;for(var j=0;j<g;j++)-1===e.indexOf(h=f[j])&&e.push(h)}c.subnode2=null}if(8&i){if(d=c.subnode3,null===c.items)c.items=e=d.items;else{f=d.items,g=f.length;for(var j=0;j<g;j++)-1===e.indexOf(h=f[j])&&e.push(h)}c.subnode3=null}if(16&i){if(d=c.subnode4,null===c.items)c.items=e=d.items;else{f=d.items,g=f.length;for(var j=0;j<g;j++)-1===e.indexOf(h=f[j])&&e.push(h)}c.subnode4=null}if(32&i){if(d=c.subnode5,null===c.items)c.items=e=d.items;else{f=d.items,g=f.length;for(var j=0;j<g;j++)-1===e.indexOf(h=f[j])&&e.push(h)}c.subnode5=null}if(64&i){if(d=c.subnode6,null===c.items)c.items=e=d.items;else{f=d.items,g=f.length;for(var j=0;j<g;j++)-1===e.indexOf(h=f[j])&&e.push(h)}c.subnode6=null}if(128&i){if(d=c.subnode7,null===c.items)c.items=e=d.items;else{f=d.items,g=f.length;for(var j=0;j<g;j++)-1===e.indexOf(h=f[j])&&e.push(h)}c.subnode7=null}},k=function(b,c,d){if(b.type===a.BRANCH){var f=e(b,c);1&f&&k(b.subnode0,c,d),2&f&&k(b.subnode1,c,d),4&f&&k(b.subnode2,c,d),8&f&&k(b.subnode3,c,d),16&f&&k(b.subnode4,c,d),32&f&&k(b.subnode5,c,d),64&f&&k(b.subnode6,c,d),128&f&&k(b.subnode7,c,d)}else{var g,h,i=b.items,j=i.length;for(h=0;h<j;h++)(g=i[h])!==c&&(g.flag=1,d.push(g.id))}},l=function(b,d,e){if(null!==d.parent)return!1;var f,g=2*d.ex,h=2*d.ey,j=2*d.ez,k=d.x+d.ex-g*(1&e),l=d.y+d.ey-h*((2&e)>>1),m=d.z+d.ez-j*((4&e)>>2);return d.type===a.BRANCH?(f=new a(b),f.x=k,f.y=l,f.z=m,f.ex=g,f.ey=h,f.ez=j,i(b,f),f[c[e]]=d,f.count=d.count,f.nodesCount=1,f.nodesMask=1<<e,d.parent=f,n(b,d),f):(d.x=k,d.y=l,d.z=m,d.ex=g,d.ey=h,d.ez=j,d)},m=function(a,d){if(null===d.parent&&1===d.nodesCount){var e=d[c[b[d.nodesMask]]];return e.parent.depth=-1,n(a,e),e.parent=null,e}return!1},n=function(b,c){if(c.depth=c.parent.depth+1,c.type===a.BRANCH)if(c.depth>b.maxDepth)j(b,c);else{var d=c.nodesMask;1&d&&n(b,c.subnode0),2&d&&n(b,c.subnode1),4&d&&n(b,c.subnode2),8&d&&n(b,c.subnode3),16&d&&n(b,c.subnode4),32&d&&n(b,c.subnode5),64&d&&n(b,c.subnode6),128&d&&n(b,c.subnode7)}};return a.insert=g,a.remove=h,a.retrieve=k,a.grow=l,a.shrink=m,a}),define("engine/lib/Octree/Item",[],function(){function a(b,c,d,e,f,g){3===arguments.length?(this.type=a.POINT,this.x=b,this.y=c,this.z=d):(this.type=a.AABB,this.x=b,this.y=c,this.z=d,this.ex=e,this.ey=f,this.ez=g),this.flag=0,this.id=null}a.POINT=0,a.AABB=1;var b=a.prototype;return b.id=null,b.type=null,b.flag=0,b.x=0,b.y=0,b.z=0,b.ex=0,b.ey=0,b.ez=0,a}),define("engine/lib/octree",["./Octree/node","./Octree/Item"],function(a,b){function c(a,b,c){this.maxDepth=a||8,this.treshold=b||32,this.tearDrop=c||1,this.items=[],this.lastItemId=0}c.Item=b,c.Node=a;var d=c.prototype;return d.treshold=null,d.maxDepth=null,d.tearDrop=0,d.root=null,d.lastItemId=0,d.items=null,d.insert=function(b){if(null===b.id&&(b.id=this.lastItemId++,this.items[b.id]=b),null===this.root){var c=this.root=new a(this);c.x=b.x,c.y=b.y,c.z=b.z,c.ex=b.ex+1,c.ey=b.ey+1,c.ez=b.ez+1}else var c=this.root;if(b.x-b.ex>=c.x-c.ex&&b.x+b.ex<=c.x+c.ex&&b.y-b.ey>=c.y-c.ey&&b.y+b.ey<=c.y+c.ey&&b.z-b.ez>=c.z-c.ez&&b.z+b.ez<=c.z+c.ez)a.insert(this,this.root,b);else{var d=this.root.x-b.x,e=this.root.y-b.y,f=this.root.z-b.z;this.grow(d,e,f),this.insert(b)}},d.remove=function(b){var c=this.root;if(b.x-b.ex>=c.x-c.ex&&b.x+b.ex<=c.x+c.ex&&b.y-b.ey>=c.y-c.ey&&b.y+b.ey<=c.y+c.ey&&b.z-b.ez>=c.z-c.ez&&b.z+b.ez<=c.z+c.ez){var d=a.remove(this,this.root,b);return!0===d&&this.shrink(),0===this.root.count&&(this.root=null),d}return!1},d.retrieve=function(b,c){if(c=c||[],null!==this.root){a.retrieve(this.root,b,c);for(var d=c.length,e=this.items,f=0,g=0;f<d;f++){var b=e[c[f]];1&b.flag&&(b.flag=0,c[g++]=b)}c.splice(g,f-g)}return c},d.grow=function(b,c,d){b=b>=0?1:0,c=c>=0?1:0,d=d>=0?1:0;var e=(d<<2)+(c<<1)+b;this.root=a.grow(this,this.root,e)},d.shrink=function(){var b=a.shrink(this,this.root);!1!==b&&(this.root=b)},c}),define("engine/world",["require","./lib/octree","events"],function(a){function b(a,b){d.call(this),this.logic=a,this.gameObjects=[],!0===b&&(q=this.octree=new c(64,1e3,45)),this.removeQueue=[]}var c=a("./lib/octree"),d=a("events"),e=b.prototype=Object.create(d.prototype);return e.events={awake:0,start:1,update:2},e.logic=null,e.octree=null,e.gameObjects=null,e.gameObjectsCount=0,e.removeQueue=null,e.removeQueueWaiting=!1,e._started=!1,e._awaken=!1,e.addGameObject=function(a){if(this.gameObjects[this.gameObjectsCount++]=a,a.setWorld(this),null!==this.octree){var b=a.transform.getPosition(),d=new c.Item(b[0],b[1],b[2]);a.item=d,d.gameObject=a,this.octree.insert(d);var e=this.octree;a.transform.addEventListener(a.transform.events.update,function(a){e.remove(d);var b=a.getPosition();d.x=b[0],d.y=b[1],d.z=b[2],e.insert(d)})}if(this._awaken&&a.awake(),this._started&&a.start(),0!==a.transform.children.length)for(var f=0;f<a.transform.children.length;f++){var g=a.transform.children[f].gameObject;this.addGameObject(g)}},e.removeGameObject=function(a){if(0!==a.transform.children.length)for(var b=0;b<a.transform.children.length;b++){var c=a.transform.children[b].gameObject;this.removeGameObject(c)}this.removeQueue.push(a),this.removeQueueWaiting=!0},e.retrieve=function(a){if(null!==this.octree){for(var b=this.octree.retrieve(a.item),c=0;c<b.length;c++){var d=b[c];b[c]=d.gameObject}return b}return this.gameObjects},e.run=function(){this.awake(),this.start()},e.awake=function(){for(var a=0;a<this.gameObjectsCount;a++)this.gameObjects[a].awake();this._awaken=!0},e.start=function(){for(var a=0;a<this.gameObjectsCount;a++)this.gameObjects[a].start();this._started=!0},e.tick=function(a){var b,c=this.gameObjectsCount,d=this.gameObjects;for(b=0;b<c;b++)d[b].tick(a);if(this.removeQueueWaiting){var e,c=this.removeQueue.length;for(b=0;b<c;b++)e=this.removeQueue.pop(),e.transform.destroy(),this.gameObjects.splice(this.gameObjects.indexOf(e),1),this.gameObjectsCount--,null!==this.octree&&this.octree.remove(e.item);this.removeQueueWaiting=!1}},e.findByName=function(a){var b,c,d=[],e=this.gameObjects,f=this.gameObjectsCount;for(c=0;c<f;c++)b=e[c],b.name===a&&d.push(b);return 1===d.length?d[0]:d.length>1&&d},b}),define("engine/game",["require","namespace","./graphics","./time","./world"],function(a){function b(){this.scene=new f(this),this.graphics=new d(this),this.time=new e,this.logic={world:this.scene};var a=this,b=this.time,c=this.scene,g=this.graphics;this.tick=function(){requestAnimFrame(a.tick),b.tick(),c.tick(b),g.render()}}var c=a("namespace"),d=a("./graphics"),e=a("./time"),f=a("./world");c("Isometrica.Engine").Game=b;var g=b.prototype;return g.time=null,g.scene=null,g.graphics=null,g.run=function(){this.scene.run(),this.graphics.start(),this.tick()},b}),define("engine/gameobject",["require","./components/transformcomponent","namespace"],function(a){function b(a,b){a.instanceId=c.prototype.instanceId++,a.components=[],a.transform=a.addComponent(new d),a.removeQueue=[],a.name=b||"gameObject"}function c(a){b(this,a)}var d=a("./components/transformcomponent");a("namespace")("Isometrica.Engine").GameObject=c,c.init=b;var e=c.prototype;return e.hasUpdatableComponents=function(){var a,b=this.components,c=this.componentsCount;for(a=0;a<c;a++)if(null!==b[a].tick)return!0;return!1},e.getUpdatableComponents=function(){var a,b,c=this.components,d=this.componentsCount,e=[];for(b=0;b<d;b++)a=c[b],null!==a.tick&&e.push[a];return e},e.updateSubscription=function(){this.world&&(this.hasUpdatableComponents()?this.world.addEventListener(this.world.events.update,this.update):this.world.removeEventListener(this.world.events.update,this.update))},e.instanceId=0,e._awaken=!1,e._started=!1,e.name=null,e.layer=0,e.world=null,e.transform=null,e.components=null,e.componentsCount=0,e.removeQueue=null,e.removeQueueWaiting=!1,e.awake=function(){var a,b;for(b=0;b<this.componentsCount;b++)a=this.components[b],null!==a.awake&&a.awake();this._awaken=!0},e.start=function(){var a,b;for(b=0;b<this.componentsCount;b++)a=this.components[b],null!==a.start&&a.start();this._started=!0},e.setWorld=function(a){this.world=a},e.addComponent=function(a){return this.components[this.componentsCount++]=a,a.setGameObject(this),this._started&&null!==a.start&&a.start(),a},e.removeComponent=function(a){a.unsetGameObject(),this.removeQueue.push(a),this.removeQueueWaiting=!0},e.getComponent=function(a){for(var b=0;b<this.components.length;b++){var c=this.components[b];if(c instanceof a)return c}return null},e.tick=function(a){var b,c,d=this.components,e=this.componentsCount;for(c=0;c<e;c++)b=d[c],null!==b.tick&&b.tick(a);if(this.removeQueueWaiting){var e=this.removeQueue.length;for(c=0;c<e;c++)this.components.splice(this.components.indexOf(this.removeQueue.pop()),1),this.componentsCount--;this.removeQueueWaiting=!1}},e.destroy=function(){this.world.removeGameObject(this),this.world=null},c}),define("engine/lib/boundingbox",[],function(){function a(a,b,c){void 0!==a?(this.min=a,this.max=b):(this.min=[0,0,0],this.max=[0,0,0]),this.center=void 0!==c?c:[0,0,0],this.calculateCenter()}return a.prototype.min=null,a.prototype.max=null,a.prototype.center=null,a.prototype.calculateCenter=function(){var a=this.center,b=this.min,c=this.max;a[0]=b[0]+(c[0]-b[0])/2,a[1]=b[1]+(c[1]-b[1])/2,a[2]=b[2]+(c[2]-b[2])/2},a.prototype.setMinMax=function(a,b,c,d,e,f){var g=this.min,h=this.max;g[0]=a,g[1]=b,g[2]=c,h[0]=d,h[1]=e,h[2]=f,this.calculateCenter()},a.prototype.Calculate=function(a){var b,c,d=a[0][0],e=a[0][0],f=a[0][1],g=a[0][1],h=a[0][2],i=a[0][2],j=a.length;for(c=1;c<j;c++)b=a[c],b[0]>d?d=b[0]:b[0]<e&&(e=b[0]),b[1]>f?f=b[1]:b[1]<g&&(g=b[1]),b[2]>h?h=b[2]:b[2]<i&&(i=b[2]);return this.center[0]=e+(d-e)/2,this.center[1]=g+(f-g)/2,this.center[2]=i+(h-i)/2,this.min[0]=e,this.min[1]=g,this.min[2]=i,this.max[0]=d,this.max[1]=f,this.max[2]=h,this},a.prototype.Intersects=function(a){return!(this.min[0]>a.max[0]||this.max[0]<a.min[0]||this.min[1]>a.max[1]||this.max[1]<a.min[1]||this.min[2]>a.max[2]||this.max[2]<a.min[2])},a.prototype.Contains=function(a){return a.min[0]>=this.min[0]&&a.max[0]<=this.max[0]&&a.min[1]>=this.min[1]&&a.max[1]<=this.max[1]&&a.min[2]>=this.min[2]&&a.max[2]<=this.max[2]},a.prototype.ContainsPoint=function(a){return a[0]>=this.min[0]&&a[0]<=this.max[0]&&a[1]>=this.min[1]&&a[1]<=this.max[1]&&a[2]>=this.min[2]&&a[2]<=this.max[2]},a}),define("engine/lib/aabb",[],function(){function a(a,b){this.center=a||[0,0,0],this.extents=b||[0,0,0],this.min=[],this.max=[],this.calculateMinMax()}return a.prototype.setCenter=function(a,b,c){return this.center[0]=a,this.center[1]=b,this.center[2]=c,this.calculateMinMax(),this},a.prototype.setExtents=function(a,b,c){return this.extents[0]=a,this.extents[1]=b,this.extents[2]=c,this.calculateMinMax(),this},a.prototype.calculateMinMax=function(){var a=this.center,b=this.extents,c=this.min,d=this.max;c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],d[0]=a[0]+b[0],d[1]=a[1]+b[1],d[2]=a[2]+b[2]},a.prototype.Calculate=function(a){var b,c,d=a[0][0],e=a[0][0],f=a[0][1],g=a[0][1],h=a[0][2],i=a[0][2],j=a.length;for(c=1;c<j;c++)b=a[c],b[0]>d?d=b[0]:b[0]<e&&(e=b[0]),b[1]>f?f=b[1]:b[1]<g&&(g=b[1]),b[2]>h?h=b[2]:b[2]<i&&(i=b[2]);return this.center[0]=e+(d-e)/2,this.center[1]=g+(f-g)/2,this.center[2]=i+(h-i)/2,this.min[0]=e,this.min[1]=g,this.min[2]=i,this.max[0]=d,this.max[1]=f,this.max[2]=h,this.extents[0]=(d-e)/2,this.extents[1]=(f-g)/2,this.extents[2]=(h-i)/2,this},a.prototype.Intersects=function(a){return!(this.min[0]>a.max[0]||this.max[0]<a.min[0]||this.min[1]>a.max[1]||this.max[1]<a.min[1]||this.min[2]>a.max[2]||this.max[2]<a.min[2])},a.prototype.Contains=function(a){return a.min[0]>=this.min[0]&&a.max[0]<=this.max[0]&&a.min[1]>=this.min[1]&&a.max[1]<=this.max[1]&&a.min[2]>=this.min[2]&&a.max[2]<=this.max[2]},a.prototype.ContainsPoint=function(a){return a[0]>=this.min[0]&&a[0]<=this.max[0]&&a[1]>=this.min[1]&&a[1]<=this.max[1]&&a[2]>=this.min[2]&&a[2]<=this.max[2]},a}),define("engine/components/cameracomponent",["require","namespace","../component","../lib/boundingbox","../lib/aabb","../vendor/gl-matrix","events"],function(a){function b(){d.call(this),this.projectionMatrix=new Float32Array(16),this.frustumSize=[[0,0,0],[0,0,0]],this.frustumBox=[[0,0,0],[0,0,0]],this.bounds=new e,this.aabb=new f,this.worldToScreenMatrix=new Float32Array(16),this.worldToViewportMatrix=new Float32Array(16);var a=this;this.transformUpdateEventHandler=function(b){var c=b.getLocalToWorld();g.vec3.transformMat4(a.frustumBox[0],a.frustumSize[0],c),g.vec3.transformMat4(a.frustumBox[1],a.frustumSize[1],c),g.mat4.mul(a.worldToViewportMatrix,a.projectionMatrix,b.getWorldToLocal()),a.bounds.Calculate(a.frustumBox),a.dispatchEvent(a.events.update)},this.viewportResizeEventHandler=function(b,c){a.setup(b.width,b.height,100),g.mat4.mul(a.worldToViewportMatrix,a.projectionMatrix,a.gameObject.transform.getWorldToLocal())}}var c=a("namespace"),d=a("../component"),e=a("../lib/boundingbox"),f=a("../lib/aabb"),g=a("../vendor/gl-matrix"),h=a("events");c("Isometrica.Engine").CameraComponent=b;var i=new Float32Array(3);return b.prototype=Object.create(d.prototype),b.prototype.constructor=b,b.prototype.events={update:0,viewportSet:1,viewportRemoved:2},b.prototype.viewport=null,b.prototype.bounds=null,b.prototype.frustumSize=null,b.prototype.frustumBox=null,b.prototype.projectionMatrix=null,b.prototype.worldToScreenMatrix=null,b.prototype.worldToViewportMatrix=null,b.prototype.setup=function(a,b,c){this.frustumSize=[[-a/2,-b/2,0],[a/2,b/2,c]];var d=this.gameObject.transform.getLocalToWorld();g.vec3.transformMat4(this.frustumBox[0],this.frustumSize[0],d),g.vec3.transformMat4(this.frustumBox[1],this.frustumSize[1],d),g.mat4.ortho(this.projectionMatrix,-a/2,a/2,-b/2,b/2,0,c),this.bounds.Calculate(this.frustumBox)},b.prototype.setViewport=function(a){this.viewport=a,this.setup(a.width,a.height,100),h.on(this.viewport,this.viewport.events.resize,this.viewportResizeEventHandler),this.dispatchEvent(this.events.viewportSet,this)},b.prototype.removeViewport=function(){this.dispatchEvent(this.events.viewportRemoved,this),this.viewport=null},b.prototype.setGameObject=function(a){d.prototype.setGameObject.call(this,a),a.camera=this,a.transform.addEventListener(a.transform.events.update,this.transformUpdateEventHandler)},b.prototype.unsetGameObject=function(){this.gameObject.camera=void 0,this.gameObject.transform.removeEventListener(this.gameObject.transform.events.update,this.transformUpdateEventHandler),d.prototype.unsetGameObject.call(this)},b.prototype.getWorldToScreen=function(){return g.mat4.mul(this.worldToScreenMatrix,this.viewport.viewportMatrix,this.worldToViewportMatrix)},b.prototype.getWorldToViewport=function(){return this.worldToViewportMatrix},b.prototype.getScreenToWorld=function(){throw"CameraComponent.getScreenToWorld: not implemented"},b.prototype.getVisibleGameObjects=function(){for(var a,b=[],c=this.gameObject.world.retrieve(this.gameObject),d=null,e=c.length,f=this.getWorldToViewport(),h=g.vec3,j=0;j<e;j++)d=c[j],null!==d.renderer&&(d.transform.getPosition(i),a=h.transformMat4(i,i,f),a[0]>=-1&&a[0]<1&&a[1]>=-1&&a[1]<1&&b.push(d));return b},b}),define("engine/gameObjects/camera",["require","namespace","../gameobject","../components/cameracomponent"],function(a){function b(a){d.call(this,a||"camera"),this.addComponent(new e)}var c=a("namespace"),d=a("../gameobject"),e=a("../components/cameracomponent");return c("Isometrica.Engine").Camera=b,b.prototype=Object.create(d.prototype),b}),define("engine/components/renderer",["require","namespace","./../component","../vendor/gl-matrix"],function(a){function b(){d.call(this)}var c=a("namespace"),d=a("./../component"),e=new Float32Array(3),f=a("../vendor/gl-matrix"),g=f.vec3;return c("Isometrica.Engine").Renderer=b,b.prototype=Object.create(d.prototype),b.prototype.cullingTest=function(a,b){return this.gameObject.transform.getPosition(e),g.transformMat4(e,e,b.V),e[0]<=1&&e[0]>=-1&&e[1]<=1&&e[1]>=-1},b.prototype.render=function(a,b,c){this.gameObject.transform.getPosition(e),g.transformMat4(e,e,b.V),f.vec3.transformMat4(e,this.gameObject.transform.getPosition(e),b.M),a.font="normal 12px arial",a.fillStyle="red",a.textAlign="center",a.textBaseline="middle",a.fillText("EMPTY RENDERER",e[0],e[1])},b.prototype.layer=0,b.prototype.setGameObject=function(a){d.prototype.setGameObject.call(this,a),a.renderer=this},b.prototype.unsetGameObject=function(){this.gameObject.renderer=null,d.prototype.unsetGameObject.call(this)},b}),define("engine/components/spriterenderer",["require","namespace","./renderer","./transformcomponent","../vendor/gl-matrix"],function(a){function b(a){d.call(this),this.events={ready:0},this.buf=new Float32Array(3),this.enabled=!1,this.t=g.transformMat4}var c=a("namespace"),d=(new Float32Array(3),a("./renderer")),e=a("./transformcomponent"),f=a("../vendor/gl-matrix"),g=f.vec3;c("Isometrica.Engine").SpriteRenderer=b;var h=b.prototype=Object.create(d.prototype);h.constructor=b,h.sprite=null,h.pivotX=0,h.pivotY=0,h.layer=0,h.setGameObject=function(a){d.prototype.setGameObject.call(this,a),a.spriteRenderer=this,a.renderer=this,this.opacity=1},h.setSprite=function(a){return this.sprite=a,this.enabled=!0,this},h.setPivot=function(a,b){return this.pivotX=a,this.pivotY=b,this},h.unsetGameObject=function(){this.gameObject.spriteRenderer=void 0,this.gameObject.renderer=null,d.prototype.unsetGameObject.call(this)};var i=e.getPosition;h.cullingTest=function(a,b,c){var d=c.buf;i(c.gameObject.transform,d),g.transformMat4(d,d,b.M);var e=c.sprite,f=d[0]-c.pivotX|0,h=d[1]-c.pivotY|0;return f<=a.width&&f+e.width>=0&&h<=a.height&&h+e.height>=0};var j=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12],a[1]=c[1]*d+c[5]*e+c[9]*f+c[13],a};return h.render=function(a,b,c,d){var e=d.buf;i(d.gameObject.transform,e),j(e,e,b.M);var f=d.sprite,g=f.width,h=f.height;1!==d.opacity?(a.save(),a.globalAlpha=d.opacity,a.drawImage(f.sourceImage,f.offsetX,f.offsetY,g,h,e[0]-d.pivotX|0,e[1]-d.pivotY|0,g,h),a.restore()):a.drawImage(f.sourceImage,f.offsetX,f.offsetY,g,h,e[0]-d.pivotX|0,e[1]-d.pivotY|0,g,h)},b}),define("engine/lib/assetmanager/resource",["require","events"],function(a){function b(a,b){c.call(this),this.state=e.none,this.type=b||d.blob,this.path=a,this.data=null;var f=this;this.onProgress=function(a){f.dispatchEvent(f.events.progress,a)},this.onLoad=function(a){var b,a=a.target;if(200===a.status){if(f.type===d.image)return b=new Image,b.addEventListener("load",function(){f.data=b,f.state=e.ready,f.dispatchEvent(f.events.done,f)}),void(b.src=f.path);if(f.type===d.audio)return b=new Audio,b.addEventListener("canplaythrough",function(){f.data=b,f.state=e.ready,f.dispatchEvent(f.events.done,f)}),void b.setAttribute("src",f.path);f.type===d.blob?b=a.response:f.type===d.json?b=JSON.parse(a.response):f.type===d.text&&(b=a.response),f.data=b,f.state=e.ready,f.dispatchEvent(f.events.done,f)}else f.data=b,f.state=e.failed,f.dispatchEvent(f.events.done,f)},this.load()}var c=a("events"),d={blob:0,image:1,audio:2,json:3,text:4},e={none:0,loading:1,ready:2,failed:3};return b.prototype=Object.create(c.prototype),b.prototype.constructor=b,b.prototype.events={done:0,progress:1},b.prototype.done=function(a){return this.state===e.ready?a(this):this.state!==e.loading&&this.state!==e.none||this.addEventListener(this.events.done,a),this},b.prototype.progress=function(a){return this.state!==e.loading&&this.state!==e.none||this.addEventListener(this.events.progress,a),this},b.prototype.load=function(){if(this.state!==e.loading&&this.state!==e.ready){this.state=e.loading;var a=new XMLHttpRequest;return a.open("GET",this.path,!0),a.responseType=this.type===d.json||this.type===d.text?"text":"blob",a.addEventListener("progress",this.onProgress),a.addEventListener("load",this.onLoad),a.send(),a}},b.ResourceTypeEnum=d,b.ResourceStateEnum=e,b}),define("engine/lib/assetmanager/assetmanager",["require","namespace","./resource"],function(a){function b(){this.assets={}}var c=a("namespace"),d=a("./resource");return c("Isometrica.Engine").AssetManager=b,b.prototype.assets=null,b.prototype.getAsset=function(a,c){return void 0!==this.assets[a]?this.assets[a]:c===d.ResourceTypeEnum.audio?new b.Resource(a,c):this.assets[a]=new b.Resource(a,c)},b.prototype.releaseAsset=function(a){void 0!==this.assets[a]&&delete this.assets[a]},b.Resource=d,b}),define("engine/spritemanager",["require","namespace"],function(a){function b(a){this.assets=a,this.frames={}}return a("namespace")("Isometrica.Engine").SpriteManager=b,b.Sprite=function(){this.offsetX=0,this.offsetY=0,
this.width=0,this.height=0},b.Sprite.prototype.sourceImage=new Image,b.prototype.getSprite=function(a){var c=new b.Sprite;if(void 0!==this.frames[a]){var d=this.frames[a];c.sourceImage=this.atlas,c.width=d.frame.w,c.height=d.frame.h,c.offsetX=d.frame.x,c.offsetY=d.frame.y}else this.assets.getAsset("client/assets/"+a,this.assets.constructor.Resource.ResourceTypeEnum.image).done(function(a){c.sourceImage=a.data,c.width=a.data.width,c.height=a.data.height});return c},b}),define("engine/components/textrenderer",["require","namespace","./renderer","../vendor/gl-matrix"],function(a){function b(){e.call(this)}var c=a("namespace"),d=new Float32Array(3),e=a("./renderer"),f=a("../vendor/gl-matrix");c("Isometrica.Engine").TextRenderer=b;var g=b.prototype=Object.create(e.prototype);return g.constructor=b,g.text="sample text",g.color="white",g.style="normal 12px arial",g.layer=0,g.align="center",g.valign="middle",g.setGameObject=function(a){e.prototype.setGameObject.call(this,a),a.textRenderer=this,a.renderer=this},g.unsetGameObject=function(){this.gameObject.textRenderer=void 0,this.gameObject.renderer=null,e.prototype.unsetGameObject.call(this)},g.render=function(a,b){f.vec3.transformMat4(d,this.gameObject.transform.getPosition(d),b.M),a.font=this.style,a.fillStyle=this.color,a.textAlign=this.align,a.textBaseline=this.valign,a.fillText(this.text,d[0],d[1])},b}),define("engine/components/animatedspriterenderer",["require","namespace","./spriterenderer"],function(a){function b(a){d.call(this),this.frames=[]}var c=a("namespace"),d=a("./spriterenderer");c("Isometrica.Engine").AnimatedSpriteRenderer=b;var e=b.prototype=Object.create(d.prototype);return e.constructor=b,e.frames=null,e.currentFrame=0,e.speed=1,e.addFrame=function(a){this.frames.push(a)},e.setAnimationSpeed=function(a){this.speed=a},e.tick=function(){if(null!==this.frames&&this.frames.length>0){var a=this.currentFrame+1;a>=this.frames.length&&(a=0),this.currentFrame=a,this.setSprite(this.frames[a])}},b}),define("engine/coroutine",["require","namespace"],function(a){var b=a("namespace"),c=b("Isometrica.Engine.Coroutine"),d=0,e={};return c.startCoroutine=function(a){var b=d++,c=Array.prototype.slice.call(arguments,1),f=function(){var d=a.apply(this,c);d>=0&&(e[b]=setTimeout(f,d))};return f(),b},c.stopCoroutine=function(a){clearTimeout(e[a]),delete e[a]},c}),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame}(),define("engine/main",["require","namespace","./config","./game","./gameobject","./component","./gameObjects/camera","./components/cameracomponent","./components/transformcomponent","./components/spriterenderer","./lib/assetmanager/assetmanager","./spritemanager","./components/textrenderer","./components/animatedspriterenderer","./components/renderer","./coroutine"],function(a){var b=a("namespace");a("./config"),a("./game"),a("./gameobject"),a("./component"),a("./gameObjects/camera"),a("./components/cameracomponent"),a("./components/transformcomponent"),a("./components/spriterenderer"),a("./lib/assetmanager/assetmanager"),a("./spritemanager"),a("./components/textrenderer"),a("./components/animatedspriterenderer"),a("./components/renderer"),a("./coroutine");return b("Isometrica.Engine")}),define("data/buildingcode",[],function(){return{tree1:0,tree2:1,cityHall:3,road:4,farm:5,windTurbine:8,smallCoalPlant:9,waterTower:10,waterPump:11,smallMarket:12,cliff:14,house0:15,house1:16,house2:17,house3:18,house4:19,house5:20,lumberMill:6,oilWell:13,stoneQuarry:22,ironMine:25}}),define("data/classcode",["require","namespace"],function(a){return a("namespace")("Isometrica.Core").BuildingClassCode={municipal:0,road:1,tree:2,house:3,industry:4,commerce:5}}),define("core/researchdirection",["require"],function(a){return{municipal:0,housing:1,commerce:2,industry:3}}),define("core/researchstate",{unavailable:0,available:1,running:2,finished:3}),define("client/renderlayer",{groundLayer:0,groundDrawLayer:1,roadLayer:2,vehiclesLayer:3,buildingsLayer:4,overlayLayer:5}),define("core/gatherreq",[],function(){return{none:"none",nearWater:"waterTile",nearTree:"tree",inGrassLand:"grassLand",inDesert:"desert"}}),define("core/resourcecode",["require","namespace"],function(a){return a("namespace")("Isometrica.Core").ResourceCode={money:"money",food:"food",water:"water",electricity:"electricity",wood:"wood",stone:"stone",iron:"iron",oil:"oil",glass:"glass"}}),define("core/buildingpositioning",["require"],function(a){return{flat:0,resource:1}}),define("data/buildings",["require","namespace","data/buildingcode","./classcode","core/researchdirection","core/researchstate","client/renderlayer","core/gatherreq","core/resourcecode","core/buildingpositioning"],function(a){var b=a("namespace"),c=a("data/buildingcode"),d=a("./classcode"),e=a("core/researchdirection"),f=a("core/researchstate"),g=a("client/renderlayer"),h=a("core/gatherreq"),i=a("core/resourcecode"),j=a("core/buildingpositioning"),k=b("Isometrica.Core"),l=k.BuildingData={};return l[c.tree1]={sizeX:1,sizeY:1,buildingCode:c.tree1,classCode:d.tree,producing:{},demanding:{},constructionTime:0,constructionCost:{},name:"tree",sprites:[{x:0,y:0,z:0,pivotX:34,pivotY:53,path:"tree1.png",layer:g.buildingsLayer}]},l[c.tree2]={sizeX:1,sizeY:1,buildingCode:c.tree2,classCode:d.tree,producing:{},demanding:{},constructionTime:0,constructionCost:{},name:"tree",sprites:[{x:0,y:0,z:0,pivotX:34,pivotY:53,path:"tree2.png",layer:g.buildingsLayer}]},l[c.cliff]={sizeX:1,sizeY:1,buildingCode:c.cliff,classCode:d.tree,producing:{},demanding:{},constructionTime:0,constructionCost:{},researchState:f.available,researchTime:0,researchCost:{},name:"cliff",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:24,path:"cliff.png",layer:g.buildingsLayer}]},l[c.road]={size:17,sizeX:1,sizeY:1,buildingCode:c.road,classCode:d.road,producing:{},demanding:{},constructionTime:0,constructionCost:{stone:1,money:1},name:"road",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:24,path:"road/x1.png",layer:g.roadLayer}],roadGates:[[1,0],[0,-1],[-1,0],[0,1]],waypoints:{},tileEffect:{eco:-1,crime:1},tileEffectRadius:1},l[c.house0]={sizeX:1,sizeY:1,buildingCode:c.house0,classCode:d.house,producing:{stone:1,wood:1,iron:1},demanding:{water:1},citizenCapacity:1,constructionTime:3e3,constructionCost:{stone:8,wood:8},name:"mobile house",canRotate:!0,sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:23,path:"buildings/house0.png",layer:g.buildingsLayer}],spritesRotate:[{x:0,y:0,z:0,pivotX:32,pivotY:23,path:"buildings/house0r.png",layer:g.buildingsLayer}],roadGates:[[-1,0]],tileEffect:{eco:-10,crime:1},tileEffectRadius:2},l[c.house1]={sizeX:1,sizeY:1,buildingCode:c.house1,classCode:d.house,producing:{},demanding:{},citizenCapacity:1,constructionTime:3e3,constructionCost:{stone:10,wood:10,money:10},researchLevel:1,researchDirection:e.housing,name:"tiny house",sprites:[{x:0,y:0,z:0,pivotX:27,pivotY:23,path:"buildings/house1.png",layer:g.buildingsLayer}]},l[c.house2]={sizeX:1,sizeY:2,buildingCode:c.house2,classCode:d.house,producing:{money:5},demanding:{food:5,electricity:1,water:1},citizenCapacity:3,constructionTime:3e3,constructionCost:{money:1e3,wood:100,stone:100,iron:100},name:"small residential house",canRotate:!0,sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:31,path:"buildings/house2-2.png",layer:g.buildingsLayer},{x:0,y:0,z:1,pivotX:32,pivotY:26,path:"buildings/house2-1.png",layer:g.buildingsLayer}],spritesRotate:[{x:0,y:0,z:0,pivotX:32,pivotY:31,path:"buildings/house2r-2.png",layer:g.buildingsLayer},{x:1,y:0,z:0,pivotX:32,pivotY:26,path:"buildings/house2r-1.png",layer:g.buildingsLayer}]},l[c.house3]={sizeX:2,sizeY:1,buildingCode:c.house3,classCode:d.house,producing:{money:10},demanding:{food:10,electricity:2,water:2},constructionTime:5e3,constructionCost:{money:1500,wood:150,stone:50,iron:150},name:"cottage house",citizenCapacity:4,sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:19,path:"buildings/house3-1.png",layer:g.buildingsLayer},{x:1,y:0,z:0,pivotX:32,pivotY:40,path:"buildings/house3-2.png",layer:g.buildingsLayer}],smokeSource:[1.25,2.5,.85]},l[c.house4]={sizeX:1,sizeY:2,buildingCode:c.house4,classCode:d.house,producing:{money:10},demanding:{food:10,electricity:2,water:2},citizenCapacity:4,constructionTime:5e3,constructionCost:{money:1500,wood:50,stone:150,iron:150},name:"two story house",citizenCapacity:6,sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:28,path:"buildings/house4-1.png",layer:g.buildingsLayer},{x:0,y:0,z:1,pivotX:32,pivotY:41,path:"buildings/house4-2.png",layer:g.buildingsLayer}],smokeSource:[.75,3.5,1.25]},l[c.house5]={sizeX:2,sizeY:1,buildingCode:c.house5,classCode:d.house,producing:{money:10},demanding:{food:10,electricity:2,water:2},citizenCapacity:6,constructionTime:5e3,constructionCost:{money:1500,wood:50,stone:150,iron:150},name:"house",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:35,path:"buildings/house5-1.png",layer:g.buildingsLayer},{x:1,y:0,z:0,pivotX:32,pivotY:31,path:"buildings/house5-2.png",layer:g.buildingsLayer}]},l[c.cityHall]={sizeX:1,sizeY:1,buildingCode:c.cityHall,classCode:d.municipal,producing:{money:1,food:3,stone:1,wood:1},demanding:{},constructionTime:3e3,constructionCost:{stone:20,wood:20},name:"city hall",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:46,path:"buildings/cityhall.png",layer:g.buildingsLayer}]},l[c.farm]={sizeX:1,sizeY:1,buildingCode:c.farm,classCode:d.industry,producing:{},demanding:{},constructionTime:3e3,constructionCost:{},name:"farm",requirement:h.inGrassLand,sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:30,path:"buildings/testbuilding0.png",layer:g.buildingsLayer}]},l[c.windTurbine]={sizeX:3,sizeY:3,buildingCode:c.windTurbine,classCode:d.municipal,producing:{electricity:5},demanding:{money:1},constructionTime:5e3,constructionCost:{money:50,iron:50},name:"wind turbine",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:30,path:"buildings/testbuilding0.png",layer:g.buildingsLayer}]},l[c.waterTower]={sizeX:1,sizeY:1,buildingCode:c.waterTower,classCode:d.municipal,producing:{water:5},demanding:{money:1},constructionTime:1e4,constructionCost:{money:50,stone:50},name:"water tower",sprites:[{x:0,y:0,z:0,pivotX:18,pivotY:64,path:"buildings/watertower.png",layer:g.buildingsLayer}]},l[c.waterPump]={sizeX:1,sizeY:1,buildingCode:c.waterPump,classCode:d.municipal,producing:{water:15},demanding:{money:2},constructionTime:1e4,constructionCost:{money:100,stone:40,iron:40},name:"water pump station",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:30,path:"buildings/testbuilding0.png",layer:g.buildingsLayer}]},l[c.smallMarket]={sizeX:1,sizeY:1,buildingCode:c.smallMarket,classCode:d.commerce,producing:{money:100},demanding:{},constructionTime:1e4,constructionCost:{money:50},name:"small market",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:30,path:"buildings/testbuilding0.png",layer:g.buildingsLayer}]},l[c.lumberMill]={sizeX:1,sizeY:1,buildingCode:c.lumberMill,classCode:d.industry,producing:{wood:5},demanding:{},constructionTime:3e3,constructionCost:{money:100},name:"lumber mill",requirement:h.nearTree,sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:30,path:"buildings/testbuilding0.png",layer:g.buildingsLayer}]},l[c.oilWell]={sizeX:1,sizeY:1,buildingCode:c.oilWell,classCode:d.industry,positioning:j.resource,resource:i.oil,producing:{oil:5},demanding:{},constructionTime:1e4,constructionCost:{money:100},requirement:h.oilTile,name:"oil rig",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:30,path:"buildings/testbuilding0.png",layer:g.buildingsLayer}]},l[c.stoneQuarry]={sizeX:1,sizeY:1,buildingCode:c.stoneQuarry,classCode:d.industry,positioning:j.resource,resource:i.stone,producing:{stone:5},demanding:{},constructionTime:5e3,constructionCost:{money:100},requirement:h.stoneTile,name:"stone quarry",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:30,path:"buildings/testbuilding0.png",layer:g.buildingsLayer}]},l[c.ironMine]={sizeX:1,sizeY:1,positioning:j.resource,resource:i.iron,buildingCode:c.ironMine,classCode:d.industry,producing:{iron:5},demanding:{},constructionTime:5e3,constructionCost:{money:100},requirement:h.ironTile,name:"iron mine",sprites:[{x:0,y:0,z:0,pivotX:32,pivotY:26,path:"buildings/testbuilding1.png",layer:g.buildingsLayer}]},l}),define("data/classes",["require","data/classcode"],function(a){var b=a("data/classcode"),c={};return c[b.municipal]={hidden:!1,name:"municipal"},c[b.road]={hidden:!0,name:"road"},c[b.tree]={hidden:!0,name:"tree"},c[b.house]={hidden:!1,name:"house"},c[b.industry]={hidden:!1,name:"industry"},c[b.commerce]={hidden:!1,name:"commerce"},c}),define("core/terraintype",["require","namespace"],function(a){var b=a("namespace"),c=b("Isometrica.Core"),d={water:0,grass:1,shore:2};return c.TerrainType=d,d}),define("vendor/simplex-noise",[],function(){function a(a){if(this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512),"object"==typeof a&&256==a.length)this.p=new Uint8Array(a);else{a||(a=Math.random);for(var b=0;b<256;b++)this.p[b]=256*a()}for(b=0;b<512;b++)this.perm[b]=this.p[255&b],this.permMod12[b]=this.perm[b]%12}var b=.5*(Math.sqrt(3)-1),c=(3-Math.sqrt(3))/6,d=1/3,e=1/6,f=(Math.sqrt(5)-1)/4,g=(5-Math.sqrt(5))/20;return a.prototype={grad3:new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),grad4:new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),noise2D:function(a,d){var e,f,g=this.permMod12,h=this.perm,i=this.grad3,j=0,k=0,l=0,m=(a+d)*b,n=Math.floor(a+m),o=Math.floor(d+m),p=(n+o)*c,q=n-p,r=o-p,s=a-q,t=d-r;s>t?(e=1,f=0):(e=0,f=1);var u=s-e+c,v=t-f+c,w=s-1+2*c,x=t-1+2*c,y=255&n,z=255&o,A=.5-s*s-t*t;if(A>=0){var B=3*g[y+h[z]];A*=A,j=A*A*(i[B]*s+i[B+1]*t)}var C=.5-u*u-v*v;if(C>=0){var D=3*g[y+e+h[z+f]];C*=C,k=C*C*(i[D]*u+i[D+1]*v)}var E=.5-w*w-x*x;if(E>=0){var F=3*g[y+1+h[z+1]];E*=E,l=E*E*(i[F]*w+i[F+1]*x)}return 70*(j+k+l)},noise3D:function(a,b,c){var f,g,h,i,j,k,l,m,n,o,p=this.permMod12,q=this.perm,r=this.grad3,s=(a+b+c)*d,t=Math.floor(a+s),u=Math.floor(b+s),v=Math.floor(c+s),w=(t+u+v)*e,x=t-w,y=u-w,z=v-w,A=a-x,B=b-y,C=c-z;A>=B?B>=C?(j=1,k=0,l=0,m=1,n=1,o=0):A>=C?(j=1,k=0,l=0,m=1,n=0,o=1):(j=0,k=0,l=1,m=1,n=0,o=1):B<C?(j=0,k=0,l=1,m=0,n=1,o=1):A<C?(j=0,k=1,l=0,m=0,n=1,o=1):(j=0,k=1,l=0,m=1,n=1,o=0);var D=A-j+e,E=B-k+e,F=C-l+e,G=A-m+2*e,H=B-n+2*e,I=C-o+2*e,J=A-1+3*e,K=B-1+3*e,L=C-1+3*e,M=255&t,N=255&u,O=255&v,P=.6-A*A-B*B-C*C;if(P<0)f=0;else{var Q=3*p[M+q[N+q[O]]];P*=P,f=P*P*(r[Q]*A+r[Q+1]*B+r[Q+2]*C)}var R=.6-D*D-E*E-F*F;if(R<0)g=0;else{var S=3*p[M+j+q[N+k+q[O+l]]];R*=R,g=R*R*(r[S]*D+r[S+1]*E+r[S+2]*F)}var T=.6-G*G-H*H-I*I;if(T<0)h=0;else{var U=3*p[M+m+q[N+n+q[O+o]]];T*=T,h=T*T*(r[U]*G+r[U+1]*H+r[U+2]*I)}var V=.6-J*J-K*K-L*L;if(V<0)i=0;else{var W=3*p[M+1+q[N+1+q[O+1]]];V*=V,i=V*V*(r[W]*J+r[W+1]*K+r[W+2]*L)}return 32*(f+g+h+i)},noise4D:function(a,b,c,d){var e,h,i,j,k,l=(this.permMod12,this.perm),m=this.grad4,n=(a+b+c+d)*f,o=Math.floor(a+n),p=Math.floor(b+n),q=Math.floor(c+n),r=Math.floor(d+n),s=(o+p+q+r)*g,t=o-s,u=p-s,v=q-s,w=r-s,x=a-t,y=b-u,z=c-v,A=d-w,B=0,C=0,D=0,E=0;x>y?B++:C++,x>z?B++:D++,x>A?B++:E++,y>z?C++:D++,y>A?C++:E++,z>A?D++:E++;var F,G,H,I,J,K,L,M,N,O,P,Q;F=B>=3?1:0,G=C>=3?1:0,H=D>=3?1:0,I=E>=3?1:0,J=B>=2?1:0,K=C>=2?1:0,L=D>=2?1:0,M=E>=2?1:0,N=B>=1?1:0,O=C>=1?1:0,P=D>=1?1:0,Q=E>=1?1:0;var R=x-F+g,S=y-G+g,T=z-H+g,U=A-I+g,V=x-J+2*g,W=y-K+2*g,X=z-L+2*g,Y=A-M+2*g,Z=x-N+3*g,$=y-O+3*g,_=z-P+3*g,aa=A-Q+3*g,ba=x-1+4*g,ca=y-1+4*g,da=z-1+4*g,ea=A-1+4*g,fa=255&o,ga=255&p,ha=255&q,ia=255&r,ja=.6-x*x-y*y-z*z-A*A;if(ja<0)e=0;else{var ka=l[fa+l[ga+l[ha+l[ia]]]]%32*4;ja*=ja,e=ja*ja*(m[ka]*x+m[ka+1]*y+m[ka+2]*z+m[ka+3]*A)}var la=.6-R*R-S*S-T*T-U*U;if(la<0)h=0;else{var ma=l[fa+F+l[ga+G+l[ha+H+l[ia+I]]]]%32*4;la*=la,h=la*la*(m[ma]*R+m[ma+1]*S+m[ma+2]*T+m[ma+3]*U)}var na=.6-V*V-W*W-X*X-Y*Y;if(na<0)i=0;else{var oa=l[fa+J+l[ga+K+l[ha+L+l[ia+M]]]]%32*4;na*=na,i=na*na*(m[oa]*V+m[oa+1]*W+m[oa+2]*X+m[oa+3]*Y)}var pa=.6-Z*Z-$*$-_*_-aa*aa;if(pa<0)j=0;else{var qa=l[fa+N+l[ga+O+l[ha+P+l[ia+Q]]]]%32*4;pa*=pa,j=pa*pa*(m[qa]*Z+m[qa+1]*$+m[qa+2]*_+m[qa+3]*aa)}var ra=.6-ba*ba-ca*ca-da*da-ea*ea;if(ra<0)k=0;else{var sa=l[fa+1+l[ga+1+l[ha+1+l[ia+1]]]]%32*4;ra*=ra,k=ra*ra*(m[sa]*ba+m[sa+1]*ca+m[sa+2]*da+m[sa+3]*ea)}return 27*(e+h+i+j+k)}},a}),define("core/terrain",["require","namespace","core/resourcecode","./terraintype","simplex-noise","events"],function(a){function b(a,b){var c;return c=u.noise2D(a/8,b/8),64*(c*=u.noise2D(a/24,b/24))>40}function c(a,b){if(64*u.noise2D(a/64,b/64)>50)return 64*u.noise2D(a/8,b/8)>50}function d(a,b){if(64*u.noise2D(b/64,a/64)>50)return 64*u.noise2D(b/8,a/8)>50}function e(a){var b=0,c=0,d=n.extractX(a),e=n.extractY(a);return d+=640,e+=700,b+=u.noise2D(d/512,e/512)/2,b+=u.noise2D(d/256,e/256)/4,b+=u.noise2D(d/128,e/128)/8,b+=u.noise2D(d/64,e/64)/16,b+=u.noise2D(d/32,e/32)/32,b+=u.noise2D(d/16,e/16)/64,b+=u.noise2D(d/8,e/8)/64,c+=u.noise2D(d/64,e/64)/10,c+=u.noise2D(d/32,e/32)/20,c+=u.noise2D(d/16,e/16)/40,c+=u.noise2D(d/8,e/8)/40,Math.floor(16*(.8*b+.2*c))}function f(a,b,c){var d={};if(g(a,b,c,d)){for(b in d)a.gridPoints[b]=d[b];s.fire(a,t.gridUpdate,d)}}function g(a,b,c,d){d=d||{};var e=j(b,0),f=j(b,1),h=j(b,2),i=j(b,3),k=a.world.buildings;if(null!==k.get(e)||null!==k.get(f)||null!==k.get(h)||null!==k.get(i))return!1;var l=b+1,m=b-1,n=b+C,o=b-C,p=d[l]||a.getGridPointHeight(l),q=d[m]||a.getGridPointHeight(m),r=d[n]||a.getGridPointHeight(n),s=d[o]||a.getGridPointHeight(o),t=!0;return p-c<-1?t=t&&g(a,l,c-1,d):p-c>1&&(t=t&&g(a,l,c+1,d)),q-c<-1?t=t&&g(a,m,c-1,d):q-c>1&&(t=t&&g(a,m,c+1,d)),r-c<-1?t=t&&g(a,n,c-1,d):r-c>1&&(t=t&&g(a,n,c+1,d)),s-c<-1?t=t&&g(a,o,c-1,d):s-c>1&&(t=t&&g(a,o,c+1,d)),t&&(d[b]=c),t}function h(a){return a!==B.FLAT}function i(a){return a===B.AB||a===B.AC||a===B.CD||a===B.BD}function j(a,b){return a-(1&b)-(b>>1&1)*C}function k(a,b){var c=n.extractX(a),d=n.extractX(b),e=n.extractY(a),f=n.extractY(b);return n.convertToIndex(Math.max(c,d),Math.max(e,f))}function l(a,b){var c=n.extractX(a),d=n.extractX(b),e=n.extractY(a),f=n.extractY(b);return n.convertToIndex(Math.min(c,d),Math.min(e,f))}function m(a,b,c){var d=l(a,b),e=k(a,b),f=n.extractX(d),g=n.extractX(e),h=n.extractY(d),i=n.extractY(e),j=n.extractX(c),m=n.extractY(c);return j>=f&&j<=g&&m>=h&&m<=i}function n(a){this.world=a,this.gridPoints=[]}var o=a("namespace"),p=a("core/resourcecode"),q=a("./terraintype"),r=a("simplex-noise"),s=a("events");o("Isometrica.Core").Terrain=n;var t={tileCleared:0,gridUpdate:1},u=new r([151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180]),v=1,w=256,z=65536,A=16777216,B={FLAT:0,A:v,B:w,C:z,D:A,A_STEEP:2|w|z,B_STEEP:512|v|A,C_STEEP:131072|v|A,D_STEEP:33554432|w|z,AB:v|w,AC:v|z,BD:A|w,CD:A|z,AD:v|A,BC:w|z,ABC:v|w|z,ABD:v|w|A,ACD:z|A|v,BCD:z|w|A};n.SlopeType=B,n.convertToIndex=function(a,b){return b<<16^a},n.extractX=function(a){return 65535&a},n.extractY=function(a){return a>>>16};var C=(n.dx=n.convertToIndex(1,0),n.dy=n.convertToIndex(0,1));return n.events=t,n.prototype.edit=function(a,b){return f(this,a,b)},n.prototype.getAreaGrid=function(a,b,c,d){for(var e=[],f=a+c,g=b+d,h=a;h<=f;h++)for(var i=b;i<=g;i++)e.push(this.getGridPointHeight(h,i));return e},n.prototype.getTerrainTypes=function(a,b,c,d){for(var e=[],f=a+c,g=b+d,h=a;h<f;h++)for(var i=b;i<g;i++)e.push(this.getTerrainType(h,i));return e},n.prototype.getGridPointHeight=function(a,b){var c=a,d=a;2===arguments.length&&(c=b<<16^d);var f=this.gridPoints[c];return void 0===f&&(f=e(c)),f},n.prototype.getHeight=function(a,b){var c=a%(0|a),d=b%(0|b);return(this.getGridPointHeight(a,b)*(1-c)+this.getGridPointHeight(a+1,b)*c)*d+(this.getGridPointHeight(a,b+1)*(1-c)+this.getGridPointHeight(a+1,b+1)*c)*(1-d)},n.prototype.getTerrainType=function(a,b){var c,d,e,f,g;if(void 0===a)throw"first argument is mandatory";return c=2===arguments.length?n.convertToIndex(a,b):a,d=this.getGridPointHeight(c),e=this.getGridPointHeight(c+1),f=this.getGridPointHeight(c+n.dy),g=this.getGridPointHeight(c+n.dy+1),d<=0&&e<=0&&f<=0&&g<=0?q.water:d<=0||e<=0||f<=0||g<=0?q.shore:q.grass},n.prototype.tileSlope=function(a){var b=this.getGridPointHeight(a),c=this.getGridPointHeight(a+1),d=this.getGridPointHeight(a+C),e=this.getGridPointHeight(a+C+1),f=Math.min(b,c,d,e);return b-=f,c-=f,d-=f,(e-=f)<<24^d<<16^c<<8^b},n.prototype.tilePoints=function(a){var b=this.getGridPointHeight(x,y),c=this.getGridPointHeight(x+1,y),d=this.getGridPointHeight(x,y+1);return this.getGridPointHeight(x+1,y+1)<<24^d<<16^c<<8^b},n.prototype.resourceDistribution=function(a,e){return b(a,e)?p.stone:c(a,e)?p.iron:d(a,e)?p.oil:null},n.prototype.getResource=function(a,b){var c;if(1===arguments.length?(c=n.extractX(a),b=n.extractY(a)):c=a,!h(this.tileSlope(n.convertToIndex(c,b)))){var d=this.resourceDistribution(c,b);if(d===p.oil&&this.getTerrainType(c,b)===q.water)return p.oil;if(d!==p.none&&d!==p.oil&&this.getTerrainType(c,b)!==q.water)return d}return null},n.prototype.clearTile=function(a){s.fire(this,t.tileCleared,a)},n.isSlope=h,n.isSlopeSmooth=i,n.min=l,n.max=k,n.contains=m,n}),define("core/buildingstate",[],function(){return{none:0,underConstruction:1,ready:2}}),define("core/resources",["require","core/resourcecode"],function(a){var b=a("core/resourcecode"),c={zero:null};return c.create=function(a){var b=Object.create(null);return null!==a&&c.copy(b,a),b},c.add=function(a,c,d){var e,f,g;for(var h in b)g=b[h],e=c[g]||0,f=d[g]||0,0===(e+=f)&&void 0===a[g]||(a[g]=e);return a},c.sub=function(a,c,d){var e,f,g;for(var h in b)g=b[h],e=c[g]||0,f=d[g]||0,0===(e+=f)&&void 0===a[g]||(a[g]=e);return a},c.addOne=function(a,b,c,d){var e=b[c]||0;return a[c]=e+d,a},c.subOne=function(a,b,c,d){var e=b[c]||0;return a[c]=e-d,a},c.mul=function(a,b,c){for(var d in b)a[d]=b[d]*c;return a},c.clone=function(a){var b={};return c.copy(b,a),b},c.copy=function(a,b){for(var c in b)a[c]=b[c];return a},c.every=function(a,b,c){for(var d in a)if(!b(d,a[d],c))return!1;return!0},c.clear=function(a){var c;for(var d in b)c=b[d],void 0!==a[c]&&(a[c]=0)},c}),define("core/tileiterator",["require","namespace","./terrain"],function(a){function b(a,c){if(arguments.length>2)throw"invalid args";b.setup(this,a,c)}function c(a){return"number"==typeof a&&a%1==0}var d=a("namespace"),e=a("./terrain"),f=e.dy,g=f+1;return d("Isometrica.Core").TileIterator=b,b.prototype=Object.create(null),b.next=function(a){if(!0===a.done)return-1;var b=a.i++,c=a.w,d=b/c|0,e=b-d*c,g=a.tile0+e+d*f;return g===a.tile1&&(a.done=!0),g},b.reset=function(a){a.i=0},b.setup=function(a,b,d){if(!c(b)||!c(d)||-1===b||-1===d)throw"Invalid tiles "+b+" and "+d;var f,h;f=e.min(b,d),h=e.max(b,d),a.tile0=f,a.tile1=h,a.w=e.extractX(h-f+g),a.i=0,a.done=!1},b.toArray=function(a){for(var c=new b(a.tile0,a.tile1),d=[];!c.done;)d.push(c.next());return d},b.prototype.toArray=function(){return b.toArray(this)},b.prototype.next=function(){return b.next(this)},b.prototype.reset=function(){return b.reset(this)},b.prototype.setup=function(a,c){return b.setup(this,a,c)},b}),define("core/tileiteratorradial",["require","namespace","./terrain"],function(a){function b(a,c){b.setup(this,a,c)}function c(a,b){return f=h(b)-h(a.tile),g=i(b)-i(a.tile),Math.sqrt(f*f+g*g)<=a.radius}var d=a("namespace"),e=a("./terrain");d("Isometrica.Core").TileRadialIterator=b,b.next=function(a){if(a.done)return-1;var b=a.closed,d=a.open,f=d.pop();b[f]=!0;var g=f+1,h=f-1,i=f+e.dy,j=f-e.dy;return!0!==b[g]&&c(a,g)&&d.push(g),!0!==b[h]&&c(a,h)&&d.push(h),!0!==b[i]&&c(a,i)&&d.push(i),!0!==b[j]&&c(a,j)&&d.push(j),0===d.length&&(a.done=!0),f},b.reset=function(a){a.i=0},b.setup=function(a,b,c){b=parseInt(b,10),a.tile=b,a.open=[b],a.closed={},a.radius=c,a.done=!1};var f,g,h=e.extractX,i=e.extractY;return b}),define("core/construction",["require","data/buildings","./tileiterator","./terrain","./buildingstate"],function(a){function b(a){a.id=e++}function c(a,b,c,d,e){a.data=f[c],a.world=b,a.tile=d,a.buildingCode=c,a.rotation=e||0,0===a.data.constructionTime?a._state=i.ready:(a._state=i.underConstruction,setTimeout(function(){a._state=i.ready,Events.fire(a,j.stateChange,a._state)},a.data.constructionTime))}function d(){b(this)}var e,f=a("data/buildings"),g=a("./tileiterator"),h=a("./terrain"),i=a("./buildingstate"),j={stateChange:0};return d.constructor=b,d.events=j,d.init=c,d.prototype.id=-1,d.prototype.tile=-1,d.prototype.rotation=0,d.prototype.data=null,d.prototype.world=null,d.prototype.buildingCode=-1,d.prototype._state=i.none,d.prototype.init=function(a,b,d,e){return c(this,a,b,d,e)},d.prototype.getState=function(){return this._state},d.prototype.getCity=function(){var a=this.world,b=null,c=a.influenceMap.getTileOwner(this.tile);return-1!==c&&(b=a.cities.getCity(c)),b},d.prototype.occupiedTiles=function(){return new g(this.tile,this.tile+(this.data.sizeX-1)+(this.data.sizeY-1)*h.dy)},d}),define("core/building",["require","core/buildingstate","core/resources","events","data/classcode","data/buildings","./tileiterator","./tileiteratorradial","./terraintype","./gatherreq","./terrain","./construction"],function(a){function b(){t.constructor(this),this.producing={},this.demanding={}}function c(a,b,c){l.off(a.world,a.world.events.tick,c),a._state=j.none,e(a)}function d(a){var b=a.world,c=n[a.buildingCode];if(!b)throw"World is not set yet";if(c.requirement===r.inGrassLand)for(var d=a.occupiedTiles();!d.done;){var e=d.next(),f=b.terrain.getTerrainType(e);if(f!==q.grass)return!1}else if(c.requirement===r.nearTree)for(var g=new o(a.tile-s.dx,a.tile-s.dy,c.sizeX+2,c.sizeY+2);!g.done;){var e=g.next(),h=b.buildings.get(e);if(void 0===h&&b.envService.hasTree(e))return!0;if(null!==h){var i=n[h.buildingCode];if(i.classCode===m.tree)return!0}}else if(c.requirement===r.nearWater)for(var g=new o(a.tile-s.dx,a.tile-s.dy,c.sizeX+2,c.sizeY+2);!g.done;){var e=g.next(),j=b.terrain.getTerrainType(e);if(j===q.water||j===q.shore)return!0}return!0}function e(a){var b,c,d,e,f,g,h="building_"+a.id,i=a.world.tileParams;if(d=n[a.buildingCode],f=d.tileEffect||null,g=d.tileEffectRadius||1,a._state===j.ready){if(null!==f){for(i.has(h)&&i.remove(h),b=new p(a.tile,g),e={};!b.done;)c=p.next(b),e[c]=f;i.add(h,e)}}else null!==f&&i.has(h)&&i.remove(h)}function f(a,b,c){c.getCity(),h(c),i(c)}function g(a,b,c){e(c)}function h(a){k.clear(a.producing);var b=n[a.buildingCode],c=a.getCity();a._state!=j.ready||void 0!==b.requirement&&b.requirement!==r.none&&!d(a)||(k.add(a.producing,a.producing,b.producing),c.resources.add(a.producing))}function i(a){k.clear(a.demanding);var b=n[a.buildingCode],c=a.getCity();a._state==j.ready&&(k.add(a.demanding,a.demanding,b.demanding),c.resources.sub(a.demanding))}var j=a("core/buildingstate"),k=a("core/resources"),l=a("events"),m=a("data/classcode"),n=a("data/buildings"),o=a("./tileiterator"),p=a("./tileiteratorradial"),q=a("./terraintype"),r=a("./gatherreq"),s=a("./terrain"),t=a("./construction"),u={stateChange:0};return b.events=u,b.prototype=Object.create(t.prototype),b.prototype.constructor=b,b.prototype.createdAt=null,b.prototype.demanding=null,b.prototype.producing=null,b.prototype.permanent=!0,b.prototype.events=u,b.prototype.init=function(a,b,d,e){t.init(this,a,b,d,e),this.createdAt=this.createdAt||this.world.time.now,l.on(this,t.events.stateChange,g,this),this.data.classCode!==m.tree&&l.once(this,"dispose",c,l.on(this.world,this.world.events.tick,f,this))},b.prototype.dispose=function(){l.fire(this,"dispose")},b.prototype.citizenCapacity=function(){var a=0,b=n[this.buildingCode];return this._state==j.ready&&(a=b.citizenCapacity||0),a},b}),define("core/errorcode",[],function(){return{NONE:0,CITY_HALL_ALREADY_BUILT:1,BUILDING_NOT_AVAIL:2,NOT_ENOUGH_RES:3,CANT_BUILD_ON_WATER:4,CANT_BUILD_HERE:5,WRONG_RESOURCE_TILE:6,LAND_NOT_SUITABLE:7,FLAT_LAND_REQUIRED:8,TILE_TAKEN:9}}),define("core/tileiteratoraction",["require","namespace","./tileiterator"],function(a){function b(a,c,d,e){b.setup(this,a,c,d,e)}var c=a("namespace"),d=a("./tileiterator");return c("Isometrica.Core").TileIteratorAction=b,b.next=function(a){var b=d.next(a);return a.f(b,a.args)},b.reset=function(a){d.reset(a)},b.setup=function(a,b,c,e,f){d.setup(a,b,c),a.f=e,a.args=f},b.prototype=Object.create(d.prototype),b.prototype.setup=function(a,c,d,e,f){return b.setup(a,c,d,e,f)},b}),define("core/buildings",["require","events","data/buildings","./building","data/classcode","./errorcode","./terrain","./terraintype","./tileiterator","./tileiteratoraction","./buildingpositioning","namespace"],function(a){function b(a,b,c,d){for(var e,f,g,h,i=d,k=j[b],r=k.positioning||q.flat,s=i?k.sizeY:k.sizeX,t=i?k.sizeX:k.sizeY,u=c+(s-1)+(t-1)*n.dy,v=new p(c,u);!v.done;){if(c=p.next(v),f=a.world.terrain,e=f.tileSlope(c),g=f.getTerrainType(c),h=f.getResource(c),g===o.water)return m.CANT_BUILD_ON_WATER;if(r===q.flat&&null!==h)return m.CANT_BUILD_HERE;if(r===q.resource&&h!==k.resource)return m.WRONG_RESOURCE_TILE;if(k.classCode===l.road&&n.isSlope(e)&&!n.isSlopeSmooth(e))return m.LAND_NOT_SUITABLE;if(k.classCode!==l.tree&&k.classCode!==l.road&&n.isSlope(e))return m.FLAT_LAND_REQUIRED;var w=a.get(c);if(null!==w&&j[w.buildingCode].classCode!==l.tree)return m.TILE_TAKEN}return m.NONE}function c(a,b,c){var d=c.byTile[b];null!==d&&void 0!==d&&g(c,d)}function d(a,b,c){i.fire(c,c.events.buildingUpdated,a),i.fire(c,r.buildingStateChange,a)}function e(a,b,c){i.off(a,k.events.stateChange,c[0])}function f(a,b){var c;void 0!==(c=a.byTile[b])&&null!==c&&c.data.classCode===l.tree&&g(a,c)}function g(a,b){var c,d,e=b.id;if(null!==b&&void 0!==b){for(d=b.occupiedTiles();!d.done;)c=p.next(d),a.byTile[c]=null;return delete a.buildings[e],b.dispose(),i.fire(a,a.events.buildingRemoved,b),!0}return!1}function h(a){this.world=a,this.buildings=Object.create(null),this.byTile=Object.create(null)}var i=a("events"),j=a("data/buildings"),k=a("./building"),l=a("data/classcode"),m=a("./errorcode"),n=a("./terrain"),o=a("./terraintype"),p=a("./tileiterator"),q=(a("./tileiteratoraction"),a("./buildingpositioning"));a("namespace")("Isometrica.Core").ConstructionService=h;var r={buildingBuilt:0,buildingUpdated:1,buildingRemoved:2,buildingStateChange:3};return h.events=r,h.prototype.events=r,h.prototype.init=function(){var a=this.world.terrain;i.on(a,n.events.tileCleared,c,this)},h.prototype.get=function(a,b){return 2===arguments.length&&(a=n.convertToIndex(a,b)),this.byTile[a]||null},h.prototype.build=function(a){var b,c=a.occupiedTiles();for(this.buildings[a.id]=a;!c.done;)b=p.next(c),f(this,b),this.byTile[b]=a;var g=i.on(a,k.events.stateChange,d,this);i.once(a,"dispose",e,[g]),i.fire(this,r.buildingBuilt,a)},h.prototype.test=function(a,c,d){return b(this,a,c,d)},h}),define("core/vtime",["require","events"],function(a){function b(a){return a%4!=0||a%100==0&&a%400!=0?365:366}function c(a){this.now=0,this.day=1,this.year=1,this.month=1,this.monthName=e[0],this.daysInYear=365,this.prevMonth=0,this.prevYear=0,d.subscribe(a,a.events.tick,function(a,b,c){c.tick()},this)}var d=a("events"),e=["January","February","March","April","May","June","July","August","September","October","November","December"];c.events=c.prototype.events={advance:3,
newDay:0,newMonth:1,newYear:2};return c.prototype.constructor=c,c.prototype.start=function(){d.fire(this,this.events.newYear,this.now),d.fire(this,this.events.newMonth,this.now),d.fire(this,this.events.newDay,this.now)},c.prototype.setTime=function(a){this.now=a,d.fire(this,this.events.newYear,this.now),d.fire(this,this.events.newMonth,this.now),d.fire(this,this.events.newDay,this.now)},c.prototype.tick=function(){this.advance()},c.prototype.advance=function(){this.now+=864e5;var a=new Date(this.now);this.year=a.getFullYear()-1969,this.month=a.getMonth()+1,this.monthName=e[this.month-1],this.day=a.getDate(),d.fire(this,this.events.advance,this),d.fire(this,this.events.newDay,this.now),this.month!==this.prevMonth&&(d.fire(this,this.events.newMonth,this.now),this.prevMonth=this.month),this.year!==this.prevYear&&(d.fire(this,this.events.newYear,this.now),this.prevYear=this.year,this.daysInYear=b(this.year))},c.prototype.toString=function(){return"D"+this.day+"M"+this.month+"Y"+this.year},c.prototype.toMDY=function(){return this.monthName+" "+this.day+", "+this.year},c.prototype.save=function(){return this.now},c.prototype.load=function(a){return this.setTime(a),!0},c}),define("core/ambient",["require","simplex-noise","./terraintype","data/buildingcode","./buildings","./terrain","events","namespace"],function(a){function b(a,b){return void 0===a._usedTiles[b]&&l.noise2D(j.extractX(b),j.extractY(b))>0}function c(a,c,d){var e=b(d,c);d._usedTiles[c]=!0,e&&k.fire(d,m.treeRemove,c)}function d(a,c,d){for(var e,f,g=c.occupiedTiles();!g.done;)e=g.next(),f=b(d,e),d._usedTiles[e]=!0,f&&k.fire(d,m.treeRemove,e)}function e(a){this.root=a,this._usedTiles={}}var f=a("simplex-noise"),g=a("./terraintype"),h=a("data/buildingcode"),i=a("./buildings"),j=a("./terrain"),k=a("events");a("namespace")("Isometrica.Core").EnvService=e;var l=new f([151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180]),m={treeRemove:0};return e.events=m,e.prototype.getTree=function(a){var c=this.root,d=c.terrain,e=d.getTerrainType(a),f=d.getResource(a);return e!==g.water&&e!==g.shore&&null===f&&b(this,a)?[h.tree1,h.tree2][Math.ceil(l.noise2D(1,a))]:null},e.prototype.hasTree=function(a){return b(this,a)},e.prototype.init=function(){var a=this.root,b=a.terrain,e=a.buildingService;k.on(b,j.events.tileCleared,c,this),k.on(e,i.events.buildingBuilt,d,this)},e}),define("core/config",["require","namespace"],function(a){var b=a("namespace"),c=b("Isometrica.Core");return c.Config={tickDelay:1e3},c.Config}),define("core/city/laboratory",["require","events","../researchstate","../researchdirection","data/buildings","../vtime","namespace"],function(a){function b(a,b,c,e){e=e||!1;var f=h[b];if(void 0===f||void 0===f.items||void 0===f.items[c])return!1;var g=f.items[c];for(var i in g)!0!==a.researchedItems[i]&&(a.researchedItems[i]=!0,e||d.fire(a,n.buildingInvented,parseInt(i,10)))}function c(a){this.world=a.world,this.city=a,this.dirData={},this.dirData[f.municipal]={level:0,direction:f.municipal,state:e.available},this.dirData[f.housing]={level:0,direction:f.housing,state:e.available},this.dirData[f.commerce]={level:0,direction:f.commerce,state:e.available},this.dirData[f.industry]={level:0,direction:f.industry,state:e.available},this.researchedItems=[],b(this,f.municipal,0,!0),b(this,f.housing,0,!0),b(this,f.commerce,0,!0),b(this,f.industry,0,!0)}var d=a("events"),e=a("../researchstate"),f=a("../researchdirection"),g=a("data/buildings");a("../vtime");a("namespace")("Isometrica.Core.CityService").Laboratory=c;var h={};h[f.municipal]={time:1e4,cost:100,items:[]},h[f.housing]={time:1e4,cost:100,items:[]},h[f.industry]={time:1e4,cost:100,items:[]},h[f.commerce]={time:1e4,cost:100,items:[]};for(var i in g){var j=g[i],k=j.researchDirection||f.municipal,l=j.researchLevel||0,m=h[k],j=m.items[l]||(m.items[l]=[]);j.push(parseInt(i,10))}var n={researchComplete:0,researchUpdate:1,researchStart:2,buildingInvented:3};return c.events=n,c.prototype.research=function(a){var c=this.dirData[a],d=h[a];c.state===e.available?c(this,a):c.state===e.running||(c.state,e.unavailable);var f=c.level+1,g=f*d.time,i=f*d.cost;c.state=e.running,c.startTime=Date.now(),c.endTime=c.startTime+g,this.city.resourcesService.subMoney(i);var j=this;setTimeout(function(){c.state=e.available,c.level=f,b(j,a,f)},g)},c.prototype.getAvailableBuildings=function(){return this.researchedItems},c.prototype.getResearchProgress=function(a){var b=this.dirData[a],c=b.endTime-b.startTime;return(Date.now()-b.startTime)/c},c.prototype.getResearchData=function(){return this.dirData},c}),define("core/city/citystats",["require","../resources","events","data/buildings","namespace"],function(a){function b(a){this.city=a,this.resourceDemand={},this.resourceProduce={},this.maintenanceCost={}}function c(a,b,c){i.fire(c,c.events.update)}function d(a,b,c){var d=new Date;d.setTime(b.createdAt);var e=c.getYear()-d.getYear()-10,f=0,g=0;return e>0&&(e<=50?f=.25*e/50:e>50&&(f=.25),g=f/a.world.time.daysInYear),g}function e(a){h.clear(a.resourceDemand);for(var b=a.city.buildingService.getBuildings(),c=b.length,d=0;d<c;d++)h.add(a.resourceDemand,a.resourceDemand,b[d]);return a.resourceDemand}function f(a){h.clear(a.resourceProduce);for(var b=a.city.buildingService.getBuildings(),c=b.length,d=0;d<c;d++)h.add(a.resourceProduce,a.resourceProduce,b[d].producing);return a.resourceProduce}function g(a){var b=new Date;b.setTime(a.city.world.time.now),h.clear(a.maintenanceCost);for(var c=a.city.buildingService.getBuildings(),e=c.length,f=0;f<e;f++){var g=c[f],i=j[g.buildingCode],l=d(a.city,g,b);h.mul(k,i.constructionCost,l),h.add(a.maintenanceCost,a.maintenanceCost,k)}return a.maintenanceCost}var h=a("../resources"),i=a("events"),j=a("data/buildings");a("namespace")("Isometrica.Core.CityService").Stats=b;var k={};return b.prototype.city=null,b.prototype.resourceDemand=null,b.prototype.resourceProduce=null,b.prototype.maintenanceCost=null,b.prototype.events={update:0},b.prototype.init=function(){var a=this.city.world;i.on(a,a.events.tick,c,this)},b.prototype.getCityResourceDemand=function(){return e(this)},b.prototype.getCityResourceProduce=function(){return f(this)},b.prototype.getCityBuildingMaintenanceCost=function(){return g(this)},b}),define("core/city/area",["require","../tileiterator","../resourcecode","../terrain","namespace"],function(a){function b(a){this._city=a}function c(a,b,c,d,e){var g=a._city;d=d||1,e=e||1,2===arguments.length&&(c=b>>>16,b&=65535);for(var i=!0,j=h.convertToIndex(b,c),k=h.convertToIndex(b+d-1,c+e-1),l=new f(k,j),m=g.world.influenceMap.getInfluenceAreaData(g.id());!l.done;){if(void 0===m[l.next()]){i=!1;break}}return i}function d(a){var b=a.getInfluenceArea(),c=b.length;a.areaCost=c*i}function e(a,b,c){var e={};e[g.money]=d(c),c._city.resourcesModule.sub(e)}var f=a("../tileiterator"),g=a("../resourcecode"),h=a("../terrain");a("namespace")("Isometrica.Core.CityService").Area=b;var i=.025;return b.prototype._city=null,b.prototype.contains=function(a,b,d,e){var f,g,i,j;return 2===arguments.length?(f=h.extractX(a),g=h.extractY(a),i=h.extractX(b),j=h.extractX(b)):(f=a,g=b,i=d,j=e),c(this,f,g,i,j)},b.prototype.getInfluenceArea=function(){return this._city.world.influenceMap.getInfluenceArea(this._city.id())},b.prototype.getInfluenceAreaData=function(){return this._city.world.influenceMap.getInfluenceAreaData(this._city.id())},b.prototype.init=function(){var a=this._city.world;Events.on(a,a.events.tick,e,this)},b.prototype.getAreaCost=function(){return d(this)},b}),define("core/city/citybuildings",["require","events","data/buildingcode","data/buildings","../errorcode","../building","../terrain","../tileiterator","namespace"],function(a){function b(a){this._buildings=[],this.city=this._city=a}function c(a,b,c,d){var h=a.city.root.buildingService.test(b,c,d);if(h!==g.NONE)return h;var j=a.city,k=f[b];return!0!==j.laboratoryService.getAvailableBuildings()[b]?g.BUILDING_NOT_AVAIL:b===e.cityHall&&null!==a.cityHall?g.CITY_HALL_ALREADY_BUILT:j.area.contains(c,i.convertToIndex(k.sizeX,k.sizeY))?j.resources.hasEnough(k.constructionCost)?g.NONE:g.NOT_ENOUGH_RES:g.CANT_BUILD_HERE}var d=a("events"),e=a("data/buildingcode"),f=a("data/buildings"),g=a("../errorcode"),h=a("../building"),i=a("../terrain"),j=a("../tileiterator");a("namespace")("Isometrica.Core.CityService").Buildings=b,b.prototype._city=null,b.prototype._buildings=null,b.prototype.cityHall=null;var k=b.prototype.events={new:0,remove:1};return b.prototype.init=function(){},b.prototype.buildBuilding=function(a,b,i){var j=this.city,l=this.city.root,m=c(this,a,b,i);if(m===g.NONE){var n=f[a],o=new h;o.init(j.world,a,b,i),l.buildings.build(o),j.resources.sub(n.constructionCost),this._buildings.push(o),a===e.cityHall&&(this.cityHall=o),d.fire(this,k.new,o)}else l.messagingService.sendTileMessage(b,Isometrica.Core.MessageType.tileError,m)},b.prototype.buildRoad=function(a,b,e){for(var i=this.city,l=i.root,m=f[a],n=new j(b,e),o=[];!n.done;){var p=j.next(n),q=c(this,a,p);if(q===g.NONE){var r=new h;r.init(l,a,p),l.buildings.build(r),i.resources.sub(m.constructionCost),this._buildings.push(r),o.push(r)}else l.messagingService.sendTileMessage(p,Isometrica.Core.MessageType.tileError,q)}for(var s in o)d.fire(this,k.new,o[s])},b.prototype.destroyBuilding=function(){throw"Not implemented"},b.prototype.getBuildings=function(){return this._buildings},b}),define("core/city/cityresources",["require","../resources","../resourcecode","namespace"],function(a){function b(a){this.city=a,this._resources={money:1e4,stone:100,wood:100}}function c(a,b,c){return c._resources[a]>=b}var d=a("../resources"),e=a("../resourcecode");return a("namespace")("Isometrica.Core.CityService").Resource=b,b.prototype.city=null,b.prototype._resources=null,b.prototype.add=function(a){d.add(this._resources,this._resources,a)},b.prototype.sub=function(a){d.sub(this._resources,this._resources,a)},b.prototype.addResource=function(a,b){d.addOne(this._resources,this._resources,a,b)},b.prototype.subResource=function(a,b){d.subOne(this._resources,this._resources,a,b)},b.prototype.addMoney=function(a){this.addResource(e.money,a)},b.prototype.subMoney=function(a){this.subResource(e.money,a)},b.prototype.hasEnoughResource=function(a,b){return this._resources[a]>=b},b.prototype.hasEnough=function(a){return d.every(a,c,this)},b.prototype.getResources=function(){return this._resources},b}),define("core/world/tileparam",[],function(){return{Crime:"crime",Ecology:"eco"}}),define("core/city/citytilesparams",["require","../world/tileparam","namespace"],function(a){function b(a){this.city=a}var c=a("../world/tileparam");return a("namespace")("Isometrica.Core.CityService").TileParams=b,b.prototype.avgEco=function(){var a,b,d,e=this.city.area.getInfluenceArea(),f=this.city.world.tileParams,g=0,h=0;for(var i in e)a=e[i],b=f.get(a),d=b[c.Ecology]||0,g+=d,h++;return h>0&&g/h||-1},b}),define("core/world/tileparams",["require","./tileparam"],function(a){var b=a("./tileparam"),c={};return c.maxValue=100,c.create=function(a){var b=Object.create(null);return null!==a&&c.copy(b,a),b},c.add=function(a,c,d){var e,f,g;for(var h in b)g=b[h],e=c[g],f=d[g],a[g]=void 0!==e&&void 0!==f&&e+f||e||f||0;return a},c.sub=function(a,c,d){var e,f,g;for(var h in b)g=b[h],e=c[g]||0,f=d[g]||0,a[g]=e-f;return a},c.mul=function(a,b,c){for(var d in b)a[d]=b[d]*c;return a},c.clone=function(a){var b={};return c.copy(b,a),b},c.copy=function(a,b){for(var c in b)a[c]=b[c];return a},c.every=function(a,b,c){for(var d in a)if(!b(d,a[d],c))return!1;return!0},c.clear=function(a){var c;for(var d in b)c=b[d],void 0!==a[c]&&(a[c]=0)},c}),define("core/world/tileparamsmanager",["require","./tileparams","./tileparam"],function(a){function b(){this._records={},this._map={},this._tileRecords={}}function c(a,b){var c,e=a._tileRecords[b],h=void 0;for(var i in e){c=e[i],h=h||d.clone(g),d.add(h,h,c);for(var j in h)h[j]=Math.min(f,Math.max(0,h[j]))}void 0!==h?a._map[b]=h:void 0!==a._map[b]&&delete a._map[b]}var d=a("./tileparams"),e=a("./tileparam"),f=100,g={};return Object.defineProperty(g,e.Ecology,{value:f,writable:!1,enumerable:!0}),b.MAX_PARAM_VAL=f,b.add=function(a,b,d){if(void 0!==a._records[b])throw"key is already set, remove it first";a._records[b]=d;var e,f;for(var g in d){if(e=d[g],f=a._tileRecords[g]||(a._tileRecords[g]={}),void 0!==f[b])throw"Tile record with key: "+b+", is already set";f[b]=e,c(a,g)}},b.remove=function(a,b){if(void 0===a._records[b])throw"key doesn't exist";var d,e=a._records[b];for(var f in e){if(e[f],d=a._tileRecords[f],void 0===d[b])throw"Tile record with key: "+b+", is not set";delete d[b],void 0!==Object.keys&&0===Object.keys(a._tileRecords[f]).length&&delete a._tileRecords[f],c(a,f)}delete a._records[b]},b.has=function(a,b){return void 0!==a._records[b]},b.get=function(a,b){return a._map[b]||g},b.prototype.add=function(a,c){return b.add(this,a,c)},b.prototype.remove=function(a){return b.remove(this,a)},b.prototype.get=function(a){return b.get(this,a)},b.prototype.has=function(a){return b.has(this,a)},b}),define("core/city/citypopulation",["require","events","../resourcecode","../world/tileparamsmanager","namespace"],function(a){function b(a){this.city=a,this._population=0}function c(a,b,c){e(c),f(c)}function d(a){var b=0,c=a.city.buildingService.getBuildings();for(var d in c){b+=c[d].citizenCapacity()}return b}function e(a){var b=a.getPopulation(),c=d(a),e=a.city.tilesParams.avgEco(),f=0,g=c-b,h=.01*b,i=g>0?Math.max(1,Math.sqrt(g)):0,k=e/(j/2)-1,l=1,m=k*l;f=m<0?h*m:g<0?-1:i*m,a._population+=f}function f(a){var b={};b[h.money]=a.getTaxIncomeAmount(),a.city.resourcesModule.add(b)}var g=a("events"),h=a("../resourcecode"),i=a("../world/tileparamsmanager");a("namespace")("Isometrica.Core.CityService").Population=b;var j=i.MAX_PARAM_VAL;return b.prototype.init=function(){var a=this.city.world;g.on(a,a.events.tick,c,this)},b.prototype.getCapacity=function(){return d(this)},b.prototype.getPopulation=function(){return Math.max(0|this._population,0)},b.prototype.getTaxIncomeAmount=function(){return 1*this.getPopulation()},b}),define("core/city",["require","namespace","events","./city/laboratory","./city/citystats","./city/area","./city/citybuildings","./city/cityresources","./city/citytilesparams","./city/citypopulation","./resourcecode","data/buildingcode","./terrain"],function(a){function b(a,b){this.update=d.event(p.update),this.rename=d.event(p.rename),this.root=this.world=a,this._id=o++,this._tile=b,this.timeEstablished=a.time.milliseconds,this.area=this.areaService=new g(this),this.tilesParams=this.tileParamsService=new j(this),this.resourcesModule=this.resources=this.resourcesService=new i(this),this.statsService=new f(this),this.populationService=this.population=new k(this),this.lab=this.laboratoryService=new e(this),this.buildings=this.buildingService=new h(this),this.statsService.init(),this.populationService.init(),this.areaService.init(),d.on(a,a.events.tick,this.onTick,{self:this})}var c=a("namespace"),d=a("events"),e=a("./city/laboratory"),f=a("./city/citystats"),g=a("./city/area"),h=a("./city/citybuildings"),i=a("./city/cityresources"),j=a("./city/citytilesparams"),k=a("./city/citypopulation"),l=a("./resourcecode"),m=a("data/buildingcode"),n=a("./terrain");c("Isometrica.Core").City=b;var o=0,p=b.events=b.prototype.events={update:0,rename:1};return b.events=p,b.prototype._name="",b.prototype.world=null,b.prototype._tile=-1,b.prototype.init=function(){this.buildingService.buildBuilding(m.cityHall,this.tile())},b.prototype.onTick=function(a,b,c){var e=c.self;d.fire(e,e.events.update,e)},b.prototype.clearTile=function(a){if(this.areaService.contains(a)){var b=100;if(this.resourcesService.hasEnoughResource(l.money,b))return this.world.terrain.clearTile(a),this.resourcesModule.subResource(l.money,b),!0}return!1},b.prototype.id=function(){return this._id},b.prototype.name=function(a){return void 0!==a?(this._name=a,d.fire(this,p.rename,a),a):this._name},b.prototype.tile=function(a){return void 0!==a?this._tile=a:this._tile},b.prototype.toJSON=function(){return{name:this.name(),population:this.populationService.getPopulation(),maxPopulation:this.populationService.getCapacity(),tile:this.tile(),resources:this.resources.getResources(),resourceProduce:this.statsService.getCityResourceProduce(),resourceDemand:this.statsService.getCityResourceDemand(),maintenanceCost:this.statsService.getCityBuildingMaintenanceCost()}},b.canEstablish=function(a,b){return!n.isSlope(a.terrain.tileSlope(b))},b.establish=function(a,c,d){if(!b.canEstablish(a,c))return null;var e=new b(a,c);return e.name(d),e},b}),define("core/citysrv",["require","./city","namespace"],function(a){function b(a,b){if(void 0!==a._citiesById[b.id()])throw"City with id: "+b.id()+" already exists";a._cities.push(b),a._citiesByName[b.name()]=b,a._citiesByTile[b.tile()]=b,a._citiesById[b.id()]=b}function c(a){this.root=a,this._cities=[],this._citiesByName={},this._citiesByTile={},this._citiesById={},this.onNewCity=Events.event(e.cityNew)}var d=a("./city");a("namespace")("Isometrica.Core").CityService=c;var e={cityNew:0,cityRemove:1};return c.events=e,c.prototype.init=function(){},c.prototype.establishCity=function(a,c){var f=d.establish(this.root,a,c);return null!==f&&(b(this,f),Events.fire(this,e.cityNew,f),f.init(),f)},c.prototype.getCity=function(a){return this._citiesById[a]},c}),define("core/influencemap",["require","./terrain","events","data/buildings","./tileiteratorradial","./citysrv"],function(a){function b(a,b,d){i.on(b.buildingService,b.buildingService.events.new,c,d),i.on(b.buildingService,b.buildingService.events.remove,c,d),c(b.buildingService,null,d)}function c(a,b,c){c.map={},d(c,a)}function d(a,b){for(var c,d=b.getBuildings(),e=b.city,f=[],g=0,h=d.length;g<h;g++){c=d[g];for(var i,k=c.occupiedTiles(),l=1|j[c.buildingCode].influenceRadius;-1!==(i=k.next());)f[i]=l}f[e.tile()]=3,a.setInfluenceArea(e.id(),f)}function e(a,b,c,d){a[c]||(a[c]={count:0,influences:{}});var e=a[c];e.influences[b]?e.influences[b].value+=d:e.influences[b]={city:b,order:e.count++,value:d}}function f(a,b){for(var c,d=[],e=new k(a,b);!e.done;)c=k.next(e),d.push({x:h.extractX(c),y:h.extractY(c),value:1,index:c});return d}function g(a){this.map={},this.world=a,i.on(this.world.cities,l.events.cityNew,b,this)}var h=a("./terrain"),i=a("events"),j=a("data/buildings"),k=a("./tileiteratorradial"),l=a("./citysrv");return g.prototype.events={areaChange:0},g.prototype.world=null,g.prototype.setInfluenceArea=function(a,b){for(var c in b)for(var d=f(c,b[c]),g=0,h=d.length;g<h;g++){var j=d[g];e(this.map,a,j.index,j.value)}i.fire(this,this.events.areaChange,a)},g.prototype.getInfluenceAreaData=function(a){var b=[];for(var c in this.map){var d=this.map[c],e=d.influences[a];e&&(b[c]=e.value)}return b},g.prototype.getInfluenceArea=function(a){var b=[];for(var c in this.map){this.map[c].influences[a]&&b.push(c)}return b},g.prototype.getTileOwner=function(a){var b=this.map[a];void 0!==b&&(b=b.influences);var c=null;for(var d in b){var e=b[d];(null===c||c.value<e.value||c.value===e.value&&c.order<e.order)&&(c=e)}return null!==c?c.city:-1},g}),define("core/world/marketsrv",["require","../resources","../resourcecode"],function(a){function b(a){return 10}function c(a){}var d=a("../resources"),e=a("../resourcecode");return c.prototype.init=function(){},c.prototype.buy=function(a,c,f){var g=f*b(c),h=a[e.money];return void 0!==h&&h>=g&&(d.subOne(a,a,d.money,g),d.addOne(a,a,c,f),!0)},c.prototype.sell=function(a,c,e){var f=e*b(c),g=a[c];return void 0!==g&&g>=e&&(d.subOne(a,a,c,e),d.addOne(a,a,d.money,f),!0)},c}),define("vendor/enumeration",["require"],function(a){var b={};return b.parse=function(a,b){if("number"==typeof b||!isNaN(parseInt(b,10)))for(var c in a)if(a[c]===b)return c;return null},b}),define("core/msgsrv",["require","events","namespace","enumeration","./terrain"],function(a){function b(a){}var c=a("events"),d=a("namespace"),e=a("enumeration"),f=a("./terrain"),g=d("Isometrica.Core");g.MessagingService=b;var h=g.MessageType={regular:0,warning:1,error:2,tileRegular:3,tileWarning:4,tileError:5},i={message:0,tileMessage:1};return b.events=i,b.prototype.sendMessage=function(a,b){console.log(e.parse(h,a),b),c.fire(this,i.message,{type:a,text:b})},b.prototype.sendTileMessage=function(a,b,d){console.log("x: "+f.extractX(a)+"; y: "+f.extractY(a),e.parse(h,b),d),c.fire(this,i.tileMessage,{tile:a,type:b,text:d})},b}),define("core/logic",["require","events","./terrain","./buildings","./vtime","./ambient","./config","./influencemap","./world/tileparamsmanager","./world/marketsrv","./msgsrv","./citysrv","namespace"],function(a){function b(){this.world=this,this.messagingService=new l(this),this.time=new f(this),this.terrain=new d(this),this.buildingService=this.constructionService=this.buildings=new e(this),this.envService=new g(this),this.tileParams=new j(this),this.marketService=new k(this),this.cities=new m(this),this.influenceMap=this.areaService=new i(this)}var c=a("events"),d=a("./terrain"),e=a("./buildings"),f=a("./vtime"),g=a("./ambient"),h=a("./config"),i=a("./influencemap"),j=a("./world/tileparamsmanager"),k=a("./world/marketsrv"),l=a("./msgsrv"),m=a("./citysrv");a("namespace")("Isometrica.Core").Logic=b;var n=b.events=b.prototype.events={tick:1};return b.prototype.now=null,b.prototype.terrain=null,b.prototype.buildings=null,b.prototype.start=function(){var a=this;setInterval(function(){c.fire(a,n.tick,a,null)},h.tickDelay),this.time.start(),this.buildingService.init(),this.envService.init(),this.marketService.init(),this.cities.init()},b}),define("core/tiletype",{clear:0,water:1,building:2,road:4,tree:8,resource:16}),define("core/main",["require","namespace","data/buildings","data/classcode","data/classes","./logic","./terraintype","./ambient","./building","data/buildingcode","./buildingpositioning","./buildings","./buildingstate","./city","./config","./construction","./errorcode","./gatherreq","./influencemap","./logic","./msgsrv","./researchdirection","./researchstate","./resourcecode","./resources","./terrain","./terraintype","./tileiterator","./tileiteratoraction","./tileiteratorradial","./tiletype","./vtime","./city/area","./city/citybuildings","./city/citypopulation","./city/cityresources","./city/citystats","./city/citytilesparams","./city/laboratory","./world/marketsrv","./world/tileparam","./world/tileparams","./world/tileparamsmanager"],function(a){var b=a("namespace");return a("data/buildings"),a("data/classcode"),a("data/classes"),a("./logic"),a("./terraintype"),a("./ambient"),a("./building"),a("data/buildingcode"),a("./buildingpositioning"),a("./buildings"),a("./buildingstate"),a("./city"),a("./config"),a("./construction"),a("./errorcode"),a("./gatherreq"),a("./influencemap"),a("./logic"),a("./msgsrv"),a("./researchdirection"),a("./researchstate"),a("./resourcecode"),a("./resources"),a("./terrain"),a("./terraintype"),a("./tileiterator"),a("./tileiteratoraction"),a("./tileiteratorradial"),a("./tiletype"),a("./vtime"),a("./city/area"),a("./city/citybuildings"),a("./city/citypopulation"),a("./city/cityresources"),a("./city/citystats"),a("./city/citytilesparams"),a("./city/laboratory"),a("./world/marketsrv"),a("./world/tileparam"),a("./world/tileparams"),a("./world/tileparamsmanager"),b("Isometrica.Core")}),function(a){"use strict";var b={};"undefined"==typeof exports?"function"==typeof define&&"object"==typeof define.amd&&define.amd?(b.exports={},define("client/vendor/gl-matrix",[],function(){return b.exports})):b.exports="undefined"!=typeof window?window:a:b.exports=exports,function(a){if(!b)var b=1e-6;if(!c)var c="undefined"!=typeof Float32Array?Float32Array:Array;if(!d)var d=Math.random;var e={};e.setMatrixArrayType=function(a){c=a},void 0!==a&&(a.glMatrix=e);var f={};f.create=function(){var a=new c(2);return a[0]=0,a[1]=0,a},f.clone=function(a){var b=new c(2);return b[0]=a[0],b[1]=a[1],b},f.fromValues=function(a,b){var d=new c(2);return d[0]=a,d[1]=b,d},f.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a},f.set=function(a,b,c){return a[0]=b,a[1]=c,a},f.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a},f.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a},f.sub=f.subtract,f.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a},f.mul=f.multiply,f.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a},f.div=f.divide,f.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a},f.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a},f.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a},f.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a},f.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return Math.sqrt(c*c+d*d)},f.dist=f.distance,f.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1];return c*c+d*d},f.sqrDist=f.squaredDistance,f.length=function(a){var b=a[0],c=a[1];return Math.sqrt(b*b+c*c)},f.len=f.length,f.squaredLength=function(a){var b=a[0],c=a[1];return b*b+c*c},f.sqrLen=f.squaredLength,f.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a},f.normalize=function(a,b){var c=b[0],d=b[1],e=c*c+d*d;return e>0&&(e=1/Math.sqrt(e),a[0]=b[0]*e,a[1]=b[1]*e),a},f.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]},f.cross=function(a,b,c){var d=b[0]*c[1]-b[1]*c[0];return a[0]=a[1]=0,a[2]=d,a},f.lerp=function(a,b,c,d){var e=b[0],f=b[1];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a},f.random=function(a,b){b=b||1;var c=2*d()*Math.PI;return a[0]=Math.cos(c)*b,a[1]=Math.sin(c)*b,a},f.transformMat2=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e,a[1]=c[1]*d+c[3]*e,a},f.transformMat2d=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[2]*e+c[4],a[1]=c[1]*d+c[3]*e+c[5],a},f.transformMat3=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[3]*e+c[6],a[1]=c[1]*d+c[4]*e+c[7],a},f.transformMat4=function(a,b,c){var d=b[0],e=b[1];return a[0]=c[0]*d+c[4]*e+c[12],a[1]=c[1]*d+c[5]*e+c[13],a},f.forEach=function(){var a=f.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=2),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;h<i;h+=c)a[0]=b[h],a[1]=b[h+1],f(a,a,g),b[h]=a[0],b[h+1]=a[1];return b}}(),f.str=function(a){return"vec2("+a[0]+", "+a[1]+")"},void 0!==a&&(a.vec2=f);var g={};g.create=function(){var a=new c(3);return a[0]=0,a[1]=0,a[2]=0,a},g.zero=g.create(),g.clone=function(a){var b=new c(3);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b},g.fromValues=function(a,b,d){var e=new c(3);return e[0]=a,e[1]=b,e[2]=d,e},g.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a},g.set=function(a,b,c,d){return a[0]=b,a[1]=c,a[2]=d,a},g.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a},g.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a},g.sub=g.subtract,g.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a},g.mul=g.multiply,g.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a},g.div=g.divide,g.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a},g.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a},g.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a},g.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a},g.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return Math.sqrt(c*c+d*d+e*e)},g.dist=g.distance,g.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2];return c*c+d*d+e*e},g.sqrDist=g.squaredDistance,g.length=function(a){var b=a[0],c=a[1],d=a[2];return Math.sqrt(b*b+c*c+d*d)},g.len=g.length,g.squaredLength=function(a){var b=a[0],c=a[1],d=a[2];return b*b+c*c+d*d},g.sqrLen=g.squaredLength,g.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a},g.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=c*c+d*d+e*e;return f>0&&(f=1/Math.sqrt(f),a[0]=b[0]*f,a[1]=b[1]*f,a[2]=b[2]*f),a},g.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},g.cross=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2];return a[0]=e*i-f*h,a[1]=f*g-d*i,a[2]=d*h-e*g,a},g.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a},g.random=function(a,b){b=b||1;var c=2*d()*Math.PI,e=2*d()-1,f=Math.sqrt(1-e*e)*b;return a[0]=Math.cos(c)*f,a[1]=Math.sin(c)*f,a[2]=e*b,a},g.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12],a[1]=c[1]*d+c[5]*e+c[9]*f+c[13],a[2]=c[2]*d+c[6]*e+c[10]*f+c[14],a},g.transformMat3=function(a,b,c){var d=b[0],e=b[1],f=b[2];return a[0]=d*c[0]+e*c[3]+f*c[6],a[1]=d*c[1]+e*c[4]+f*c[7],a[2]=d*c[2]+e*c[5]+f*c[8],a},g.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},g.forEach=function(){var a=g.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=3),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;h<i;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2];return b}}(),g.str=function(a){return"vec3("+a[0]+", "+a[1]+", "+a[2]+")"},void 0!==a&&(a.vec3=g);var h={};h.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=0,a},h.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},h.fromValues=function(a,b,d,e){var f=new c(4);return f[0]=a,f[1]=b,f[2]=d,f[3]=e,f},h.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},h.set=function(a,b,c,d,e){return a[0]=b,a[1]=c,a[2]=d,a[3]=e,a},h.add=function(a,b,c){return a[0]=b[0]+c[0],a[1]=b[1]+c[1],a[2]=b[2]+c[2],a[3]=b[3]+c[3],a},h.subtract=function(a,b,c){return a[0]=b[0]-c[0],a[1]=b[1]-c[1],a[2]=b[2]-c[2],a[3]=b[3]-c[3],a},h.sub=h.subtract,h.multiply=function(a,b,c){return a[0]=b[0]*c[0],a[1]=b[1]*c[1],a[2]=b[2]*c[2],a[3]=b[3]*c[3],a},h.mul=h.multiply,h.divide=function(a,b,c){return a[0]=b[0]/c[0],a[1]=b[1]/c[1],a[2]=b[2]/c[2],a[3]=b[3]/c[3],a},h.div=h.divide,h.min=function(a,b,c){return a[0]=Math.min(b[0],c[0]),a[1]=Math.min(b[1],c[1]),a[2]=Math.min(b[2],c[2]),a[3]=Math.min(b[3],c[3]),a},h.max=function(a,b,c){return a[0]=Math.max(b[0],c[0]),a[1]=Math.max(b[1],c[1]),a[2]=Math.max(b[2],c[2]),a[3]=Math.max(b[3],c[3]),a},h.scale=function(a,b,c){return a[0]=b[0]*c,a[1]=b[1]*c,a[2]=b[2]*c,a[3]=b[3]*c,a},h.scaleAndAdd=function(a,b,c,d){return a[0]=b[0]+c[0]*d,a[1]=b[1]+c[1]*d,a[2]=b[2]+c[2]*d,a[3]=b[3]+c[3]*d,a},h.distance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return Math.sqrt(c*c+d*d+e*e+f*f)},h.dist=h.distance,h.squaredDistance=function(a,b){var c=b[0]-a[0],d=b[1]-a[1],e=b[2]-a[2],f=b[3]-a[3];return c*c+d*d+e*e+f*f},h.sqrDist=h.squaredDistance,h.length=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return Math.sqrt(b*b+c*c+d*d+e*e)},h.len=h.length,h.squaredLength=function(a){var b=a[0],c=a[1],d=a[2],e=a[3];return b*b+c*c+d*d+e*e},h.sqrLen=h.squaredLength,h.negate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=-b[3],a},h.normalize=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f;return g>0&&(g=1/Math.sqrt(g),a[0]=b[0]*g,a[1]=b[1]*g,
a[2]=b[2]*g,a[3]=b[3]*g),a},h.dot=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},h.lerp=function(a,b,c,d){var e=b[0],f=b[1],g=b[2],h=b[3];return a[0]=e+d*(c[0]-e),a[1]=f+d*(c[1]-f),a[2]=g+d*(c[2]-g),a[3]=h+d*(c[3]-h),a},h.random=function(a,b){return b=b||1,a[0]=d(),a[1]=d(),a[2]=d(),a[3]=d(),h.normalize(a,a),h.scale(a,a,b),a},h.transformMat4=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3];return a[0]=c[0]*d+c[4]*e+c[8]*f+c[12]*g,a[1]=c[1]*d+c[5]*e+c[9]*f+c[13]*g,a[2]=c[2]*d+c[6]*e+c[10]*f+c[14]*g,a[3]=c[3]*d+c[7]*e+c[11]*f+c[15]*g,a},h.transformQuat=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=c[0],h=c[1],i=c[2],j=c[3],k=j*d+h*f-i*e,l=j*e+i*d-g*f,m=j*f+g*e-h*d,n=-g*d-h*e-i*f;return a[0]=k*j+n*-g+l*-i-m*-h,a[1]=l*j+n*-h+m*-g-k*-i,a[2]=m*j+n*-i+k*-h-l*-g,a},h.forEach=function(){var a=h.create();return function(b,c,d,e,f,g){var h,i;for(c||(c=4),d||(d=0),i=e?Math.min(e*c+d,b.length):b.length,h=d;h<i;h+=c)a[0]=b[h],a[1]=b[h+1],a[2]=b[h+2],a[3]=b[h+3],f(a,a,g),b[h]=a[0],b[h+1]=a[1],b[h+2]=a[2],b[h+3]=a[3];return b}}(),h.str=function(a){return"vec4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},void 0!==a&&(a.vec4=h);var i={};i.create=function(){var a=new c(4);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},i.clone=function(a){var b=new c(4);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b},i.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a},i.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a},i.transpose=function(a,b){if(a===b){var c=b[1];a[1]=b[2],a[2]=c}else a[0]=b[0],a[1]=b[2],a[2]=b[1],a[3]=b[3];return a},i.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*f-e*d;return g?(g=1/g,a[0]=f*g,a[1]=-d*g,a[2]=-e*g,a[3]=c*g,a):null},i.adjoint=function(a,b){var c=b[0];return a[0]=b[3],a[1]=-b[1],a[2]=-b[2],a[3]=c,a},i.determinant=function(a){return a[0]*a[3]-a[2]*a[1]},i.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*h+e*j,a[1]=d*i+e*k,a[2]=f*h+g*j,a[3]=f*i+g*k,a},i.mul=i.multiply,i.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+e*h,a[1]=d*-h+e*i,a[2]=f*i+g*h,a[3]=f*-h+g*i,a},i.scale=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1];return a[0]=d*h,a[1]=e*i,a[2]=f*h,a[3]=g*i,a},i.str=function(a){return"mat2("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},void 0!==a&&(a.mat2=i);var j={};j.create=function(){var a=new c(6);return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},j.clone=function(a){var b=new c(6);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b},j.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a},j.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=1,a[4]=0,a[5]=0,a},j.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=c*f-d*e;return i?(i=1/i,a[0]=f*i,a[1]=-d*i,a[2]=-e*i,a[3]=c*i,a[4]=(e*h-f*g)*i,a[5]=(d*g-c*h)*i,a):null},j.determinant=function(a){return a[0]*a[3]-a[1]*a[2]},j.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=c[0],k=c[1],l=c[2],m=c[3],n=c[4],o=c[5];return a[0]=d*j+e*l,a[1]=d*k+e*m,a[2]=f*j+g*l,a[3]=f*k+g*m,a[4]=j*h+l*i+n,a[5]=k*h+m*i+o,a},j.mul=j.multiply,j.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=Math.sin(c),k=Math.cos(c);return a[0]=d*k+e*j,a[1]=-d*j+e*k,a[2]=f*k+g*j,a[3]=-f*j+k*g,a[4]=k*h+j*i,a[5]=k*i-j*h,a},j.scale=function(a,b,c){var d=c[0],e=c[1];return a[0]=b[0]*d,a[1]=b[1]*e,a[2]=b[2]*d,a[3]=b[3]*e,a[4]=b[4]*d,a[5]=b[5]*e,a},j.translate=function(a,b,c){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4]+c[0],a[5]=b[5]+c[1],a},j.str=function(a){return"mat2d("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+")"},void 0!==a&&(a.mat2d=j);var k={};k.create=function(){var a=new c(9);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},k.fromMat4=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[4],a[4]=b[5],a[5]=b[6],a[6]=b[8],a[7]=b[9],a[8]=b[10],a},k.clone=function(a){var b=new c(9);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b},k.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},k.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=1,a[5]=0,a[6]=0,a[7]=0,a[8]=1,a},k.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[5];a[1]=b[3],a[2]=b[6],a[3]=c,a[5]=b[7],a[6]=d,a[7]=e}else a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8];return a},k.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=k*g-h*j,m=-k*f+h*i,n=j*f-g*i,o=c*l+d*m+e*n;return o?(o=1/o,a[0]=l*o,a[1]=(-k*d+e*j)*o,a[2]=(h*d-e*g)*o,a[3]=m*o,a[4]=(k*c-e*i)*o,a[5]=(-h*c+e*f)*o,a[6]=n*o,a[7]=(-j*c+d*i)*o,a[8]=(g*c-d*f)*o,a):null},k.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8];return a[0]=g*k-h*j,a[1]=e*j-d*k,a[2]=d*h-e*g,a[3]=h*i-f*k,a[4]=c*k-e*i,a[5]=e*f-c*h,a[6]=f*j-g*i,a[7]=d*i-c*j,a[8]=c*g-d*f,a},k.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8];return b*(j*f-g*i)+c*(-j*e+g*h)+d*(i*e-f*h)},k.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1],o=c[2],p=c[3],q=c[4],r=c[5],s=c[6],t=c[7],u=c[8];return a[0]=m*d+n*g+o*j,a[1]=m*e+n*h+o*k,a[2]=m*f+n*i+o*l,a[3]=p*d+q*g+r*j,a[4]=p*e+q*h+r*k,a[5]=p*f+q*i+r*l,a[6]=s*d+t*g+u*j,a[7]=s*e+t*h+u*k,a[8]=s*f+t*i+u*l,a},k.mul=k.multiply,k.translate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=c[0],n=c[1];return a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=m*d+n*g+j,a[7]=m*e+n*h+k,a[8]=m*f+n*i+l,a},k.rotate=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=Math.sin(c),n=Math.cos(c);return a[0]=n*d+m*g,a[1]=n*e+m*h,a[2]=n*f+m*i,a[3]=n*g-m*d,a[4]=n*h-m*e,a[5]=n*i-m*f,a[6]=j,a[7]=k,a[8]=l,a},k.scale=function(a,b,c){var d=c[0],e=c[1];return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=e*b[3],a[4]=e*b[4],a[5]=e*b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a},k.fromMat2d=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=0,a[3]=b[2],a[4]=b[3],a[5]=0,a[6]=b[4],a[7]=b[5],a[8]=1,a},k.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-(m+o),a[3]=k+r,a[6]=l-q,a[1]=k-r,a[4]=1-(j+o),a[7]=n+p,a[2]=l+q,a[5]=n-p,a[8]=1-(j+m),a},k.normalFromMat4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(i*A-g*D-j*z)*E,a[2]=(g*C-h*A+j*y)*E,a[3]=(e*C-d*D-f*B)*E,a[4]=(c*D-e*A+f*z)*E,a[5]=(d*A-c*C-f*y)*E,a[6]=(p*x-q*w+r*v)*E,a[7]=(q*u-o*x-r*t)*E,a[8]=(o*w-p*u+r*s)*E,a):null},k.str=function(a){return"mat3("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+")"},void 0!==a&&(a.mat3=k);var l={};l.create=function(){var a=new c(16);return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.clone=function(a){var b=new c(16);return b[0]=a[0],b[1]=a[1],b[2]=a[2],b[3]=a[3],b[4]=a[4],b[5]=a[5],b[6]=a[6],b[7]=a[7],b[8]=a[8],b[9]=a[9],b[10]=a[10],b[11]=a[11],b[12]=a[12],b[13]=a[13],b[14]=a[14],b[15]=a[15],b},l.copy=function(a,b){return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},l.identity=function(a){return a[0]=1,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=1,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=1,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.transpose=function(a,b){if(a===b){var c=b[1],d=b[2],e=b[3],f=b[6],g=b[7],h=b[11];a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=c,a[6]=b[9],a[7]=b[13],a[8]=d,a[9]=f,a[11]=b[14],a[12]=e,a[13]=g,a[14]=h}else a[0]=b[0],a[1]=b[4],a[2]=b[8],a[3]=b[12],a[4]=b[1],a[5]=b[5],a[6]=b[9],a[7]=b[13],a[8]=b[2],a[9]=b[6],a[10]=b[10],a[11]=b[14],a[12]=b[3],a[13]=b[7],a[14]=b[11],a[15]=b[15];return a},l.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=s*D-t*C+u*B+v*A-w*z+x*y;return E?(E=1/E,a[0]=(h*D-i*C+j*B)*E,a[1]=(e*C-d*D-f*B)*E,a[2]=(p*x-q*w+r*v)*E,a[3]=(m*w-l*x-n*v)*E,a[4]=(i*A-g*D-j*z)*E,a[5]=(c*D-e*A+f*z)*E,a[6]=(q*u-o*x-r*t)*E,a[7]=(k*x-m*u+n*t)*E,a[8]=(g*C-h*A+j*y)*E,a[9]=(d*A-c*C-f*y)*E,a[10]=(o*w-p*u+r*s)*E,a[11]=(l*u-k*w-n*s)*E,a[12]=(h*z-g*B-i*y)*E,a[13]=(c*B-d*z+e*y)*E,a[14]=(p*t-o*v-q*s)*E,a[15]=(k*v-l*t+m*s)*E,a):null},l.adjoint=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=b[4],h=b[5],i=b[6],j=b[7],k=b[8],l=b[9],m=b[10],n=b[11],o=b[12],p=b[13],q=b[14],r=b[15];return a[0]=h*(m*r-n*q)-l*(i*r-j*q)+p*(i*n-j*m),a[1]=-(d*(m*r-n*q)-l*(e*r-f*q)+p*(e*n-f*m)),a[2]=d*(i*r-j*q)-h*(e*r-f*q)+p*(e*j-f*i),a[3]=-(d*(i*n-j*m)-h*(e*n-f*m)+l*(e*j-f*i)),a[4]=-(g*(m*r-n*q)-k*(i*r-j*q)+o*(i*n-j*m)),a[5]=c*(m*r-n*q)-k*(e*r-f*q)+o*(e*n-f*m),a[6]=-(c*(i*r-j*q)-g*(e*r-f*q)+o*(e*j-f*i)),a[7]=c*(i*n-j*m)-g*(e*n-f*m)+k*(e*j-f*i),a[8]=g*(l*r-n*p)-k*(h*r-j*p)+o*(h*n-j*l),a[9]=-(c*(l*r-n*p)-k*(d*r-f*p)+o*(d*n-f*l)),a[10]=c*(h*r-j*p)-g*(d*r-f*p)+o*(d*j-f*h),a[11]=-(c*(h*n-j*l)-g*(d*n-f*l)+k*(d*j-f*h)),a[12]=-(g*(l*q-m*p)-k*(h*q-i*p)+o*(h*m-i*l)),a[13]=c*(l*q-m*p)-k*(d*q-e*p)+o*(d*m-e*l),a[14]=-(c*(h*q-i*p)-g*(d*q-e*p)+o*(d*i-e*h)),a[15]=c*(h*m-i*l)-g*(d*m-e*l)+k*(d*i-e*h),a},l.determinant=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return(b*g-c*f)*(l*q-m*p)-(b*h-d*f)*(k*q-m*o)+(b*i-e*f)*(k*p-l*o)+(c*h-d*g)*(j*q-m*n)-(c*i-e*g)*(j*p-l*n)+(d*i-e*h)*(j*o-k*n)},l.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c[0],u=c[1],v=c[2],w=c[3];return a[0]=t*d+u*h+v*l+w*p,a[1]=t*e+u*i+v*m+w*q,a[2]=t*f+u*j+v*n+w*r,a[3]=t*g+u*k+v*o+w*s,t=c[4],u=c[5],v=c[6],w=c[7],a[4]=t*d+u*h+v*l+w*p,a[5]=t*e+u*i+v*m+w*q,a[6]=t*f+u*j+v*n+w*r,a[7]=t*g+u*k+v*o+w*s,t=c[8],u=c[9],v=c[10],w=c[11],a[8]=t*d+u*h+v*l+w*p,a[9]=t*e+u*i+v*m+w*q,a[10]=t*f+u*j+v*n+w*r,a[11]=t*g+u*k+v*o+w*s,t=c[12],u=c[13],v=c[14],w=c[15],a[12]=t*d+u*h+v*l+w*p,a[13]=t*e+u*i+v*m+w*q,a[14]=t*f+u*j+v*n+w*r,a[15]=t*g+u*k+v*o+w*s,a},l.mul=l.multiply,l.translate=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n,o,p=c[0],q=c[1],r=c[2];return b===a?(a[12]=b[0]*p+b[4]*q+b[8]*r+b[12],a[13]=b[1]*p+b[5]*q+b[9]*r+b[13],a[14]=b[2]*p+b[6]*q+b[10]*r+b[14],a[15]=b[3]*p+b[7]*q+b[11]*r+b[15]):(d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],a[0]=d,a[1]=e,a[2]=f,a[3]=g,a[4]=h,a[5]=i,a[6]=j,a[7]=k,a[8]=l,a[9]=m,a[10]=n,a[11]=o,a[12]=d*p+h*q+l*r+b[12],a[13]=e*p+i*q+m*r+b[13],a[14]=f*p+j*q+n*r+b[14],a[15]=g*p+k*q+o*r+b[15]),a},l.scale=function(a,b,c){var d=c[0],e=c[1],f=c[2];return a[0]=b[0]*d,a[1]=b[1]*d,a[2]=b[2]*d,a[3]=b[3]*d,a[4]=b[4]*e,a[5]=b[5]*e,a[6]=b[6]*e,a[7]=b[7]*e,a[8]=b[8]*f,a[9]=b[9]*f,a[10]=b[10]*f,a[11]=b[11]*f,a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},l.rotate=function(a,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=e[0],E=e[1],F=e[2],G=Math.sqrt(D*D+E*E+F*F);return Math.abs(G)<b?null:(G=1/G,D*=G,E*=G,F*=G,f=Math.sin(d),g=Math.cos(d),h=1-g,i=c[0],j=c[1],k=c[2],l=c[3],m=c[4],n=c[5],o=c[6],p=c[7],q=c[8],r=c[9],s=c[10],t=c[11],u=D*D*h+g,v=E*D*h+F*f,w=F*D*h-E*f,x=D*E*h-F*f,y=E*E*h+g,z=F*E*h+D*f,A=D*F*h+E*f,B=E*F*h-D*f,C=F*F*h+g,a[0]=i*u+m*v+q*w,a[1]=j*u+n*v+r*w,a[2]=k*u+o*v+s*w,a[3]=l*u+p*v+t*w,a[4]=i*x+m*y+q*z,a[5]=j*x+n*y+r*z,a[6]=k*x+o*y+s*z,a[7]=l*x+p*y+t*z,a[8]=i*A+m*B+q*C,a[9]=j*A+n*B+r*C,a[10]=k*A+o*B+s*C,a[11]=l*A+p*B+t*C,c!==a&&(a[12]=c[12],a[13]=c[13],a[14]=c[14],a[15]=c[15]),a)},l.rotateX=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[4],g=b[5],h=b[6],i=b[7],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[4]=f*e+j*d,a[5]=g*e+k*d,a[6]=h*e+l*d,a[7]=i*e+m*d,a[8]=j*e-f*d,a[9]=k*e-g*d,a[10]=l*e-h*d,a[11]=m*e-i*d,a},l.rotateY=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[8],k=b[9],l=b[10],m=b[11];return b!==a&&(a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e-j*d,a[1]=g*e-k*d,a[2]=h*e-l*d,a[3]=i*e-m*d,a[8]=f*d+j*e,a[9]=g*d+k*e,a[10]=h*d+l*e,a[11]=i*d+m*e,a},l.rotateZ=function(a,b,c){var d=Math.sin(c),e=Math.cos(c),f=b[0],g=b[1],h=b[2],i=b[3],j=b[4],k=b[5],l=b[6],m=b[7];return b!==a&&(a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15]),a[0]=f*e+j*d,a[1]=g*e+k*d,a[2]=h*e+l*d,a[3]=i*e+m*d,a[4]=j*e-f*d,a[5]=k*e-g*d,a[6]=l*e-h*d,a[7]=m*e-i*d,a},l.fromRotationTranslation=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=d+d,i=e+e,j=f+f,k=d*h,l=d*i,m=d*j,n=e*i,o=e*j,p=f*j,q=g*h,r=g*i,s=g*j;return a[0]=1-(n+p),a[1]=l+s,a[2]=m-r,a[3]=0,a[4]=l-s,a[5]=1-(k+p),a[6]=o+q,a[7]=0,a[8]=m+r,a[9]=o-q,a[10]=1-(k+n),a[11]=0,a[12]=c[0],a[13]=c[1],a[14]=c[2],a[15]=1,a},l.fromQuat=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return a[0]=1-(m+o),a[1]=k+r,a[2]=l-q,a[3]=0,a[4]=k-r,a[5]=1-(j+o),a[6]=n+p,a[7]=0,a[8]=l+q,a[9]=n-p,a[10]=1-(j+m),a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,a},l.frustum=function(a,b,c,d,e,f,g){var h=1/(c-b),i=1/(e-d),j=1/(f-g);return a[0]=2*f*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*f*i,a[6]=0,a[7]=0,a[8]=(c+b)*h,a[9]=(e+d)*i,a[10]=(g+f)*j,a[11]=-1,a[12]=0,a[13]=0,a[14]=g*f*2*j,a[15]=0,a},l.perspective=function(a,b,c,d,e){var f=1/Math.tan(b/2),g=1/(d-e);return a[0]=f/c,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=f,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=(e+d)*g,a[11]=-1,a[12]=0,a[13]=0,a[14]=2*e*d*g,a[15]=0,a},l.ortho=function(a,b,c,d,e,f,g){var h=1/(b-c),i=1/(d-e),j=1/(f-g);return a[0]=-2*h,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=-2*i,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=2*j,a[11]=0,a[12]=(b+c)*h,a[13]=(e+d)*i,a[14]=(g+f)*j,a[15]=1,a},l.lookAt=function(a,c,d,e){var f,g,h,i,j,k,m,n,o,p,q=c[0],r=c[1],s=c[2],t=e[0],u=e[1],v=e[2],w=d[0],x=d[1],y=d[2];return Math.abs(q-w)<b&&Math.abs(r-x)<b&&Math.abs(s-y)<b?l.identity(a):(m=q-w,n=r-x,o=s-y,p=1/Math.sqrt(m*m+n*n+o*o),m*=p,n*=p,o*=p,f=u*o-v*n,g=v*m-t*o,h=t*n-u*m,p=Math.sqrt(f*f+g*g+h*h),p?(p=1/p,f*=p,g*=p,h*=p):(f=0,g=0,h=0),i=n*h-o*g,j=o*f-m*h,k=m*g-n*f,p=Math.sqrt(i*i+j*j+k*k),p?(p=1/p,i*=p,j*=p,k*=p):(i=0,j=0,k=0),a[0]=f,a[1]=i,a[2]=m,a[3]=0,a[4]=g,a[5]=j,a[6]=n,a[7]=0,a[8]=h,a[9]=k,a[10]=o,a[11]=0,a[12]=-(f*q+g*r+h*s),a[13]=-(i*q+j*r+k*s),a[14]=-(m*q+n*r+o*s),a[15]=1,a)},l.str=function(a){return"mat4("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+", "+a[4]+", "+a[5]+", "+a[6]+", "+a[7]+", "+a[8]+", "+a[9]+", "+a[10]+", "+a[11]+", "+a[12]+", "+a[13]+", "+a[14]+", "+a[15]+")"},void 0!==a&&(a.mat4=l);var m={};m.create=function(){var a=new c(4);return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},m.rotationTo=function(){var a=g.create(),b=g.fromValues(1,0,0),c=g.fromValues(0,1,0);return function(d,e,f){var h=g.dot(e,f);return h<-.999999?(g.cross(a,b,e),g.length(a)<1e-6&&g.cross(a,c,e),g.normalize(a,a),m.setAxisAngle(d,a,Math.PI),d):h>.999999?(d[0]=0,d[1]=0,d[2]=0,d[3]=1,d):(g.cross(a,e,f),d[0]=a[0],d[1]=a[1],d[2]=a[2],d[3]=1+h,m.normalize(d,d))}}(),m.setAxes=function(){var a=k.create();return function(b,c,d,e){return a[0]=d[0],a[3]=d[1],a[6]=d[2],a[1]=e[0],a[4]=e[1],a[7]=e[2],a[2]=c[0],a[5]=c[1],a[8]=c[2],m.normalize(b,m.fromMat3(b,a))}}(),m.clone=h.clone,m.fromValues=h.fromValues,m.copy=h.copy,m.set=h.set,m.identity=function(a){return a[0]=0,a[1]=0,a[2]=0,a[3]=1,a},m.setAxisAngle=function(a,b,c){c*=.5;var d=Math.sin(c);return a[0]=d*b[0],a[1]=d*b[1],a[2]=d*b[2],a[3]=Math.cos(c),a},m.add=h.add,m.multiply=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=c[0],i=c[1],j=c[2],k=c[3];return a[0]=d*k+g*h+e*j-f*i,a[1]=e*k+g*i+f*h-d*j,a[2]=f*k+g*j+d*i-e*h,a[3]=g*k-d*h-e*i-f*j,a},m.mul=m.multiply,m.scale=h.scale,m.rotateX=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+g*h,a[1]=e*i+f*h,a[2]=f*i-e*h,a[3]=g*i-d*h,a},m.rotateY=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i-f*h,a[1]=e*i+g*h,a[2]=f*i+d*h,a[3]=g*i-e*h,a},m.rotateZ=function(a,b,c){c*=.5;var d=b[0],e=b[1],f=b[2],g=b[3],h=Math.sin(c),i=Math.cos(c);return a[0]=d*i+e*h,a[1]=e*i-d*h,a[2]=f*i+g*h,a[3]=g*i-f*h,a},m.calculateW=function(a,b){var c=b[0],d=b[1],e=b[2];return a[0]=c,a[1]=d,a[2]=e,a[3]=-Math.sqrt(Math.abs(1-c*c-d*d-e*e)),a},m.dot=h.dot,m.lerp=h.lerp,m.slerp=function(a,b,c,d){var e,f,g,h,i,j=b[0],k=b[1],l=b[2],m=b[3],n=c[0],o=c[1],p=c[2],q=c[3];return f=j*n+k*o+l*p+m*q,f<0&&(f=-f,n=-n,o=-o,p=-p,q=-q),1-f>1e-6?(e=Math.acos(f),g=Math.sin(e),h=Math.sin((1-d)*e)/g,i=Math.sin(d*e)/g):(h=1-d,i=d),a[0]=h*j+i*n,a[1]=h*k+i*o,a[2]=h*l+i*p,a[3]=h*m+i*q,a},m.invert=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3],g=c*c+d*d+e*e+f*f,h=g?1/g:0;return a[0]=-c*h,a[1]=-d*h,a[2]=-e*h,a[3]=f*h,a},m.conjugate=function(a,b){return a[0]=-b[0],a[1]=-b[1],a[2]=-b[2],a[3]=b[3],a},m.length=h.length,m.len=m.length,m.squaredLength=h.squaredLength,m.sqrLen=m.squaredLength,m.normalize=h.normalize,m.fromMat3=function(){var a="undefined"!=typeof Int8Array?new Int8Array([1,2,0]):[1,2,0];return function(b,c){var d,e=c[0]+c[4]+c[8];if(e>0)d=Math.sqrt(e+1),b[3]=.5*d,d=.5/d,b[0]=(c[7]-c[5])*d,b[1]=(c[2]-c[6])*d,b[2]=(c[3]-c[1])*d;else{var f=0;c[4]>c[0]&&(f=1),c[8]>c[3*f+f]&&(f=2);var g=a[f],h=a[g];d=Math.sqrt(c[3*f+f]-c[3*g+g]-c[3*h+h]+1),b[f]=.5*d,d=.5/d,b[3]=(c[3*h+g]-c[3*g+h])*d,b[g]=(c[3*g+f]+c[3*f+g])*d,b[h]=(c[3*h+f]+c[3*f+h])*d}return b}}(),m.str=function(a){return"quat("+a[0]+", "+a[1]+", "+a[2]+", "+a[3]+")"},void 0!==a&&(a.quat=m)}(b.exports)}(this),define("client/buildingwaypoints",["require","data/buildingcode"],function(a){var b=a("data/buildingcode"),c={NE:0,SE:1,SW:2,NW:3},d={},e=d[b.road]={};e[c.NE+1|c.SE+1<<8]=[[12,0,8],[-8,0,8],[-8,0,-12]],e[c.NE+1|c.SW+1<<8]=[[12,0,8],[-12,0,8]],e[c.NE+1|c.NW+1<<8]=[[12,0,8],[8,0,8],[8,0,12]],e[c.SE+1|c.NE+1<<8]=[[8,0,-12],[8,0,-8],[12,0,-8]],e[c.SE+1|c.SW+1<<8]=[[8,0,-12],[8,0,8],[-12,0,8]],e[c.SE+1|c.NW+1<<8]=[[8,0,-12],[8,0,12]],e[c.SW+1|c.NE+1<<8]=[[-12,0,-8],[12,0,-8]],e[c.SW+1|c.SE+1<<8]=[[-12,0,-8],[-8,0,-8],[-8,0,-12]],e[c.SW+1|c.NW+1<<8]=[[-12,0,-8],[8,0,-8],[8,0,12]],e[c.NW+1|c.NE+1<<8]=[[-8,0,12],[-8,0,-8],[12,0,-8]],e[c.NW+1|c.SE+1<<8]=[[-8,0,12],[-8,0,-12]],e[c.NW+1|c.SW+1<<8]=[[-8,0,12],[-8,0,8],[-12,0,8]],e[c.NE+1]=[[0,0,0]],e[c.SE+1]=[[0,0,0]],e[c.SW+1]=[[0,0,0]],e[c.NW+1]=[[0,0,0]],e[c.NE+1<<8]=[[0,0,0]],e[c.SE+1<<8]=[[0,0,0]],e[c.SW+1<<8]=[[0,0,0]],e[c.NW+1<<8]=[[0,0,0]];var f=d[b.house0]={};return f[1]=[[0,0,0]],f[2]=[[0,0,0]],f[3]=[[0,0,0]],f[4]=[[0,0,0]],f[256]=[[0,0,0]],f[512]=[[0,0,0]],f[768]=[[0,0,0]],f[1024]=[[0,0,0]],d}),define("client/pathfinding/node",["require"],function(a){function b(){this.nodeId=c++,this.connectedNodes=[]}var c=0;return b.prototype.nodeId=null,b.prototype.graph=null,b.prototype.cost=1,b.prototype.connectedNodes=null,b.prototype.getConnectableNodes=function(){throw"Not implemented"},b.prototype.connect=function(a){return-1===this.connectedNodes.indexOf(a)&&(this.connectedNodes.push(a),this)},b.prototype.disconnect=function(a){var b=this.connectedNodes.indexOf(a);-1!==b&&this.connectedNodes.splice(b,1)},b.prototype.addTo=function(a){this.graph=a;for(var b=this.getConnectableNodes(),c=0;c<b.length;c++){var d=b[c].connect(this);!1!==d&&this.connect(d)}},b.prototype.remove=function(){for(var a,b=this.connectedNodes.slice(0),c=b.length,d=0;d<c;d++)a=b[d],a.disconnect(this),this.disconnect(a)},b.prototype.toString=function(){return"Node #"+this.nodeId},b}),define("client/pathfinding/buildingnode",["require","./node"],function(a){function b(a){c.call(this),this.building=a}var c=a("./node");return b.prototype=Object.create(c.prototype),b.prototype.building=null,b.prototype.road=!1,b.prototype.getConnectableNodes=function(){var a=this.building.staticData,b=this.building.data,c=[],d=a.roadGates;if(void 0!==d)for(var e=0;e<d.length;e++){var f=d[e],g=f[0]+b.x,h=f[1]+b.y,i=vkaria.roadman.getRoad(g,h);null!==i&&c.push(i.node)}return c},b.prototype.connect=function(a){if(!0===a.road){var b=a.building.data,d=b.x,e=b.y,f=this.building.staticData,b=this.building.data,g=f.roadGates;if(void 0!==g)for(var h=0;h<g.length;h++){var i=g[h],j=i[0]+b.x,k=i[1]+b.y;if(d===j&&e===k)return c.prototype.connect.call(this,a),this}}return!1},b.prototype.getGate=function(a){if(!a)return null;for(var b=a.building,c=b.data.x,d=b.data.y,e=this.building.data.x,f=this.building.data.y,g=this.building.staticData.roadGates,h=0;h<g.length;h++){var i=g[h];if(i[0]===c-e&&i[1]===d-f)return h}},b.prototype.getPath=function(a,b){var c=this.getGate(a),d=this.getGate(b);return this.building.getPath(c,d)},b}),define("client/components/smokeScript",["engine/main"],function(a){function b(){a.Component.call(this)}return b.prototype=Object.create(a.Component.prototype),b.prototype.ttl=1600,b.prototype.startedAt=0,b.prototype.spriten=0,b.prototype.start=function(){var b=this.gameObject.addComponent(new a.SpriteRenderer);b.layer=vkaria.layers.buildingsLayer,b.setSprite(vkaria.sprites.getSprite("smoke.png")),b.setPivot(4,4),this.spriten=0;var c=this.gameObject.world.logic.time;this.startedAt=c.time},b.prototype.tick=function(a){var b=a.dt/1e3;this.gameObject.transform.translate(Math.random()*b,20*b,Math.random()*b,"world");var c=this.gameObject.world.logic.time.time-this.startedAt;1==this.spriten&&c>2*this.ttl/3?(this.gameObject.spriteRenderer.setSprite(vkaria.sprites.getSprite("smoke2.png")),this.spriten=2):0==this.spriten&&c>1*this.ttl/3&&(this.gameObject.spriteRenderer.setSprite(vkaria.sprites.getSprite("smoke1.png")),this.spriten=1),c>this.ttl&&this.gameObject.destroy()},b}),define("client/components/smokesource",["require","engine/main","./smokeScript"],function(a){function b(){c.Component.call(this)}var c=a("engine/main"),d=a("./smokeScript"),e=[],f=function(){this.world.removeGameObject(this),e.push(this)},g=function(){if(e.length>0)return e.pop();var a=new c.GameObject,b=new d;return a.addComponent(b),a.smoke=b,a.destroy=f,a},h=new Float32Array(3);return b.prototype=Object.create(c.Component.prototype),b.prototype.start=function(){this.time=this.gameObject.world.logic.time.now},b.prototype.tick=function(a){a.now-this.time>300&&(this.spawnSmoke(),this.time=a.now)},b.prototype.spawnSmoke=function(){var a=g();this.gameObject.transform.getPosition(h),a.transform.setPosition(h[0],h[1],h[2]),this.gameObject.world.addGameObject(a)},b}),define("client/config",["require","namespace"],function(a){return a("namespace")("Isometrica.Client").Config={tileSize:45.255,tileZStep:9.238,chunkSize:window.matchMedia("(max-width: 800px)").matches?8:24}}),define("client/buildingview",["require","engine/main","client/renderlayer","./components/smokesource","./config","core/buildingstate","core/main"],function(a){function b(){this.gameObject=new c.GameObject("building")}var c=a("engine/main"),d=a("client/renderlayer"),e=a("./components/smokesource"),f=a("./config"),g=a("core/buildingstate"),h=a("core/main"),i=h.Terrain;return b.prototype.gameObject=null,b.prototype.building=null,b.prototype.setBuilding=function(a){this.building=a},b.prototype.update=function(){var a=this.building;if(null!==a&&null!==a.staticData){for(var b=a.staticData,h=f.tileSize,j=f.tileZStep,k=this.gameObject.transform.children,l=k.length,m=0;m<l;m++){k[m].gameObject.destroy()}if(a.data.getState()===g.underConstruction){var n=0,o=0;this.building.data.rotation,n=b.sizeX,o=b.sizeY;for(var p=0;p<n;p++)for(var q=0;q<o;q++){var r=new c.GameObject,s=new c.SpriteRenderer;s.layer=d.buildingsLayer,s.setSprite(vkaria.sprites.getSprite("site.png")).setPivot(32,24),r.addComponent(s),this.gameObject.transform.addChild(r.transform),r.transform.translate(p*f.tileSize,0,q*f.tileSize)}}else if(a.data.getState()===g.ready){var t;if(a.data.rotation&&b.spritesRotate)t=b.spritesRotate;else if(b.sprites)var t=b.sprites;for(var l=t.length,m=0;m<l;m++){var u=t[m],v=new c.SpriteRenderer;v.layer=u.layer,v.setSprite(vkaria.sprites.getSprite(u.path)),v.pivotX=u.pivotX,v.pivotY=u.pivotY;var w=new c.GameObject;w.addComponent(v),this.gameObject.transform.addChild(w.transform),w.transform.setLocalPosition(u.x*h,u.y*j,u.z*h)}if(void 0!==b.smokeSource){var x=new c.GameObject;x.transform.setLocalPosition(b.smokeSource[0]*h,b.smokeSource[1]*j,b.smokeSource[2]*h),x.addComponent(new e),this.gameObject.transform.addChild(x.transform)}}var y=this.building.data,p=i.extractX(y.tile),q=i.extractY(y.tile),z=vkaria.core.world.terrain.getGridPointHeight(p+1,q);this.gameObject.transform.setPosition(p*h,z*j,q*h)}},b.prototype.render=function(){null===this.gameObject.world&&vkaria.game.logic.world.addGameObject(this.gameObject)},b}),define("client/building",["require","engine/main","core/main","./vendor/gl-matrix","data/classcode","client/buildingwaypoints","./pathfinding/buildingnode","./buildingview"],function(a){function b(a){this.root=a,this.view=new j,this.view.setBuilding(this)}var c=(a("engine/main"),a("core/main")),d=a("./vendor/gl-matrix"),e=c.BuildingData,f=e,g=a("data/classcode"),h=a("client/buildingwaypoints"),i=a("./pathfinding/buildingnode"),j=a("./buildingview");return b.prototype.gameObject=null,b.prototype.data=null,b.prototype.staticData=null,b.prototype.node=null,b.prototype.setData=function(a){this.data=a,this.staticData=f[a.buildingCode],null===this.node&&(this.staticData.classCode===g.road?this.node=new RoadNode(this):this.node=new i(this)),this.view.update(),this.view.render()},b.prototype.destroy=function(){this.view.gameObject.destroy()},b.prototype.getPath=function(a,b){null===a||void 0===a?a=0:a+=1,null===b||void 0===b?b=0:b+=1;var c=h[this.data.buildingCode][a|b<<8],e=[];if(!c)return e;for(var f=0;f<c.length;f++){var g=[];d.vec3.transformMat4(g,c[f],this.view.gameObject.transform.localToWorld),e.push(g)}return e},b.prototype.model=function(){return this.data},b}),define("client/pathfinding/roadnode",["require","./buildingnode","./node","engine/main"],function(a){function b(a){c.call(this,a)}var c=a("./buildingnode"),d=a("./node");a("engine/main");return b.prototype=Object.create(c.prototype),b.prototype.road=!0,b.prototype.getConnectableNodes=function(){var a,b=[],c=this.building.data.x,d=this.building.data.y,e=vkaria.buildman;return a=e.getBuilding(c+1,d),null!==a&&b.push(a.node),a=e.getBuilding(c,d+1),null!==a&&b.push(a.node),a=e.getBuilding(c-1,d),null!==a&&b.push(a.node),a=e.getBuilding(c,d-1),null!==a&&b.push(a.node),b},b.prototype.connect=d.prototype.connect,b}),define("client/roadview",["require","engine/main","client/renderlayer","./config","core/main"],function(a){function b(){this.gameObject=new c.GameObject("building")}var c=a("engine/main"),d=a("client/renderlayer"),e=a("./config"),f=a("core/main"),g=f.Terrain,h={90001:"road/straight1.png",90010:"road/straight2.png",90011:"road/turn3.png",90100:"road/straight1.png",90101:"road/straight1.png",90110:"road/turn2.png",90111:"road/t2.png",91e3:"road/straight2.png",91001:"road/turn1.png",91010:"road/straight2.png",91011:"road/t3.png",91100:"road/turn4.png",91101:"road/t4.png",91110:"road/t1.png",91111:"road/x1.png",1:"road/elevation1.png",2:"road/elevation2.png",3:"road/elevation3.png",4:"road/elevation4.png"};return b.prototype.gameObject=null,b.prototype.building=null,b.prototype.setRoad=function(a){this.road=a},b.prototype.update=function(){var a=this.road;if(null!==a&&null!==a.staticData){var b=(a.staticData,e.tileSize),f=e.tileZStep;if(0===this.gameObject.transform.children.length){var i=new c.GameObject,j=new c.SpriteRenderer;j.layer=d.roadLayer,j.setSprite(vkaria.sprites.getSprite(h[this.road.typeCode])).setPivot(32,24),i.addComponent(j),this.gameObject.transform.addChild(i.transform),i.transform.translate(0,0,0)}else this.gameObject.transform.children[0].gameObject.spriteRenderer.setSprite(vkaria.sprites.getSprite(h[this.road.typeCode]));var k=a.data,l=g.extractX(k.tile),m=g.extractY(k.tile),n=vkaria.core.world.terrain.getHeight(l+.5,m+.5);this.gameObject.transform.setPosition(l*b,n*f,m*b)}},b.prototype.render=function(){null===this.gameObject.world&&vkaria.game.logic.world.addGameObject(this.gameObject)},b}),define("client/road",["require","core/main","engine/main","./building","./pathfinding/roadnode","./roadview"],function(a){function b(a){this.root=a,this.view=new h,this.view.setRoad(this)}var c=a("core/main"),d=(a("engine/main"),a("./building")),e=c.BuildingData,f=e,g=a("./pathfinding/roadnode"),h=a("./roadview"),i=c.Terrain;return b.prototype=Object.create(d.prototype),b.prototype.typeCode=91111,b.prototype.setData=function(a){this.data=a,this.staticData=f[a.buildingCode],null===this.node&&(this.node=new g(this)),this.view.update(),this.view.render()},b.prototype.updateProfile=function(){var a,b=this.data.tile,c=this.root.core.terrain.tileSlope(b),d=this.root.roadman,e=d.getRoad(b+1),f=d.getRoad(b+i.dy),g=d.getRoad(b-1),h=d.getRoad(b-i.dy);if(i.isSlope(c))c===i.SlopeType.AB?a=1:c===i.SlopeType.AC?a=2:c===i.SlopeType.CD?a=3:c===i.SlopeType.BD&&(a=4);else{if(9e4===(a=9e4+1e3*(null!==g)+100*(null!==h)+10*(null!==e)+(null!==f)))return}return this.typeCode=a,this.view.update(),this.view.render(),a},b}),define("client/chunk",["require","./config","core/main"],function(a){function b(a,b){this.tile0=a,this.tile1=b}var c=(a("./config"),a("core/main")),d=c.TileIterator;c.Terrain;return b.prototype.tile0=-1,b.prototype.tile1=-1,b.prototype.tiles=function(){return new d(this.tile0,this.tile1)},b}),define("client/gameObjects/tile",["require","engine/main","../renderlayer"],function(a){function b(){d.init(this,"tile"),h=new e,h.setPivot(32,24),h.layer=g,this.addComponent(h)}var c=a("engine/main"),d=c.GameObject,e=c.SpriteRenderer,f=a("../renderlayer"),g=f.groundLayer,h=null;return b.prototype=Object.create(d.prototype),b}),define("client/tilesman",["require","engine/main","./config","events","./gameObjects/tile","core/main"],function(a){function b(a){this.chunkSize=c.chunkSize,this.events=f,this.events.loadedTiles=0,this.events.removedTiles=1,this.chunks=[];var b=this;this.onCameraMove=function(a){var d=a.getPosition(g);b.currentChunkX=d[0]/c.tileSize/c.chunkSize|0,b.currentChunkY=d[2]/c.tileSize/c.chunkSize|0,b.loadChunks2(b.currentChunkX,b.currentChunkY)}}var c=(a("engine/main"),a("./config")),d=a("events"),e=(a("./gameObjects/tile"),a("core/main")),f={tileLoad:0,tileRemove:1};b.events=f;var g=new Float32Array(3);return b.prototype.constructor=b,b.prototype.mainCamera=null,b.prototype.chunkSize=24,b.prototype.currentChunkX=0,b.prototype.currentChunkY=0,b.prototype.start=function(){var a=vkaria.game.logic.world.findByName("mainCamera");a.transform.addEventListener(a.transform.events.update,this.onCameraMove),d.on(vkaria.core.terrain,e.Terrain.events.gridUpdate,function(a,b,c){c.updateChunks()},this),this.onCameraMove(a.transform)},b.prototype.updateChunks=function(){for(var a=this.currentChunkX,b=this.currentChunkY,c=0;c<9;c++){var d=c/3|0,e=c-3*d,f=a+d-1,g=b+e-1;vkaria.terrain.clear(f*this.chunkSize,g*this.chunkSize,this.chunkSize,this.chunkSize),vkaria.terrain.draw(f*this.chunkSize,g*this.chunkSize,this.chunkSize,this.chunkSize)}},b.prototype.getCurrentChunks=function(){for(var a=this.currentChunkX,b=this.currentChunkY,c=[],d=0;d<9;d++){var e=d/3|0,f=d-3*e,g=a+e-1,h=b+f-1;c.push({x:g*this.chunkSize,y:h*this.chunkSize})}return c},b.prototype.loadChunks2=function(a,b){console.log("Load chunks"),a=a||this.currentChunkX,b=b||this.currentChunkY;for(var c=0;c<9;c++){var e=c/3|0,g=c-3*e,h=a+e-1,i=b+g-1;if(!1===this.getChunk(h,i)&&h>=0&&i>=0){this.makeChunk(h,i);var j=this;d.fire(j,f.tileLoad,{meta:{x:h*j.chunkSize,y:i*j.chunkSize,
w:j.chunkSize,h:j.chunkSize}}),vkaria.terrain.draw(h*this.chunkSize,i*this.chunkSize,this.chunkSize,this.chunkSize),this.cleanChunks()}}},b.prototype.makeChunk=function(a,b){if(!this.getChunk(a,b)&&a>=0&&b>=0){return void 0==this.chunks[a]&&(this.chunks[a]=[]),this.chunks[a][b]=!0}return!1},b.prototype.getChunk=function(a,b){return a>=0&&b>=0&&void 0!==this.chunks[a]&&void 0!==this.chunks[a][b]&&this.chunks[a][b]},b.prototype.removeChunk=function(a,b){!1!==this.getChunk(a,b)&&(this.chunks[a][b]=void 0),d.fire(this,this.events.removedTiles,{x:a*this.chunkSize,y:b*this.chunkSize,w:this.chunkSize,h:this.chunkSize})},b.prototype.cleanChunks=function(){var a,b,c=this.chunks;for(a=0;a<c.length;a++)if(void 0!==c[a])for(b=0;b<c[a].length;b++)void 0!==c[a][b]&&(Math.abs(a-this.currentChunkX)>1||Math.abs(b-this.currentChunkY)>1)&&(this.removeChunk(a,b),vkaria.terrain.clear(a*this.chunkSize,b*this.chunkSize,this.chunkSize,this.chunkSize))},b}),define("client/chunkman",["require","core/main","./chunk","./tilesman","./config","events"],function(a){function b(a,b,c){var d=i.convertToIndex(b.meta.x,b.meta.y),e=i.convertToIndex(b.meta.x+b.meta.w-1,b.meta.y+b.meta.h-1),g=new f(d,e);c._chunks[d+";"+e]=g,j.fire(c,k.chunkLoad,g)}function c(a,b,c){var d=i.convertToIndex(b.x,b.y),e=i.convertToIndex(b.x+b.w-1,b.y+b.h-1),g=new f(d,e);delete c._chunks[d+";"+e],j.fire(c,k.chunkRemove,g)}function d(a){this._chunks={},this.root=a}var e=a("core/main"),f=a("./chunk"),g=a("./tilesman"),h=a("./config"),i=e.Terrain,j=a("events"),k={chunkLoad:0,chunkRemove:1,chunkUnload:1};return d.events=k,d.prototype.init=function(){var a=this.root.tilesman,d=a.getCurrentChunks();for(var e in d){var k=d[e],l=i.convertToIndex(k.x,k.y),m=i.convertToIndex(k.x+h.chunkSize-1,k.y+h.chunkSize-1);this._chunks[l+";"+m]=new f(l,m)}j.on(a,g.events.tileLoad,b,this),j.on(a,g.events.tileRemove,c,this)},d.prototype.getChunks=function(){var a=[];for(var b in this._chunks)a.push(this._chunks[b]);return a},d}),define("client/components/camerascript",["require","engine/main","../vendor/gl-matrix","events"],function(a){function b(){c.Component.call(this);var a=this,b=null,d=null,e=!1,f=null;this.onPointerDown=function(a,c){f=c,b=[c.gameViewportX,c.gameViewportY],d=[0,0],e=!1},this.onPointerUp=function(c,f){null!==b&&(e?(a.dispatchEvent(a.events.inputDragEnd,f),e=!1):a.dispatchEvent(a.events.inputClick,f),d=null,b=null)},this.onPointerMove=function(c,g){if(null!==b){var h=g.gameViewportX-b[0],i=g.gameViewportY-b[1];d[0]+=h,d[1]+=i,b[0]=g.gameViewportX,b[1]=g.gameViewportY,!e&&Math.sqrt(Math.pow(d[0],2)+Math.pow(d[1],2))>2&&(e=!0,a.dispatchEvent(a.events.inputDragStart,f)),e&&a.dispatchEvent(a.events.inputDrag,{e:g,dx:h,dy:i})}a.dispatchEvent(a.events.inputMove,g)},this.onPointerOut=function(c,f){null!==b&&(d=null,b=null,e&&a.dispatchEvent(a.events.inputDragEnd,f))}}var c=a("engine/main"),d=a("../vendor/gl-matrix"),e=a("events"),f={inputMove:0,inputClick:1,inputDragStart:2,inputDragEnd:3,inputDrag:4};b.events=f,b.prototype=Object.create(c.Component.prototype),b.prototype.events=f,b.prototype.constructor=b;var g=document.createElement("canvas").getContext("2d"),h=new Float32Array(3),i=new Float32Array(3),j=Math.cos(45*Math.PI/180);return g.canvas.width=256,g.canvas.height=256,b.prototype.target=null,b.prototype.onTargetUpdate=null,b.prototype.onPointerMove=null,b.prototype.onPointerDown=null,b.prototype.onPointerUp=null,b.prototype.onPointerOut=null,b.prototype.panSens=1,b.prototype._lock=!1,b.prototype.lock=function(a){if(void 0===a)return this._lock;this._lock=a},b.prototype.awake=function(){var a=this.gameObject.camera,b=this;a.addEventListener(a.events.viewportSet,function(a){var c=a.viewport;e.on(c,c.events.pointerdown,b.onPointerDown),e.on(c,c.events.pointerup,b.onPointerUp),e.on(c,c.events.pointermove,b.onPointerMove),e.on(c,c.events.pointerout,b.onPointerOut)}),a.addEventListener(a.events.viewportRemoved,function(a){var c=a.viewport;c.removeEventListener(c.events.pointerdown,b.onPointerDown),c.removeEventListener(c.events.pointerup,b.onPointerUp),c.removeEventListener(c.events.pointermove,b.onPointerMove),c.removeEventListener(c.events.pointerout,b.onPointerOut)}),this.gameObject.transform.setPosition(1000000.123,0,1000000.645),this.gameObject.transform.rotate(30,45,0,"self")},b.prototype.setGameObject=function(a){c.Component.prototype.setGameObject.call(this,a),a.cameraScript=this},b.prototype.setTarget=function(a){if(null!==this.target)this.removeTarget();else{var c=a.gameObject.transform;this.target=a,this.onTargetUpdate=function(a){b.prototype.moveTo(a)},c.addEventListener(c.events.update,this.onTargetUpdate)}},b.prototype.unsetTarget=function(){if(null!==this.target){var a=this.target.gameObject.transform;this.target=null,a.removeEventListener(a.events.update,this.onTargetUpdate)}},b.prototype.moveTo=function(a){var b=a.getPosition();this.gameObject.transform.setPosition(b[0],0,b[2])},b.prototype.pan=function(a,b){this._lock||this.gameObject.transform.translate((-a*j+b/j)/this.panSens,0,(a*j+b/j)/this.panSens,"world")},b.prototype.pickGameObject=function(a,b,c){for(var e,f,j,k,l,m,n,o=d.vec3,p=this.gameObject.world.retrieve(this.gameObject),q=p.length,r=this.gameObject.camera,s=r.getWorldToScreen(),t=r.getWorldToViewport(),u=c||[],v=0;v<q;v++)if(e=p[v],e.transform.getPosition(h),o.transformMat4(i,h,t),!(Math.abs(i[0])>1||Math.abs(i[1])>1))if(o.transformMat4(h,h,s),f=e.spriteRenderer,j=e.textRenderer,void 0!==f&&f.enabled){var w=f.sprite,x=w.width,y=w.height;k=h[0]-f.pivotX,l=h[1]-f.pivotY,m=k+w.width,n=l+w.height,a>=k&&a<=m&&b>=l&&b<=n&&(g.clearRect(0,0,x,y),g.drawImage(w.sourceImage,w.offsetX,w.offsetY,x,y,0,0,x,y),g.getImageData(a-k,b-l,1,1).data[3]>0&&u.push(e))}else void 0!==j&&j.enabled&&(k=h[0],l=h[1],a>=k-20&&a<=k+20&&b>=l-20&&b<=l+20&&u.push(e));return u},b}),function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define("vendor/reactive-property",[],a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.reactiveProperty=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){function d(a){var b,c=a._subs;for(var d in c)b=c[d],a.change().off(b.token);c.length=0}function e(a,b){var c=a._val;if(Array.isArray(c))for(var d in c)f(a,c[d],b);else f(a,c,b)}function f(a,b,c){"function"==typeof b&&void 0!==b.onChange&&a._subs.push(b.onChange(function(){a.change(c,c())}))}function g(a,b,c,f){var g=a._val,h=a._validator;return void 0===c?g:null!==h&&!h(c)||g===c?b:(a._oldVal=g,a._val=c,d(a),e(a,b),void 0!==f&&f||a.change(b,c),b)}function h(a,b,c,d,e){var f=a.change().on(c,e);return!0===d&&c(b,b(),e),f}function i(a,b){return a.change().off(b)}function j(a,b,c,d,e){return"function"==typeof c?h(a,b,c,d,e):i(a,c)}function k(a){this.change=m.event("change"),this._validator=a||null,this._subs=[]}function l(a,b){var c,d=new k(b);return c=function(a,b){return g(d,c,a,b)},c.onChange=function(a,b,e){return j(d,c,a,b,e)},c.old=function(){return d._oldVal},g(d,c,a,!0),c}var m=a("../vendor/events/events.js");k.prototype._validator=null,k.prototype._subs=null,k.prototype._val=void 0,k.prototype._oldVal=void 0,b.exports=l},{"../vendor/events/events.js":3}],2:[function(a,b,c){function d(a,b){var c=a._subs,d=a._subsArr,e=d.indexOf(c[b]);return-1!==e&&(d[e]=void 0,delete c[b],!0)}function e(a,b){var c,d,e=a._subs,f=a._subsArr,g=f.length;for(d=0;d<g;d++)if(void 0!==(c=f[d])&&c.handler===b)return f[d]=void 0,delete e[c.token],!0;return!1}function f(a,b){return"function"==typeof b?e(a,b):d(a,b)}function g(a,b,c,d){if("function"!=typeof b)throw"Event handler should be a function";var e=a._lastToken++,f=new k(e,b,c,d);return a._subsArr.push(f),a._subs[e]=f,e}function h(a,b,c){return g(a,b,c,!0)}function i(a,b,c){var e,f,g=a._subsArr,h=g.length,i=!1;for(e=0;e<h;e++)f=g[e],void 0!==f?(f.once&&d(a,f.token),(0,f.handler)(b,c,f.data)):i=!0;if(!0===i)for(e=h-1;-1!==e;e--)void 0===g[e]&&g.splice(e,1)}function j(){this._subsArr=[],this._subs=Object.create(null),this._lastToken=0}var k=a("./subscription");j.on=g,j.off=f,j.once=h,j.fire=i,j.prototype._subs=null,j.prototype._subsArr=null,j.prototype.on=function(a,b){return g(this,a,b)},j.prototype.once=function(a,b){return h(this,a,b)},j.prototype.off=function(a){return f(this,a)},j.prototype.fire=function(a,b){return i(this,a,b)},b.exports=j},{"./subscription":4}],3:[function(a,b,c){function d(a,b){var c,d=a._events;return void 0===d&&(d=a._events=Object.create(null)),c=d[b],void 0===c&&(c=d[b]=new l),c}function e(a,b,c,e){return(0,l.on)(d(a,b),c,e)}function f(a,b,c,e){return(0,l.once)(d(a,b),c,e)}function g(a,b,c){var d,e=l.off;return void 0!==a._events&&void 0!==a._events[b]&&(d=a._events[b],e(d,c))}function h(a,b,c,d){var e,f;return void 0===d?(e=a,f=c):(e=c,f=d),i(a,b,e,f)}function i(a,b,c,d){if(void 0!==a._events&&void 0!==a._events[b]){(0,l.fire)(a._events[b],c,d)}}function j(a){function b(b,c){return void 0===b&&void 0===c?d(this,a):i(this,a,b,c)}return b}function k(){this.on=e,this.once=f,this.off=g,this.fire=h,this.event=j,this.Event=l}var l=a("./event");b.exports=new k},{"./event":2}],4:[function(a,b,c){function d(a,b,c,d){this.handler=b,this.data=c,this.once=d||!1,this.token=a}d.prototype.token=-1,d.prototype.handler=null,d.prototype.data=null,d.prototype.once=null,b.exports=d},{}]},{},[1])(1)}),define("client/areaselector",["require","engine/main","./renderlayer","./components/camerascript","events","core/main","reactive-property"],function(a){function b(a){for(var b=a,c=b.length,d=0;d<c;d++)if(b[d].spriteRenderer.layer===j.groundLayer)return b[d];return!1}function c(a,c,d){var e=b(a._cam.pickGameObject(c,d));return e&&a._terrain.getCoordinates(e)||-1}function d(a,b,d){var e=b.gameViewportX,f=b.gameViewportY,g=c(d,e,f);d._tile0(g,!0),d._tile1(g)}function e(a,b,d){var e=b.gameViewportX,f=b.gameViewportY,g=c(d,e,f);d._tile0(g,!0),d._tile1(g)}function f(a,b,d){var e=b.e,f=e.gameViewportX,g=e.gameViewportY,h=c(d,f,g);d._tile1(h)}function g(a,b,c){l.fire(c,o.change)}function h(a,b,c){l.off(c)}function i(a){this.root=a,this._tile0=n(-1),this._tile1=n(-1),this._terrain=a.terrain;var b=this._cam=a.camera.cameraScript,c=l.on(b,k.events.inputClick,d,this),i=l.on(b,k.events.inputDragStart,e,this),j=l.on(b,k.events.inputDrag,f,this),m=this._tile0.onChange(g,!1,this),p=this._tile1.onChange(g,!1,this);l.once(this,o.dispose,h,c),l.once(this,o.dispose,h,i),l.once(this,o.dispose,h,j),l.once(this,o.dispose,h,m),l.once(this,o.dispose,h,p)}var j=(a("engine/main"),a("./renderlayer")),k=a("./components/camerascript"),l=a("events"),m=a("core/main"),n=a("reactive-property"),o=(m.Terrain,{change:0,dispose:1});return i.events=o,i.prototype._tile0=-1,i.prototype._tile1=-1,i.prototype.selectedTiles=function(){var a=this._tile0(),b=this._tile1();return-1!==a&&-1!==b&&new m.TileIterator(a,b)||null},i.prototype.dispose=function(){l.fire(this,o.dispose)},i.prototype.tile0=function(){return this._tile0()},i.prototype.tile1=function(){return this._tile1()},i}),define("client/buildman",["require","core/main","engine/main","data/classcode","./building","./road","events","events","./chunkman","./areaselector"],function(a){function b(a,b){var c=s.extractX(b),d=s.extractY(b);return void 0!==a.buildingByXY[c]&&void 0!==a.buildingByXY[c][d]?a.buildingByXY[c][d]:null}function c(a,b,c){var d=s.extractX(b),e=s.extractY(b);void 0===a.buildingByXY[d]&&(a.buildingByXY[d]=[]),a.buildingByXY[d][e]=c}function d(a,b){var c,d=s.extractX(b),e=s.extractY(b);return void 0!==a.buildingByXY[d]&&void 0!==a.buildingByXY[d][e]&&(c=a.buildingByXY[d][e],r.fire(a,a.events.buildingRemoved,c),c.destroy(),c.data.permanent||c.data.dispose(),delete a.buildingByXY[d][e]),c}function e(a,b){var d;return d=b.data.classCode===n.road?new p(a.root):new o(a.root),d.setData(b),c(a,b.tile,d),r.fire(a,a.events.buildingAdded,d),d}function f(a,c){var d,e=c.tile;return d=b(a,e),d.setData(c),d}function g(a,b,c){for(var d,f,g=b.tiles(),h=c.root.core.buildingService;!g.done;)d=u.next(g),null!==(f=h.get(d))&&void 0!==f&&e(c,f)}function h(a,b,c){for(var e,f=b.tiles();!f.done;)e=u.next(f),d(c,e)}function i(a,b,c){e(c,b)}function j(a,b,c){f(c,b)}function k(a,b,c){d(c,b.tile)}function l(a){q.call(this),this.buildingByXY=[],this.root=a}var m=a("core/main"),n=(a("engine/main"),a("data/classcode")),o=a("./building"),p=a("./road"),q=a("events"),r=a("events"),s=m.Terrain,t=a("./chunkman"),u=m.TileIterator,s=m.Terrain,v=m.ConstructionService,w=a("./areaselector"),x={buildingAdded:0,buildingRemoved:1,buildingAdd:0,buildingRemove:1,buildingLoad:0,buildingUnload:1};return l.events=x,l.prototype=Object.create(q.prototype),l.prototype.events=x,l.prototype.start=function(){r.on(this.root.chunkman,t.events.chunkLoad,g,this),r.on(this.root.chunkman,t.events.chunkUnload,h,this);var a=this.root.core;r.on(a.constructionService,v.events.buildingBuilt,i,this),r.on(a.constructionService,v.events.buildingUpdated,j,this),r.on(a.constructionService,v.events.buildingRemoved,k,this)},l.prototype.getBuilding=function(a,c){var d;return d=2===arguments.length?s.convertToIndex(a,c):a,b(this,d)},l.prototype.destroy=function(){var a=this.root;a.ui.gameScreen().worldScreen().showHint("Pick a tile that you want to clear!"),a.camera.cameraScript.lock(!0);var b=[],c=new w(this.root),d=r.on(c,w.events.change,function(d,e,f){a.hiliteMan.disable(b),b=a.hiliteMan.hilite({tile0:c.tile0(),tile1:c.tile1(),fillColor:"rgba(127,0,0,0.4)",borderColor:"rgba(255,0,0,0.4)",borderWidth:2})}),e=a.ui.gameScreen().showActionControls();e.onSubmit=function(){var e,f=c.selectedTiles();if(null!==f)for(;!f.done;)e=f.next(),a.core.cities.getCity(0).clearTile(e);c.dispose(),a.hiliteMan.disable(b),r.off(c,w.events.change,d),a.ui.gameScreen().showWorld(),a.ui.gameScreen().worldScreen().hideHint(),a.camera.cameraScript.lock(!1)},e.onDiscard=function(){c.dispose(),a.hiliteMan.disable(b),r.off(c,w.events.change,d),a.ui.gameScreen().showWorld(),a.ui.gameScreen().worldScreen().hideHint(),a.camera.cameraScript.lock(!1)}},l.prototype.build=function(a){var b=this.root;b.ui.gameScreen().worldScreen().showHint("Pick a tile!"),b.camera.cameraScript.lock(!0);var c=[],d=new w(this.root),e=r.on(d,w.events.change,function(a,e,f){b.hiliteMan.disable(c),c=b.hiliteMan.hilite({tile0:d.tile0(),tile1:d.tile1(),fillColor:"rgba(0,0,127,0.4)",borderColor:"rgba(0,0,255,0.4)",borderWidth:2})}),f=b.ui.gameScreen().showActionControls(),g=!0;f.onRotate=function(){g=!g},f.onSubmit=function(){var f,h=d.selectedTiles();if(null!==h)for(;!h.done;)f=h.next(),b.core.cities.getCity(0).buildingService.buildBuilding(a,f,g);d.dispose(),b.hiliteMan.disable(c),r.off(d,w.events.change,e),b.ui.gameScreen().showWorld(),b.ui.gameScreen().worldScreen().hideHint(),b.camera.cameraScript.lock(!1)},f.onDiscard=function(){d.dispose(),b.hiliteMan.disable(c),r.off(d,w.events.change,e),b.ui.gameScreen().showWorld(),b.ui.gameScreen().worldScreen().hideHint(),b.camera.cameraScript.lock(!1)}},l}),define("client/components/tilehilitescript",["require","../config","engine/main"],function(a){function b(){d.Component.call(this)}var c=a("../config"),d=a("engine/main");return b.prototype=Object.create(d.Component.prototype),b.prototype.setHiliteData=function(a){var b=this.gameObject.renderer,d=this.gameObject.transform;b.x=a.x,b.y=a.y,b.fillColor=a.fillColor,b.borderColor=a.borderColor,void 0!==a.borderWidth&&(b.borderWidth=a.borderWidth);var e=vkaria.terrain.getTile(b.x,b.y),f=e.transform.getPosition();d.setPosition(f[0],f[1],f[2]);var g=vkaria.core.world.terrain.getTerrainType(b.x,b.y),h=vkaria.core.world.terrain,i=[h.getGridPointHeight(b.x,b.y),h.getGridPointHeight(b.x+1,b.y),h.getGridPointHeight(b.x,b.y+1),h.getGridPointHeight(b.x+1,b.y+1)],j=c.tileZStep;0===g?(b.points[0][1]=0,b.points[1][1]=0,b.points[2][1]=0,b.points[3][1]=0):(b.points[0][1]=(i[0]-i[2])*j,b.points[1][1]=(i[2]-i[2])*j,b.points[2][1]=(i[3]-i[2])*j,b.points[3][1]=(i[1]-i[2])*j)},b}),define("client/components/tilehiliterenderer",["require","engine/main","../config","../vendor/gl-matrix"],function(a){function b(){c.Renderer.call(this);var a=d.tileSize,b=new Float32Array([-a/2,0,-a/2]),e=new Float32Array([-a/2,0,a/2]),f=new Float32Array([a/2,0,a/2]),g=new Float32Array([a/2,0,-a/2]);this.points=[b,e,f,g]}var c=a("engine/main"),d=a("../config"),e=a("../vendor/gl-matrix"),f=new Float32Array(3),g=new Float32Array(16);return b.prototype=Object.create(c.Renderer.prototype),b.prototype.fillColor="rgba(0,255,0,0.5)",b.prototype.borderColor="rgba(0,0,0,0.5)",b.prototype.borderWidth=1,b.prototype.points=null,b.prototype.render=function(a,b){var c=e.vec3,d=e.mat4.mul(g,b.M,this.gameObject.transform.getLocalToWorld()),h=this.points;a.beginPath(),c.transformMat4(f,h[0],d),a.moveTo(f[0],f[1]),c.transformMat4(f,h[1],d),a.lineTo(f[0],f[1]),c.transformMat4(f,h[2],d),a.lineTo(f[0],f[1]),c.transformMat4(f,h[3],d),a.lineTo(f[0],f[1]),a.closePath(),a.save(),void 0!==this.borderColor&&(a.strokeStyle=this.borderColor,a.lineWidth=this.borderWidth,a.stroke()),void 0!==this.fillColor&&(a.fillStyle=this.fillColor,a.fill()),a.restore()},b}),define("client/hiliteman",["require","engine/main","./components/tilehilitescript","./components/tilehiliterenderer","client/renderlayer","core/main"],function(a){function b(a){var b=new e.GameObject("hilite"),c=new g;return c.layer=h.overlayLayer,b.addComponent(c),c=new f,b.addComponent(c),a.root.game.logic.world.addGameObject(b),c}function c(a){this.hiliters=[],this.root=a}function d(a,b){var c=b.tile;delete b.tile,b.x=j.extractX(c),b.y=j.extractY(c),a._hiliteOne(b)}var e=a("engine/main"),f=a("./components/tilehilitescript"),g=a("./components/tilehiliterenderer"),h=a("client/renderlayer"),i=a("core/main"),j=i.Terrain;return c.prototype._hiliteOne=function(a){var c=b(this);return c.setHiliteData(a),this.hiliters.push(c)-1},c.prototype._hiliteArea=function(a){var b=a.x,c=a.y,d=b+a.w-1,e=c+a.h-1,f=a.fillColor,g=a.borderColor,h=a.borderWidth;b=Math.min(b,d),c=Math.min(c,e),d=b+Math.abs(a.w-1),e=c+Math.abs(a.h-1);for(var i=[],j=b;j<=d;j++)for(var k=c;k<=e;k++)i.push({x:j,y:k,fillColor:f,borderColor:g,borderWidth:h});return this._hiliteMany(i)},c.prototype._hiliteArea2=function(a){if(-1===a.tile0||-1===a.tile1)return[];for(var b=new i.TileIterator(a.tile0,a.tile1),c=a.fillColor,d=a.borderColor,e=a.borderWidth,f=[];!b.done;){var g=b.next();f.push({x:j.extractX(g),y:j.extractY(g),fillColor:c,borderColor:d,borderWidth:e})}return this._hiliteMany(f)},c.prototype._hiliteMany=function(a){var b,c=0,d=a.length,e=[];for(c=0;c<d;c++)b=a[c],e.push(this._hiliteOne(b));return e},c.prototype.hilite=function(a){return Array.isArray(a)?this._hiliteMany(a):void 0!==a.w&&void 0!==a.h?this._hiliteArea(a):void 0!==a.tile0&&void 0!==a.tile1?this._hiliteArea2(a):void 0!==a.tile?d(this,a):this._hiliteOne(a)},c.prototype.disable=function(a){if(void 0!==a){if(Array.isArray(a))for(var b=0;b<a.length;b++)this.disable(a[b]);else if(a>=0&&null!==this.hiliters[a]){var c=this.hiliters[a];this.hiliters[a]=null,c.gameObject.destroy()}}else for(var b=0;b<this.hiliters.length;b++)this.disable(b)},c}),define("vendor/binaryheap",[],function(){function a(a){this.content=[],this.scoreFunction=a}return a.prototype={push:function(a){this.content.push(a),this.sinkDown(this.content.length-1)},pop:function(){var a=this.content[0],b=this.content.pop();return this.content.length>0&&(this.content[0]=b,this.bubbleUp(0)),a},remove:function(a){var b=this.content.indexOf(a),c=this.content.pop();b!==this.content.length-1&&(this.content[b]=c,this.scoreFunction(c)<this.scoreFunction(a)?this.sinkDown(b):this.bubbleUp(b))},contains:function(a){return!(-1===this.content.indexOf(a))},size:function(){return this.content.length},rescoreElement:function(a){this.sinkDown(this.content.indexOf(a))},sinkDown:function(a){for(var b=this.content[a];a>0;){var c=(a+1>>1)-1,d=this.content[c];if(!(this.scoreFunction(b)<this.scoreFunction(d)))break;this.content[c]=b,this.content[a]=d,a=c}},bubbleUp:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=a+1<<1,f=e-1,g=null;if(f<b){var h=this.content[f],i=this.scoreFunction(h);i<d&&(g=f)}if(e<b){var j=this.content[e];this.scoreFunction(j)<(null===g?d:i)&&(g=e)}if(null===g)break;this.content[a]=this.content[g],this.content[g]=c,a=g}}},a}),define("client/pathfinding/pathfinder",["require","binaryheap"],function(a){function b(){}var c=a("binaryheap");return b.manhattan=function(a,b,c,d){return Math.abs(c-a)+Math.abs(d-b)},b.reconstructPath=function(a,c){if(a[c.nodeId]){var d=b.reconstructPath(a,a[c.nodeId]);return d.push(c),d}return[c]},b.search=function(a,d,e){var f=[],g=[],h=[],i=[],j=[],k=new c(function(a){return i[a.nodeId]});k.push(a),j[a.nodeId]=!0,h[a.nodeId]=0,i[a.nodeId]=e(a,d,this);for(var l,m,n,o,p,q,r,s;k.size()>0;){if((m=k.pop())===d)return b.reconstructPath(f,m);for(g[m.nodeId]=!0,n=h[m.nodeId],o=m.connectedNodes,p=o.length,l=0;l<p;l++)q=o[l],!0!==g[q.nodeId]&&(r=n+q.cost,(!(s=j[q.nodeId])||r<h[q.nodeId])&&(f[q.nodeId]=m,h[q.nodeId]=r,i[q.nodeId]=r+e(q,d,this),s?k.rescoreElement(q):(k.push(q),j[q.nodeId]=!0)))}return[]},b}),function(){var a=this,b=a._,c={},d=Array.prototype,e=Object.prototype,f=Function.prototype,g=d.push,h=d.slice,i=d.concat,j=e.toString,k=e.hasOwnProperty,l=d.forEach,m=d.map,n=d.reduce,o=d.reduceRight,p=d.filter,q=d.every,r=d.some,s=d.indexOf,t=d.lastIndexOf,u=Array.isArray,v=Object.keys,w=f.bind,x=function(a){return a instanceof x?a:this instanceof x?void(this._wrapped=a):new x(a)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=x),exports._=x):a._=x,x.VERSION="1.6.0";var y=x.each=x.forEach=function(a,b,d){if(null==a)return a;if(l&&a.forEach===l)a.forEach(b,d);else if(a.length===+a.length){for(var e=0,f=a.length;e<f;e++)if(b.call(d,a[e],e,a)===c)return}else for(var g=x.keys(a),e=0,f=g.length;e<f;e++)if(b.call(d,a[g[e]],g[e],a)===c)return;return a};x.map=x.collect=function(a,b,c){var d=[];return null==a?d:m&&a.map===m?a.map(b,c):(y(a,function(a,e,f){d.push(b.call(c,a,e,f))}),d)};var z="Reduce of empty array with no initial value";x.reduce=x.foldl=x.inject=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),n&&a.reduce===n)return d&&(b=x.bind(b,d)),e?a.reduce(b,c):a.reduce(b);if(y(a,function(a,f,g){e?c=b.call(d,c,a,f,g):(c=a,e=!0)}),!e)throw new TypeError(z);return c},x.reduceRight=x.foldr=function(a,b,c,d){var e=arguments.length>2;if(null==a&&(a=[]),o&&a.reduceRight===o)return d&&(b=x.bind(b,d)),e?a.reduceRight(b,c):a.reduceRight(b);var f=a.length;if(f!==+f){var g=x.keys(a);f=g.length}if(y(a,function(h,i,j){i=g?g[--f]:--f,e?c=b.call(d,c,a[i],i,j):(c=a[i],e=!0)}),!e)throw new TypeError(z);return c},x.find=x.detect=function(a,b,c){var d;return A(a,function(a,e,f){if(b.call(c,a,e,f))return d=a,!0}),d},x.filter=x.select=function(a,b,c){var d=[];return null==a?d:p&&a.filter===p?a.filter(b,c):(y(a,function(a,e,f){b.call(c,a,e,f)&&d.push(a)}),d)},x.reject=function(a,b,c){return x.filter(a,function(a,d,e){return!b.call(c,a,d,e)},c)},x.every=x.all=function(a,b,d){b||(b=x.identity);var e=!0;return null==a?e:q&&a.every===q?a.every(b,d):(y(a,function(a,f,g){if(!(e=e&&b.call(d,a,f,g)))return c}),!!e)};var A=x.some=x.any=function(a,b,d){b||(b=x.identity);var e=!1;return null==a?e:r&&a.some===r?a.some(b,d):(y(a,function(a,f,g){if(e||(e=b.call(d,a,f,g)))return c}),!!e)};x.contains=x.include=function(a,b){return null!=a&&(s&&a.indexOf===s?-1!=a.indexOf(b):A(a,function(a){return a===b}))},x.invoke=function(a,b){var c=h.call(arguments,2),d=x.isFunction(b);return x.map(a,function(a){return(d?b:a[b]).apply(a,c)})},x.pluck=function(a,b){return x.map(a,x.property(b))},x.where=function(a,b){return x.filter(a,x.matches(b))},x.findWhere=function(a,b){return x.find(a,x.matches(b))},x.max=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.max.apply(Math,a);var d=-1/0,e=-1/0;return y(a,function(a,f,g){var h=b?b.call(c,a,f,g):a;h>e&&(d=a,e=h)}),d},x.min=function(a,b,c){if(!b&&x.isArray(a)&&a[0]===+a[0]&&a.length<65535)return Math.min.apply(Math,a);var d=1/0,e=1/0;return y(a,function(a,f,g){var h=b?b.call(c,a,f,g):a;h<e&&(d=a,e=h)}),d},x.shuffle=function(a){var b,c=0,d=[];return y(a,function(a){b=x.random(c++),d[c-1]=d[b],d[b]=a}),d},x.sample=function(a,b,c){return null==b||c?(a.length!==+a.length&&(a=x.values(a)),a[x.random(a.length-1)]):x.shuffle(a).slice(0,Math.max(0,b))};var B=function(a){return null==a?x.identity:x.isFunction(a)?a:x.property(a)};x.sortBy=function(a,b,c){return b=B(b),x.pluck(x.map(a,function(a,d,e){return{value:a,index:d,criteria:b.call(c,a,d,e)}}).sort(function(a,b){var c=a.criteria,d=b.criteria;if(c!==d){if(c>d||void 0===c)return 1;if(c<d||void 0===d)return-1}return a.index-b.index}),"value")};var C=function(a){return function(b,c,d){var e={};return c=B(c),y(b,function(f,g){var h=c.call(d,f,g,b);a(e,h,f)}),e}};x.groupBy=C(function(a,b,c){x.has(a,b)?a[b].push(c):a[b]=[c]}),x.indexBy=C(function(a,b,c){a[b]=c}),x.countBy=C(function(a,b){x.has(a,b)?a[b]++:a[b]=1}),x.sortedIndex=function(a,b,c,d){c=B(c);for(var e=c.call(d,b),f=0,g=a.length;f<g;){var h=f+g>>>1;c.call(d,a[h])<e?f=h+1:g=h}return f},x.toArray=function(a){return a?x.isArray(a)?h.call(a):a.length===+a.length?x.map(a,x.identity):x.values(a):[]},x.size=function(a){return null==a?0:a.length===+a.length?a.length:x.keys(a).length},x.first=x.head=x.take=function(a,b,c){if(null!=a)return null==b||c?a[0]:b<0?[]:h.call(a,0,b)},x.initial=function(a,b,c){return h.call(a,0,a.length-(null==b||c?1:b))},x.last=function(a,b,c){if(null!=a)return null==b||c?a[a.length-1]:h.call(a,Math.max(a.length-b,0))},x.rest=x.tail=x.drop=function(a,b,c){return h.call(a,null==b||c?1:b)},x.compact=function(a){return x.filter(a,x.identity)};var D=function(a,b,c){return b&&x.every(a,x.isArray)?i.apply(c,a):(y(a,function(a){x.isArray(a)||x.isArguments(a)?b?g.apply(c,a):D(a,b,c):c.push(a)}),c)};x.flatten=function(a,b){return D(a,b,[])},x.without=function(a){return x.difference(a,h.call(arguments,1))},x.partition=function(a,b){var c=[],d=[];return y(a,function(a){(b(a)?c:d).push(a)}),[c,d]},x.uniq=x.unique=function(a,b,c,d){x.isFunction(b)&&(d=c,c=b,b=!1);var e=c?x.map(a,c,d):a,f=[],g=[];return y(e,function(c,d){(b?d&&g[g.length-1]===c:x.contains(g,c))||(g.push(c),f.push(a[d]))}),f},x.union=function(){return x.uniq(x.flatten(arguments,!0))},x.intersection=function(a){var b=h.call(arguments,1);return x.filter(x.uniq(a),function(a){return x.every(b,function(b){return x.contains(b,a)})})},x.difference=function(a){var b=i.apply(d,h.call(arguments,1));return x.filter(a,function(a){return!x.contains(b,a)})},x.zip=function(){for(var a=x.max(x.pluck(arguments,"length").concat(0)),b=new Array(a),c=0;c<a;c++)b[c]=x.pluck(arguments,""+c);return b},x.object=function(a,b){if(null==a)return{};for(var c={},d=0,e=a.length;d<e;d++)b?c[a[d]]=b[d]:c[a[d][0]]=a[d][1];return c},x.indexOf=function(a,b,c){if(null==a)return-1;var d=0,e=a.length;if(c){if("number"!=typeof c)return d=x.sortedIndex(a,b),a[d]===b?d:-1;d=c<0?Math.max(0,e+c):c}if(s&&a.indexOf===s)return a.indexOf(b,c);for(;d<e;d++)if(a[d]===b)return d;return-1},x.lastIndexOf=function(a,b,c){if(null==a)return-1;var d=null!=c;if(t&&a.lastIndexOf===t)return d?a.lastIndexOf(b,c):a.lastIndexOf(b);for(var e=d?c:a.length;e--;)if(a[e]===b)return e;return-1},x.range=function(a,b,c){arguments.length<=1&&(b=a||0,a=0),c=arguments[2]||1;for(var d=Math.max(Math.ceil((b-a)/c),0),e=0,f=new Array(d);e<d;)f[e++]=a,a+=c;return f};var E=function(){};x.bind=function(a,b){var c,d;if(w&&a.bind===w)return w.apply(a,h.call(arguments,1));if(!x.isFunction(a))throw new TypeError;return c=h.call(arguments,2),d=function(){if(!(this instanceof d))return a.apply(b,c.concat(h.call(arguments)));E.prototype=a.prototype;var e=new E;E.prototype=null;var f=a.apply(e,c.concat(h.call(arguments)));return Object(f)===f?f:e}},x.partial=function(a){var b=h.call(arguments,1);return function(){for(var c=0,d=b.slice(),e=0,f=d.length;e<f;e++)d[e]===x&&(d[e]=arguments[c++]);for(;c<arguments.length;)d.push(arguments[c++]);return a.apply(this,d)}},x.bindAll=function(a){var b=h.call(arguments,1);if(0===b.length)throw new Error("bindAll must be passed function names");return y(b,function(b){a[b]=x.bind(a[b],a)}),a},x.memoize=function(a,b){var c={};return b||(b=x.identity),function(){var d=b.apply(this,arguments);return x.has(c,d)?c[d]:c[d]=a.apply(this,arguments)}},x.delay=function(a,b){var c=h.call(arguments,2);return setTimeout(function(){return a.apply(null,c)},b)},x.defer=function(a){return x.delay.apply(x,[a,1].concat(h.call(arguments,1)))},x.throttle=function(a,b,c){var d,e,f,g=null,h=0;c||(c={});var i=function(){h=!1===c.leading?0:x.now(),g=null,f=a.apply(d,e),d=e=null};return function(){var j=x.now();h||!1!==c.leading||(h=j);var k=b-(j-h);return d=this,e=arguments,k<=0?(clearTimeout(g),g=null,h=j,f=a.apply(d,e),d=e=null):g||!1===c.trailing||(g=setTimeout(i,k)),f}},x.debounce=function(a,b,c){var d,e,f,g,h,i=function(){var j=x.now()-g;j<b?d=setTimeout(i,b-j):(d=null,c||(h=a.apply(f,e),f=e=null))};return function(){f=this,e=arguments,g=x.now();var j=c&&!d;return d||(d=setTimeout(i,b)),j&&(h=a.apply(f,e),f=e=null),h}},x.once=function(a){var b,c=!1;return function(){return c?b:(c=!0,b=a.apply(this,arguments),a=null,b)}},x.wrap=function(a,b){return x.partial(b,a)},x.compose=function(){var a=arguments;return function(){for(var b=arguments,c=a.length-1;c>=0;c--)b=[a[c].apply(this,b)];return b[0]}},x.after=function(a,b){return function(){if(--a<1)return b.apply(this,arguments)}},x.keys=function(a){if(!x.isObject(a))return[];if(v)return v(a);var b=[];for(var c in a)x.has(a,c)&&b.push(c);return b},x.values=function(a){for(var b=x.keys(a),c=b.length,d=new Array(c),e=0;e<c;e++)d[e]=a[b[e]];return d},x.pairs=function(a){for(var b=x.keys(a),c=b.length,d=new Array(c),e=0;e<c;e++)d[e]=[b[e],a[b[e]]];return d},x.invert=function(a){for(var b={},c=x.keys(a),d=0,e=c.length;d<e;d++)b[a[c[d]]]=c[d];return b},x.functions=x.methods=function(a){var b=[];for(var c in a)x.isFunction(a[c])&&b.push(c);return b.sort()},x.extend=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)a[c]=b[c]}),a},x.pick=function(a){var b={},c=i.apply(d,h.call(arguments,1));return y(c,function(c){c in a&&(b[c]=a[c])}),b},x.omit=function(a){var b={},c=i.apply(d,h.call(arguments,1));for(var e in a)x.contains(c,e)||(b[e]=a[e]);return b},x.defaults=function(a){return y(h.call(arguments,1),function(b){if(b)for(var c in b)void 0===a[c]&&(a[c]=b[c])}),a},x.clone=function(a){return x.isObject(a)?x.isArray(a)?a.slice():x.extend({},a):a},x.tap=function(a,b){return b(a),a};var F=function(a,b,c,d){if(a===b)return 0!==a||1/a==1/b;if(null==a||null==b)return a===b;a instanceof x&&(a=a._wrapped),b instanceof x&&(b=b._wrapped);var e=j.call(a);if(e!=j.call(b))return!1;switch(e){case"[object String]":return a==String(b);case"[object Number]":return a!=+a?b!=+b:0==a?1/a==1/b:a==+b;case"[object Date]":case"[object Boolean]":return+a==+b;case"[object RegExp]":return a.source==b.source&&a.global==b.global&&a.multiline==b.multiline&&a.ignoreCase==b.ignoreCase}if("object"!=typeof a||"object"!=typeof b)return!1;for(var f=c.length;f--;)if(c[f]==a)return d[f]==b;var g=a.constructor,h=b.constructor;if(g!==h&&!(x.isFunction(g)&&g instanceof g&&x.isFunction(h)&&h instanceof h)&&"constructor"in a&&"constructor"in b)return!1;c.push(a),d.push(b);var i=0,k=!0;if("[object Array]"==e){if(i=a.length,k=i==b.length)for(;i--&&(k=F(a[i],b[i],c,d)););}else{for(var l in a)if(x.has(a,l)&&(i++,!(k=x.has(b,l)&&F(a[l],b[l],c,d))))break
;if(k){for(l in b)if(x.has(b,l)&&!i--)break;k=!i}}return c.pop(),d.pop(),k};x.isEqual=function(a,b){return F(a,b,[],[])},x.isEmpty=function(a){if(null==a)return!0;if(x.isArray(a)||x.isString(a))return 0===a.length;for(var b in a)if(x.has(a,b))return!1;return!0},x.isElement=function(a){return!(!a||1!==a.nodeType)},x.isArray=u||function(a){return"[object Array]"==j.call(a)},x.isObject=function(a){return a===Object(a)},y(["Arguments","Function","String","Number","Date","RegExp"],function(a){x["is"+a]=function(b){return j.call(b)=="[object "+a+"]"}}),x.isArguments(arguments)||(x.isArguments=function(a){return!(!a||!x.has(a,"callee"))}),"function"!=typeof/./&&(x.isFunction=function(a){return"function"==typeof a}),x.isFinite=function(a){return isFinite(a)&&!isNaN(parseFloat(a))},x.isNaN=function(a){return x.isNumber(a)&&a!=+a},x.isBoolean=function(a){return!0===a||!1===a||"[object Boolean]"==j.call(a)},x.isNull=function(a){return null===a},x.isUndefined=function(a){return void 0===a},x.has=function(a,b){return k.call(a,b)},x.noConflict=function(){return a._=b,this},x.identity=function(a){return a},x.constant=function(a){return function(){return a}},x.property=function(a){return function(b){return b[a]}},x.matches=function(a){return function(b){if(b===a)return!0;for(var c in a)if(a[c]!==b[c])return!1;return!0}},x.times=function(a,b,c){for(var d=Array(Math.max(0,a)),e=0;e<a;e++)d[e]=b.call(c,e);return d},x.random=function(a,b){return null==b&&(b=a,a=0),a+Math.floor(Math.random()*(b-a+1))},x.now=Date.now||function(){return(new Date).getTime()};var G={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;"}};G.unescape=x.invert(G.escape);var H={escape:new RegExp("["+x.keys(G.escape).join("")+"]","g"),unescape:new RegExp("("+x.keys(G.unescape).join("|")+")","g")};x.each(["escape","unescape"],function(a){x[a]=function(b){return null==b?"":(""+b).replace(H[a],function(b){return G[a][b]})}}),x.result=function(a,b){if(null!=a){var c=a[b];return x.isFunction(c)?c.call(a):c}},x.mixin=function(a){y(x.functions(a),function(b){var c=x[b]=a[b];x.prototype[b]=function(){var a=[this._wrapped];return g.apply(a,arguments),M.call(this,c.apply(x,a))}})};var I=0;x.uniqueId=function(a){var b=++I+"";return a?a+b:b},x.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var J=/(.)^/,K={"'":"'","\\":"\\","\r":"r","\n":"n","\t":"t","\u2028":"u2028","\u2029":"u2029"},L=/\\|'|\r|\n|\t|\u2028|\u2029/g;x.template=function(a,b,c){var d;c=x.defaults({},c,x.templateSettings);var e=new RegExp([(c.escape||J).source,(c.interpolate||J).source,(c.evaluate||J).source].join("|")+"|$","g"),f=0,g="__p+='";a.replace(e,function(b,c,d,e,h){return g+=a.slice(f,h).replace(L,function(a){return"\\"+K[a]}),c&&(g+="'+\n((__t=("+c+"))==null?'':_.escape(__t))+\n'"),d&&(g+="'+\n((__t=("+d+"))==null?'':__t)+\n'"),e&&(g+="';\n"+e+"\n__p+='"),f=h+b.length,b}),g+="';\n",c.variable||(g="with(obj||{}){\n"+g+"}\n"),g="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+g+"return __p;\n";try{d=new Function(c.variable||"obj","_",g)}catch(a){throw a.source=g,a}if(b)return d(b,x);var h=function(a){return d.call(this,a,x)};return h.source="function("+(c.variable||"obj")+"){\n"+g+"}",h},x.chain=function(a){return x(a).chain()};var M=function(a){return this._chain?x(a).chain():a};x.mixin(x),y(["pop","push","reverse","shift","sort","splice","unshift"],function(a){var b=d[a];x.prototype[a]=function(){var c=this._wrapped;return b.apply(c,arguments),"shift"!=a&&"splice"!=a||0!==c.length||delete c[0],M.call(this,c)}}),y(["concat","join","slice"],function(a){var b=d[a];x.prototype[a]=function(){return M.call(this,b.apply(this._wrapped,arguments))}}),x.extend(x.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}}),"function"==typeof define&&define.amd&&define("underscore",[],function(){return x})}.call(this),define("bower_components/underscore/underscore",function(a){return function(){var b;return b||a._}}(this)),define("client/pathfinding/pathman",["require","./pathfinder","underscore","data/classcode"],function(a){function b(){this.nodes=[],this.lastNodeId=0}var c=a("./pathfinder"),d=(a("underscore"),a("data/classcode"));return b.prototype.start=function(){var a=this;vkaria.buildman.addEventListener(vkaria.buildman.events.buildingAdded,function(b,c){c.staticData.classCode!==d.tree&&a.addNode(c.node)}),vkaria.buildman.addEventListener(vkaria.buildman.events.buildingRemoved,function(b,c){c.staticData.classCode!==d.tree&&a.removeNode(c.node)})},b.prototype.addNode=function(a){this.nodes.push(a),a.addTo(this)},b.prototype.removeNode=function(a){a.remove(),this.nodes.splice(this.nodes.indexOf(a),1)},b.prototype.findNodes=function(a,b){return c.search(a,b,function(a,b){var d=a.building,e=b.building;return c.manhattan(d.x,d.y,e.x,e.y)})},b.prototype.refinePath=function(a){for(var b,c,d,e=[],f=0;f<a.length;f++)if(b=a[f],c=a[f+1],d=a[f+2],c&&d)for(var g=c.getPath(b,d),h=0;h<g.length;h++)e.push(g[h]);else if(c)for(var g=c.getPath(b),h=0;h<g.length;h++)e.push(g[h]);return e},b.prototype.findWaypoints=function(a,b){var c=Math.round(a[0]/vkaria.config.tileSize),d=Math.round(a[2]/vkaria.config.tileSize),e=Math.round(b[0]/vkaria.config.tileSize),f=Math.round(b[2]/vkaria.config.tileSize),g=vkaria.tilesman.getTile(c,d).tileScript,h=vkaria.tilesman.getTile(e,f).tileScript;console.time("pathfind1");var i=this.findNodes(g.node,h.node);console.timeEnd("pathfind1"),console.time("pathfind2");var j=this.refinePath(i);return console.timeEnd("pathfind2"),j},b.prototype.findPath=function(){var a=this.nodes[_.random(this.nodes.length)],b=this.nodes[_.random(this.nodes.length)],c=null;if(a&&b&&(c=this.findNodes(a,b)),c)var c=this.refinePath(c);return c},b}),define("client/terrain",["require","core/main","./gameObjects/tile","./config","events"],function(a){function b(a){return a.pool.length>0?a.pool.pop():new f}function c(a){this.tiles=[],this.gos=[],this.pool=[],this.root=a}function d(a,b,c){var d=vkaria.core.world.terrain;if(d.getTerrainType(b,c)===g.water)return 2222;var e=d.getGridPointHeight(b,c+1);return 2e3+100*(d.getGridPointHeight(b+1,c+1)-e+2)+10*(d.getGridPointHeight(b+1,c)-e+2)+(d.getGridPointHeight(b,c)-e+2)}var e=a("core/main"),f=a("./gameObjects/tile"),g=e.TerrainType,h=a("./config"),i=e.TileIterator,j=(a("events"),e.Terrain),k={2222:"grass/2222.png",2111:"grass/2111.png",2223:"grass/2223.png",2112:"grass/2112.png",2232:"grass/2232.png",2121:"grass/2121.png",2233:"grass/2233.png",2122:"grass/2122.png",2322:"grass/2322.png",2211:"grass/2211.png",2323:"grass/2323.png",2212:"grass/2212.png",2332:"grass/2332.png",2221:"grass/2221.png",2333:"grass/2333.png",2321:"grass/2321.png",2123:"grass/2123.png",2101:"grass/2101.png",2343:"grass/2343.png"},l={2222:"shore/2222.png",2111:"shore/2111.png",2223:"shore/2223.png",2112:"shore/2112.png",2232:"shore/2232.png",2121:"shore/2121.png",2233:"shore/2233.png",2122:"shore/2122.png",2322:"shore/2322.png",2211:"shore/2211.png",2323:"shore/2323.png",2212:"shore/2212.png",2332:"shore/2332.png",2221:"shore/2221.png",2333:"shore/2333.png",2321:"shore/2321.png",2123:"shore/2123.png",2101:"shore/2101.png",2343:"shore/2343.png"},m={2222:"water/2222.png"},n={};c.events=n,c.prototype.init=function(){},c.prototype.clear=function(a,b,c,d){for(var e,f,g=j.convertToIndex(a,b),h=j.convertToIndex(a+c-1,b+d-1),k=new i(g,h),l=this.tiles,m=this.pool,n=this.gos,o=vkaria.game.logic.world;;){if(-1===(f=k.next()))break;e=this.tiles[f],e&&(o.removeGameObject(e),m.push(e),delete l[f],delete n[e.instanceId])}};var o=function(a,c){for(var e=0;e++<128;){var f=a.next();if(-1===f)return-1;var i=vkaria.core.world.terrain,j=65535&f,n=f>>>16;if(!c.tiles[f]){var o=b(c),p=vkaria.core.world.terrain,q=[p.getGridPointHeight(j,n),p.getGridPointHeight(j+1,n),p.getGridPointHeight(j,n+1),p.getGridPointHeight(j+1,n+1)],r=d(c,j,n),s=i.getTerrainType(j,n),t=null,u=0;s!==g.water&&(u=q[2]),o.transform.setPosition(j*h.tileSize,u*h.tileZStep,n*h.tileSize),t=s===g.grass?vkaria.sprites.getSprite(k[r.toString()]):s===g.shore?vkaria.sprites.getSprite(l[r.toString()]):vkaria.sprites.getSprite(m[2222]),o.renderer.setSprite(t),vkaria.game.logic.world.addGameObject(o),c.tiles[f]=o,c.gos[o.instanceId]=f}}return 0};return c.prototype.draw0=function(a,b,c,d){var e=new i(a,b,c,d);Isometrica.Engine.Coroutine.startCoroutine(o,e,this)},c.prototype.draw=function(a,c,f,n){for(var o,p,q,r,s,t,u,v,w,x=vkaria.core.world.terrain,y=j.convertToIndex(a,c),z=j.convertToIndex(a+f-1,c+n-1),A=new i(y,z),B=this.tiles,C=this.gos;-1!==(o=A.next());)if(p=e.Terrain.extractX(o),q=e.Terrain.extractY(o),!B[o]){s=b(this);var D=vkaria.core.world.terrain,w=[D.getGridPointHeight(p,q),D.getGridPointHeight(p+1,q),D.getGridPointHeight(p,q+1),D.getGridPointHeight(p+1,q+1)];t=d(this,p,q),u=x.getTerrainType(p,q),v=null,r=0,u!==g.water&&(r=w[2]),s.transform.setPosition(p*h.tileSize,r*h.tileZStep,q*h.tileSize),v=u===g.grass?vkaria.sprites.getSprite(k[t]):u===g.shore?vkaria.sprites.getSprite(l[t]):vkaria.sprites.getSprite(m[2222]),s.renderer.setSprite(v),vkaria.game.logic.world.addGameObject(s),B[o]=s,C[s.instanceId]=o}},c.prototype.getTile=function(a,b){var c;c=2===arguments.length?e.Terrain.convertToIndex(a,b):a;var d=this.tiles[c];return void 0!==d&&d||null},c.prototype.getCoordinates=function(a){return this.gos[a.instanceId]||-1},c.prototype.tileXPos=function(a){return j.extractX(a)*h.tileSize},c.prototype.tileZPos=function(a){return j.extractY(a)*h.tileSize},c.prototype.tileYPos=function(a){return this.root.core.terrain.getGridPointHeight(a)*h.tileZStep},c}),define("vendor/object-pool",["require"],function(a){function b(a){this.objs=[],this.ctr=a}function c(a,b,c){c.returnObject(a)}return b.borrowObject=function(a){var b;return a.objs.length>0?b=a.objs.pop():(b=new a.ctr,Events.on(b,"dispose",c,a)),b},b.returnObject=function(a,b){return a.objs.push(b)},b.prototype.borrowObject=function(){return b.borrowObject(this)},b.prototype.returnObject=function(a){return b.returnObject(this,a)},window.ObjectPool=b}),define("client/gameObjects/tree",["require","engine/main","../renderlayer"],function(a){function b(){d.init(this,"tree"),h=new f,h.layer=g,this.addComponent(h)}var c=a("engine/main"),d=c.GameObject,e=a("../renderlayer"),f=c.SpriteRenderer,g=e.buildingsLayer,h=null;return b.prototype=Object.create(d.prototype),b}),define("client/envman",["require","./config","engine/main","events","./terrain","core/main","./chunkman","object-pool","./gameObjects/tree"],function(a){function b(a,b,c){var d=q.borrowObject(a.pool),e=m[c].sprites[0],f=d.renderer;f.setSprite(a.root.sprites.getSprite(e.path)),f.pivotX=e.pivotX,f.pivotY=e.pivotY;var g=o.extractX(b),h=o.extractY(b),i=a.root.core.terrain.getGridPointHeight(g+1,h);d.transform.setPosition(g*j.tileSize,i*j.tileZStep,h*j.tileSize),a.root.game.scene.addGameObject(d),a._trees[b]=d}function c(a,b){var c=a._trees[b];void 0!==c&&(delete a._trees[b],q.returnObject(a.pool,c),a.root.game.scene.removeGameObject(c))}function d(a,c){for(var d,e,f=c.tiles(),g=a.root.core.envService;!f.done;)d=n.next(f),null!==(e=g.getTree(d))&&void 0===a._trees[d]&&b(a,d,e)}function e(a,b){for(var d,e=b.tiles();!e.done;)d=n.next(e),c(a,d)}function f(a,b,c){d(c,b)}function g(a,b,c){e(c,b)}function h(a,b,d){c(d,b)}function i(a){this.root=a,this._trees={},this.pool=new q(r)}var j=a("./config"),k=(a("engine/main"),a("events")),l=(a("./terrain"),a("core/main")),m=l.BuildingData,n=l.TileIterator,o=l.Terrain,p=a("./chunkman"),q=a("object-pool"),r=a("./gameObjects/tree");return i.prototype.init=function(){this.core=this.root.core;var a=this.root.chunkman.getChunks();for(var b in a)d(this,a[b]);k.on(this.root.chunkman,p.events.chunkLoad,f,this),k.on(this.root.chunkman,p.events.chunkUnload,g,this),k.on(this.core.envService,l.EnvService.events.treeRemove,h,this)},i}),define("client/components/cityborderrenderer",["require","engine/main","../vendor/gl-matrix","core/main","../config","../renderlayer","events"],function(a){function b(a){var b,e,f,g,h,i,j,k=a.area.getInfluenceArea(),m=l.convertToIndex(0,1),n={},o=[];for(i=k.length,h=0;h<i;h++)j=parseInt(k[h],10),b=j,e=j+1,f=j+m+1,g=j+m,n[b]=n[b]||{},n[e]=n[e]||{},n[f]=n[f]||{},n[g]=n[g]||{},void 0===n[e][b]?n[b][e]={from:b,to:e,revised:!1}:delete n[e][b],void 0===n[f][e]?n[e][f]={from:e,to:f,revised:!1}:delete n[f][e],void 0===n[g][f]?n[f][g]={from:f,to:g,revised:!1}:delete n[g][f],void 0===n[b][g]?n[g][b]={from:g,to:b,revised:!1}:delete n[b][g];for(h in n)i=n[h],h=parseInt(h,10),b=i[h+1],e=i[h-1],f=i[h+m],g=i[h-m],void 0===b||b.revised||(i=[],o.push(i),c(n,i,b)),void 0===e||e.revised||(i=[],o.push(i),c(n,i,e)),void 0===f||f.revised||(i=[],o.push(i),c(n,i,f)),void 0===g||g.revised||(i=[],o.push(i),c(n,i,g));return d(o),o}function c(a,b,d){var e,f,g,h,i,j,m,n=l.convertToIndex(0,1);i=k.tileSize,j=k.tileZStep,m=d.from,d.revised=!0,e=l.extractX(m),f=isometrica.core.world.terrain.getGridPointHeight(m),g=l.extractY(m),e=e*i-i/2,f*=j,g=g*i-i/2,b.push([e,f,g]),i=null,j=d.to,m=a[j],void 0!==m&&(e=m[j+1],f=m[j-1],g=m[j+n],h=m[j-n],void 0===e||e.revised?void 0===f||f.revised?void 0===g||g.revised?void 0===h||h.revised||(i=h):i=g:i=f:i=e),null!==i&&c(a,b,i)}function d(a){for(var b,c,d,e,f,g,h,j,k,l=a.length,m=[],n=0;n<l;n++){b=a[n],g=[],f=b.length,d=e=void 0;for(var o=0;o<f;o++)c=b[o],e=b[o+1],d=b[o-1],e&&d&&(i.sub(m,d,e),h=m[0],j=m[1],k=m[2],0===h&&0===j&&0!==k||0!==h&&0===j&&0===k||0===h&&0!==j&&0===k)||g.push(c);a[n]=g}}function e(a,c,d){var e=d.city;e&&(d.points=b(e))}function f(a){this.layer=m.groundDrawLayer,this.city=a;var b=a.root.areaService;n.on(b,b.events.areaChange,e,this)}var g=a("engine/main"),h=a("../vendor/gl-matrix"),i=h.vec3,j=a("core/main"),k=a("../config"),l=j.Terrain,m=a("../renderlayer"),n=a("events"),o=new Float32Array(3),p=[4];return f.prototype=Object.create(g.Renderer.prototype),f.prototype.points=null,f.prototype.start=function(){this.points=b(this.city)},f.prototype.cullingTest=function(a,b){for(var c=o,d=this.points,e=0;e<d.length;e++)for(var f=d[e].length,g=0;g<f;g++)if(i.transformMat4(c,d[e][g],b.V),c[0]>-1&&c[0]<1&&c[1]>-1&&c[1]<1)return!0;return!1},f.prototype.render=function(a,b,c,d){var e,f,g=this.points,h=g.length,j=b.M,k=o;a.beginPath();for(var l=0;l<h;l++){e=g[l],f=e.length,i.transformMat4(k,e[0],j),a.moveTo(k[0],k[1]);for(var m=1;m<f;m++)i.transformMat4(k,e[m],j),a.lineTo(k[0],k[1]);a.closePath()}a.lineWidth=3,a.setLineDash(p),a.strokeStyle="rgba(255,255,255,0.4)",a.stroke()},f}),define("client/components/city",["require","engine/main"],function(a){function b(){}var c=a("engine/main");return b.prototype=Object.create(c.Component.prototype),b.prototype.city=null,b}),define("client/gameObjects/citylabel",["require","engine/main","../components/cityborderrenderer","../components/city"],function(a){function b(a){c.GameObject.call(this,"city");var b=this.addComponent(new c.TextRenderer);b.layer=vkaria.layers.overlayLayer,b.text=a.name(),b.style="normal 16px arial";var f=new c.GameObject("border"),g=new d(a);f.addComponent(g),this.transform.addChild(f.transform),f.transform.setLocalPosition(0,0,0);var h=new e;h.city=a,this.addComponent(h)}var c=a("engine/main"),d=a("../components/cityborderrenderer"),e=a("../components/city");return b.prototype=Object.create(c.GameObject.prototype),b}),define("client/tileselector",["require","engine/main","./renderlayer","./components/camerascript","events","reactive-property"],function(a){function b(a){for(var b=a,c=b.length,d=0;d<c;d++)if(b[d].spriteRenderer.layer===h.groundLayer)return b[d];return!1}function c(a,c,d){var e=b(a._cam.pickGameObject(c,d));return e&&a.root.terrain.getCoordinates(e)||-1}function d(a,b,d){var e=b.gameViewportX,f=b.gameViewportY,g=c(d,e,f);d._tile(g)}function e(a,b,c){j.fire(c,l.change)}function f(a,b,c){j.off(c)}function g(a){this.root=a,this._tile=k(-1);var b=this._cam=a.camera.cameraScript,c=j.on(b,i.events.inputClick,d,this),g=this._tile.onChange(e,!1,this);j.once(this,l.dispose,f,c),j.once(this,l.dispose,f,g)}var h=(a("engine/main"),a("./renderlayer")),i=a("./components/camerascript"),j=a("events"),k=a("reactive-property"),l={change:0,dispose:1};return g.events=l,g.prototype._tile=-1,g.prototype.selectedTile=function(){return this._tile()},g.prototype.dispose=function(){j.fire(this,l.dispose)},g}),define("client/cityman",["require","core/main","events","./gameObjects/citylabel","./config","./tileselector","./components/camerascript","./components/city"],function(a){function b(a,b){var c=a._cityGOs,d=b.tile();if(void 0!==c[d])throw"There already is some city GO on tile "+d;var e=new j(b);return a.root.game.scene.addGameObject(e),c[d]=e,c[d]}function c(a,c){var d=b(a,c),e=c.tile(),f=a.root.terrain.tileXPos(e),g=a.root.terrain.tileYPos(e),h=a.root.terrain.tileZPos(e);d.transform.setPosition(f,g,h),d.textRenderer.text=c.name()}function d(a,b,d){c(d,b),i.on(b,h.events.rename,e,d)}function e(a,b,c){c._cityGOs[a.tile()].textRenderer.text=b}function f(a){this.root=a,this._cityGOs={}}var g=a("core/main"),h=g.City,i=a("events"),j=a("./gameObjects/citylabel"),k=(a("./config"),a("./tileselector")),l=a("./components/camerascript"),m=a("./components/city");return f.prototype.init=function(){var a=this.root,b=a.camera.cameraScript;i.on(a.core.cities,g.CityService.events.cityNew,d,this),i.on(b,l.events.inputClick,function(c,d){var e=b.pickGameObject(d.gameViewportX,d.gameViewportY);for(var f in e){var g=e[f];if(g instanceof j){var h=g.getComponent(m),i=h.city,k=i.id();console.log("CITY!!!",k),a.ui.navigate("city/"+k)}}}),this.establish()},f.prototype.locate=function(a){this.root.camera.cameraScript.moveTo(this._cityGOs[a.tile()].go.transform)},f.prototype.establish=function(){var a=this.root;a.ui.gameScreen().worldScreen().showHint("Pick a tile where you want your city to be located!");var b=new k(a),c=-1,d=i.on(b,k.events.change,function(b,d,e){a.hiliteMan.disable(c),c=a.hiliteMan.hilite({tile:b.selectedTile(),borderColor:"rgba(255,255,255,1)",borderWidth:2})}),e=a.ui.gameScreen().showActionControls();e.onSubmit=function(){var e=b.selectedTile();a.ui.gameScreen().showPrompt("Give city a name!",function(b){a.core.cities.establishCity(e,b),a.ui.gameScreen().showWorld(),a.ui.gameScreen().worldScreen().hideHint()},"My City"),a.hiliteMan.disable(c),b.dispose(),i.off(b,k.events.change,d)},e.canDiscard(!1)},f.prototype.getCityGameObject=function(a){var b=this.root.core.cities.getCity(a),c=b.tile();return this._cityGOs[c]},f}),define("client/roadman",["require","events","./buildman","core/main"],function(a){function b(a,b){return a._roads[b]||null}function c(a,b,c){a._roads[b]=c}function d(a,b){delete a._roads[b]}function e(a,c){var d;null!==(d=b(a,c+1))&&d.updateProfile(),null!==(d=b(a,c+m.dy))&&d.updateProfile(),null!==(d=b(a,c-1))&&d.updateProfile(),null!==(d=b(a,c-m.dy))&&d.updateProfile()}function f(a,b,d){var f=b.model();f.data.classCode===l.road&&(c(d,f.tile,b),e(d,f.tile),b.updateProfile())}function g(a,b,c){var e=b.model();e.data.classCode===l.road&&d(c,e.tile)}function h(a){this.root=a,this._roads={}}var i=a("events"),j=a("./buildman"),k=a("core/main"),l=k.BuildingClassCode,m=k.Terrain;return h.prototype.init=function(){i.on(this.root.buildman,j.events.buildingLoad,f,this),i.on(this.root.buildman,j.events.buildingUnload,g,this)},h.prototype.getRoad=function(a){return b(this,a)},h}),define("client/cameracontrol",["require","./components/camerascript","events"],function(a){function b(a,b,c){var d=b.dx,e=b.dy;c._cam.pan(d,e)}function c(a,b,c){f.off(c)}function d(a){this.root=a}var e=a("./components/camerascript"),f=a("events"),g={dispose:0};return d.prototype.init=function(){var a=this.root,d=this._cam=a.camera.cameraScript,h=f.on(d,e.events.inputDrag,b,this);f.once(this,g.dispose,c,h)},d}),define("client/player",[],function(){function a(a){this.root=a}return a.prototype.city=function(){return this.root.core.cities.getCity(0)},a.prototype.name=function(){return"unnamed"},a}),define("client/cameraman",["require","engine/main","./components/camerascript"],function(a){function b(a){this.root=a}var c=a("engine/main"),d=a("./components/camerascript");return b.prototype._main=null,b.prototype.mainCamera=function(){if(null!==this._main)return this._main;var a=new engine.Camera("mainCamera");return a.addComponent(new d),this._main=a,this.root.game.scene.addGameObject(a),a},b.prototype.createCamera=function(){var a=new c.Camera;return a.getComponent(c.TransformComponent).rotate(30,45,0,"self"),this.root.game.scene.addGameObject(a),a},b}),define("client/components/entity",["require","engine/main","../vendor/gl-matrix"],function(a){function b(){c.Component.call(this)}var c=a("engine/main"),d=a("../vendor/gl-matrix");return b.prototype=Object.create(c.Component.prototype),b.prototype.path=null,b.prototype.currentTarget=null,b.prototype.setPath=function(a){this.path=a,this.currentTarget=0},b.prototype.tick=function(){if(this.path){var a=this.path[this.currentTarget],b=this.gameObject.transform.getPosition(),c=d.vec3.subtract([],a,b),e=c[0],f=c[2];e>0?this.gameObject.spriteRenderer.setSprite(vkaria.sprites.getSprite("trolley0.png")):e<0?this.gameObject.spriteRenderer.setSprite(vkaria.sprites.getSprite("trolley2.png")):f>0?this.gameObject.spriteRenderer.setSprite(vkaria.sprites.getSprite("trolley3.png")):f<0&&this.gameObject.spriteRenderer.setSprite(vkaria.sprites.getSprite("trolley1.png")),d.vec3.sqrLen(c)>1?(d.vec3.normalize(c,c),d.vec3.scale(c,c,2),this.gameObject.transform.translate(c[0],c[1],c[2],"world")):this.currentTarget<this.path.length-1?this.currentTarget++:this.gameObject.destroy()}},b}),define("client/gameObjects/Trolley",["require","engine/main","../components/entity","../components/smokesource","client/renderlayer"],function(a){function b(){c.GameObject.call(this);var a=this.sprite=new c.SpriteRenderer;a.layer=f.vehiclesLayer,a.setSprite(vkaria.sprites.getSprite("trolley0.png")),a.pivotX=16,a.pivotY=16,this.addComponent(a),this.entity=this.addComponent(new d);var b=new c.GameObject;this.transform.addChild(b.transform),b.transform.setLocalPosition(0,0,0),b.addComponent(new e)}var c=a("engine/main"),d=a("../components/entity"),e=a("../components/smokesource"),f=a("client/renderlayer");return b.prototype=Object.create(c.GameObject.prototype),b}),define("client/vkaria",["require","engine/main","./buildman","./tilesman","./hiliteman","./pathfinding/pathman","./components/camerascript","client/renderlayer","./terrain","./envman","./chunkman","./cityman","./roadman","./cameracontrol","./player","./cameraman","./gameObjects/Trolley"],function(a){function b(a,b,h){window.isometrica=window.vkariaApp=window.vkaria=this,this.core=a,this.ui=b,vkaria.layers=i,c.Config.layersCount=Object.keys(i).length,c.Config.noLayerDepthSortingMask=3,c.Config.noLayerClearMask=0,this.assets=new c.AssetManager,this.sprites=new c.SpriteManager(this.assets),this.game=new c.Game,this.hiliteMan=new f(this),this.buildman=new d(this),this.tilesman=new e(this),this.terrain=new j(this),this.envman=new k(this),this.chunkman=new l(this),this.cityman=new m(this),this.roadman=new n(this),this.pathman=new g,this.cameraControl=new o(this),this.cameraman=new q(this),this.player=new p(this)}var c=a("engine/main"),d=a("./buildman"),e=a("./tilesman"),f=a("./hiliteman"),g=a("./pathfinding/pathman"),h=a("./components/camerascript"),i=a("client/renderlayer"),j=a("./terrain"),k=a("./envman"),l=a("./chunkman"),m=a("./cityman"),n=a("./roadman"),o=a("./cameracontrol"),p=a("./player"),q=a("./cameraman");return b.prototype.prepare=function(a){var b=this;this.assets.getAsset("gfx/spritesheet.json",c.AssetManager.Resource.ResourceTypeEnum.json).done(function(d){d.state===d.constructor.ResourceStateEnum.ready?(b.sprites.frames=d.data.frames,b.assets.getAsset("gfx/spritesheet.png",c.AssetManager.Resource.ResourceTypeEnum.image).done(function(c){b.sprites.atlas=c.data,a&&a()})):a&&a()})},b.prototype.start=function(){this.camera=new c.Camera("mainCamera"),this.camera.addComponent(new h),this.game.scene.addGameObject(this.camera),this.game.run()},b.prototype.startServices=function(){this.pathman.start(),this.buildman.start(),this.tilesman.start(),this.terrain.init(),this.chunkman.init(),this.envman.init(),this.cityman.init(),this.roadman.init(),this.cameraControl.init(),window.t=a("./gameObjects/Trolley");var b=this.pathman;setInterval(function(){var a=b.findPath();if(a&&a.length){var c=new t;vkaria.game.logic.world.addGameObject(c),c.transform.setPosition(a[0][0],a[0][1],a[0][2]),c.entity.setPath(a)}},1e3)},b.prototype.game=null,b}),define("client/main",["require","namespace","./vkaria"],function(a){var b=a("namespace"),c=b("Isometrica.Client");return c.Vkaria=a("./vkaria"),c});